"use strict";(self.webpackChunkRemoteClient=self.webpackChunkRemoteClient||[]).push([[290],{13259:(e,t,r)=>{r.d(t,{H:()=>z,b:()=>D,c:()=>L});var i=r(37585),s=r(48163),n=r(91829),a=r(79258),o=r(49255),l=r(76591),c=r(36782),h=r(47522),d=r(40268),u=r(63578),f=r(13755),p=r(2981),_=r(42398),m=r(63365),g=r(26835),y=r(52587),v=r(20693),x=r(47286),b=r(14314),w=r(81961),T=r(71988),A=r(33094),S=r(20304),R=r(31821),O=r(12791),I=r(63761),M=r(59643),C=r(46540),E=r(14113),F=r(49788);function D(e){const t=new E.N5,r=e.signedDistanceFieldEnabled;t.include(d.Q,e),t.vertex.include(l.rA,e);const{occlusionPass:s,output:D,oitPass:z}=e;if(s)return t.include(u.I,e),t;const{vertex:B,fragment:V}=t;t.include(y.Y6),t.include(_.A,e),t.include(c.g,e),t.include(f.y),V.include(g.W),V.include(m.a),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2");const H=D===o.V.Highlight,j=H&&e.occlusionTestEnabled;j&&t.varyings.add("voccluded","float"),B.uniforms.add(new b.I("viewport",(e=>e.camera.fullViewport)),new x.G("screenOffset",((e,t)=>(0,i.hZ)(N,2*e.screenOffset[0]*t.camera.pixelRatio,2*e.screenOffset[1]*t.camera.pixelRatio))),new x.G("anchorPosition",(e=>L(e))),new T.E("materialColor",(e=>e.color)),new S.m("materialRotation",(e=>e.rotation))),(0,v.Nz)(B),r&&(B.uniforms.add(new T.E("outlineColor",(e=>e.outlineColor))),V.uniforms.add(new T.E("outlineColor",(e=>P(e)?e.outlineColor:n.uY)),new S.m("outlineSize",(e=>P(e)?e.outlineSize:0)))),e.horizonCullingEnabled&&B.uniforms.add(new w.V("pointDistanceSphere",((e,t)=>{const r=t.camera.eye,i=e.origin;return(0,n.fA)(i[0]-r[0],i[1]-r[1],i[2]-r[2],a.$O.radius)}))),e.pixelSnappingEnabled&&B.include(h.K),e.hasScreenSizePerspective&&((0,y.pM)(B),(0,y.OH)(B)),e.debugDrawLabelBorder&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(C.r.UV0,"vec2"),t.attributes.add(C.r.COLOR,"vec4"),t.attributes.add(C.r.SIZE,"vec2"),t.attributes.add(C.r.ROTATION,"float"),t.attributes.add(C.r.FEATUREATTRIBUTE,"vec4"),B.code.add(e.horizonCullingEnabled?R.H`bool behindHorizon(vec3 posModel) {
vec3 camToEarthCenter = pointDistanceSphere.xyz - localOrigin;
vec3 camToPos = pointDistanceSphere.xyz + posModel;
float earthRadius = pointDistanceSphere.w;
float a = dot(camToPos, camToPos);
float b = dot(camToPos, camToEarthCenter);
float c = dot(camToEarthCenter, camToEarthCenter) - earthRadius * earthRadius;
return  b > 0.0 && b < a && b * b  > a * c;
}`:R.H`bool behindHorizon(vec3 posModel) { return false; }`),B.main.add(R.H`
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }

      if (behindHorizon(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }

      vec2 inputSize;
      ${(0,R.If)(e.hasScreenSizePerspective,R.H`
          inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
          vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);`,R.H`
          inputSize = size;
          vec2 screenOffsetScaled = screenOffset;`)}
      ${(0,R.If)(e.vvSize,R.H`inputSize *= vvScale(featureAttribute).xx;`)}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${(0,R.If)(e.occlusionTestEnabled,R.H`
      bool visible = testHUDVisibility(posProj);
      if (!visible) {
        vtc = vec2(0.0);
        ${(0,R.If)(e.debugDrawLabelBorder,"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);")}
        return;
      }`)}
      ${(0,R.If)(j,R.H`voccluded = visible ? 0.0 : 1.0;`)}
    `);const U=R.H`
      vec2 uv01 = floor(uv0);
      vec2 uv = uv0 - uv01;
      quadOffset.xy = (uv01 - anchorPosition) * 2.0 * combinedSize;

      ${(0,R.If)(e.hasRotation,R.H`
          float angle = radians(materialRotation + rotation);
          float cosAngle = cos(angle);
          float sinAngle = sin(angle);
          mat2 rotate = mat2(cosAngle, -sinAngle, sinAngle,  cosAngle);

          quadOffset.xy = rotate * quadOffset.xy;
        `)}

      quadOffset.xy = (quadOffset.xy + screenOffsetScaled) / viewport.zw * posProj.w;
  `,G=e.pixelSnappingEnabled?r?R.H`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:R.H`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:R.H`posProj += quadOffset;`;B.main.add(R.H`
    ${U}
    ${e.vvColor?"vcolor = interpolateVVColor(featureAttribute.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${(0,R.If)(D===o.V.ObjectAndLayerIdColor,R.H`vcolor.a = 1.0;`)}

    bool alphaDiscard = vcolor.a < ${R.H.float(F.Q)};
    ${(0,R.If)(r,`alphaDiscard = alphaDiscard && outlineColor.a < ${R.H.float(F.Q)};`)}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${G}
      gl_Position = posProj;
    }

    vtc = uv;

    ${(0,R.If)(e.debugDrawLabelBorder,R.H`debugBorderCoords = vec4(uv01, 1.5 / combinedSize);`)}
    vsize = inputSize;
  `),V.uniforms.add(new I.N("tex",(e=>e.texture))),e.occludedFragmentFade&&(V.uniforms.add(new O.x("depthMap",(e=>e.mainDepth))),V.uniforms.add(new A.U("occludedOpacity",(e=>e.hudOccludedFragmentOpacity))));const k=e.debugDrawLabelBorder?R.H`(isBorder > 0.0 ? 0.0 : ${R.H.float(F.Q)})`:R.H.float(F.Q),q=R.H`
    ${(0,R.If)(e.debugDrawLabelBorder,R.H`float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`)}

    ${(0,R.If)(e.sampleSignedDistanceFieldTexelCenter,R.H`
      float txSize = float(textureSize(tex, 0).x);
      float texelSize = 1.0 / txSize;

      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;`,R.H`vec2 samplePos = vtc;`)}

    ${r?R.H`
      vec4 fillPixelColor = vcolor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgbaTofloat(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${k} ||
          fillPixelColor.a + outlinePixelColor.a < ${R.H.float(F.Q)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        ${(0,R.If)(!H,R.H`fragColor = vec4(compositeColor, compositeAlpha);`)}
      } else {
        if (fillAlphaFactor < ${k}) {
          discard;
        }

        ${(0,R.If)(!H,R.H`fragColor = premultiplyAlpha(fillPixelColor);`)}
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:R.H`
          vec4 texColor = texture(tex, vtc, -0.5);
          if (texColor.a < ${k}) {
            discard;
          }
          ${(0,R.If)(!H,R.H`fragColor = texColor * premultiplyAlpha(vcolor);`)}
          `}

    ${(0,R.If)(e.occludedFragmentFade&&!H,R.H`
        float zSample = texelFetch(depthMap, ivec2(gl_FragCoord.xy), 0).x;
        if (zSample < gl_FragCoord.z) {
          fragColor *= occludedOpacity;
        }
        `)}

    ${(0,R.If)(!H&&e.debugDrawLabelBorder,R.H`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`)}
  `;switch(D){case o.V.Color:case o.V.ColorEmission:t.outputs.add("fragColor","vec4",0),D===o.V.ColorEmission&&t.outputs.add("fragEmission","vec4",1),z===M.Y.ColorAlpha&&t.outputs.add("fragAlpha","float",D===o.V.ColorEmission?2:1),V.main.add(R.H`
        ${q}
        ${(0,R.If)(z===M.Y.FrontFace,R.H`fragColor.rgb /= fragColor.a;`)}
        ${(0,R.If)(D===o.V.ColorEmission,R.H`fragEmission = vec4(0.0);`)}
        ${(0,R.If)(z===M.Y.ColorAlpha,R.H`fragAlpha = fragColor.a;`)}`);break;case o.V.ObjectAndLayerIdColor:V.main.add(R.H`
        ${q}
        outputObjectAndLayerIdColor();`);break;case o.V.Highlight:t.include(p.Q,e),V.main.add(R.H`
        ${q}
        outputHighlight(${(0,R.If)(j,R.H`voccluded == 1.0`,R.H`false`)});`)}return t}function P(e){return e.outlineColor[3]>0&&e.outlineSize>0}function L(e){return e.textureIsSignedDistanceField?(t=e.anchorPosition,r=e.distanceFieldBoundingBox,s=N,(0,i.hZ)(s,t[0]*(r[2]-r[0])+r[0],t[1]*(r[3]-r[1])+r[1])):(0,i.C)(N,e.anchorPosition),N;var t,r,s}const N=(0,s.vt)(),z=Object.freeze(Object.defineProperty({__proto__:null,build:D,calculateAnchorPosition:L},Symbol.toStringTag,{value:"Module"}))},66344:(e,t,r)=>{r.d(t,{q:()=>l});var i,s,n=r(3694);(s=i||(i={}))[s.ALL=0]="ALL",s[s.SOME=1]="SOME";class a{get size(){return this._size}constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new n.A,this._users=new n.A}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear()}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,t){this._removeFuncs.push([e,t])}deregisterRemoveFunc(e){this._removeFuncs.filterInPlace((t=>t[0]!==e))}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,-1),this._checkSize()}getSize(e,t){const r=this._db.get(e.id+t);return r?.size??0}put(e,t,r,s,n){t=e.id+t;const a=this._db.get(t);if(a&&(this._size-=a.size,e.size-=a.size,this._db.delete(t),a.entry!==r&&this._notifyRemove(t,a.entry,a.size,i.ALL)),s>this._maxSize)return void this._notifyRemove(t,r,s,i.ALL);if(void 0===r)return void console.warn("Refusing to cache undefined entry ");if(!s||s<0)return console.warn(`Refusing to cache entry with size ${s} for key ${t}`),void this._notifyRemove(t,r,0,i.ALL);const l=1+Math.max(n,-4)- -3;this._db.set(t,new o(r,s,l)),this._size+=s,e.size+=s,this._checkSize()}updateSize(e,t,r,s){t=e.id+t;const n=this._db.get(t);if(n&&n.entry===r){for(this._size-=n.size,e.size-=n.size;s>this._maxSize;){const e=this._notifyRemove(t,r,s,i.SOME);if(!(null!=e&&e>0))return void this._db.delete(t);s=e}n.size=s,this._size+=s,e.size+=s,this._checkSize()}}pop(e,t){t=e.id+t;const r=this._db.get(t);if(r)return this._size-=r.size,e.size-=r.size,this._db.delete(t),++this._hit,r.entry;++this._miss}get(e,t){t=e.id+t;const r=this._db.get(t);if(void 0!==r)return this._db.delete(t),r.lives=r.lifetime,this._db.set(t,r),++this._hit,r.entry;++this._miss}peek(e,t){const r=this._db.get(e.id+t);return r?++this._hit:++this._miss,r?.entry}get performanceInfo(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},r=new Array;this._db.forEach(((e,i)=>{const s=e.lifetime;r[s]=(r[s]||0)+e.size,this._users.forAll((r=>{const{id:s,name:n}=r;if(i.startsWith(s)){const r=t[n]||0;t[n]=r+e.size}}))}));const i={};this._users.forAll((e=>{const r=e.name;if("hitRate"in e&&"number"==typeof e.hitRate&&!isNaN(e.hitRate)&&e.hitRate>0){const s=t[r]||0;t[r]=s,i[r]=Math.round(100*e.hitRate)+"%"}else i[r]="0%"}));const s=Object.keys(t);s.sort(((e,r)=>t[r]-t[e])),s.forEach((r=>e[r]=Math.round(t[r]/2**20)+"MB / "+i[r]));for(let t=r.length-1;t>=0;--t){const i=r[t];i&&(e["Priority "+(t+-3-1)]=Math.round(i/this._size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll((e=>e.resetHitRate()))}clear(e){const t=e.id;this._db.forEach(((e,r)=>{r.startsWith(t)&&(this._size-=e.size,this._db.delete(r),this._notifyRemove(r,e.entry,e.size,i.ALL))})),e.size=0}clearAll(){this._db.forEach(((e,t)=>this._notifyRemove(t,e.entry,e.size,i.ALL))),this._users.forAll((e=>e.size=0)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(e,t,r,i){let s;return this._removeFuncs.some((n=>{if(e.startsWith(n[0])){const e=n[1](t,i,r);return"number"==typeof e&&(s=e),!0}return!1})),s}_checkSize(){this._users.forAll((e=>this._checkSizeLimits(e))),this._checkSizeLimits()}_checkSizeLimits(e){const t=e??this;if(t.maxSize<0||t.size<=t.maxSize)return;const r=e?.id;let i=!0;for(;i;){i=!1;for(const[s,n]of this._db)if(0===n.lifetime&&(!r||s.startsWith(r))){if(this._purgeItem(s,n,e),t.size<=.9*t.maxSize)return;i||=this._db.has(s)}}for(const[i,s]of this._db)if((!r||i.startsWith(r))&&(this._purgeItem(i,s,e),t.size<=.9*t.maxSize))return}_purgeItem(e,t,r=this._users.find((t=>e.startsWith(t.id)))){if(this._db.delete(e),t.lives<=1){this._size-=t.size,r&&(r.size-=t.size);const s=this._notifyRemove(e,t.entry,t.size,i.SOME);null!=s&&s>0&&(this._size+=s,r&&(r.size+=s),t.lives=t.lifetime,t.size=s,this._db.set(e,t))}else--t.lives,this._db.set(e,t)}}class o{constructor(e,t,r){this.entry=e,this.size=t,this.lifetime=r,this.lives=r}}class l{constructor(e,t){this._storage=new a,this.id="",this.name="",this.size=0,this._storage.maxSize=e,this._storage.register(this),t&&this._storage.registerRemoveFunc("",t)}destroy(){this._storage.deregister(this),this._storage.destroy()}put(e,t,r=1){this._storage.put(this,e,t,r,1)}pop(e){return this._storage.pop(this,e)}get(e){return this._storage.get(this,e)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(e){this._storage.maxSize=e}resetHitRate(){}}},32587:(e,t,r)=>{r.d(t,{A:()=>n});var i=r(62788),s=r(95488);class n{constructor(e){this._observable=new s.I,this._map=new Map(e)}get size(){return(0,i.gc)(this._observable),this._map.size}clear(){this._map.size>0&&(this._map.clear(),this._observable.notify())}delete(e){const t=this._map.delete(e);return t&&this._observable.notify(),t}entries(){return(0,i.gc)(this._observable),this._map.entries()}forEach(e,t){(0,i.gc)(this._observable),this._map.forEach(((r,i)=>e.call(t,r,i,this)),t)}get(e){return(0,i.gc)(this._observable),this._map.get(e)}has(e){return(0,i.gc)(this._observable),this._map.has(e)}keys(){return(0,i.gc)(this._observable),this._map.keys()}set(e,t){return this._map.set(e,t),this._observable.notify(),this}values(){return(0,i.gc)(this._observable),this._map.values()}[Symbol.iterator](){return(0,i.gc)(this._observable),this._map[Symbol.iterator]()}[Symbol.dispose](){this._observable.destroy()}get[Symbol.toStringTag](){return this._map[Symbol.toStringTag]}}},60999:(e,t,r)=>{r.d(t,{DZ:()=>p,Ke:()=>f,Tj:()=>h,UT:()=>_,jJ:()=>c});var i=r(90237),s=r(69622),n=r(97768),a=r(74887),o=r(10107),l=r(40608);function c(e,t,r){return(0,a.Lx)(e.map(((e,i)=>t.apply(r,[e,i]))))}async function h(e,t,r){return(await(0,a.Lx)(e.map(((e,i)=>t.apply(r,[e,i]))))).map((e=>e.value))}function d(e){return{ok:!0,value:e}}function u(e){return{ok:!1,error:e}}async function f(e){if(null==e)return{ok:!1,error:new Error("no promise provided")};try{return d(await e)}catch(e){return u(e)}}async function p(e){try{return d(await e)}catch(e){return(0,a.QP)(e),u(e)}}function _(e,t){return new m(e,t)}let m=class extends s.A{get value(){return null!=(e=this._result)&&!0===e.ok?e.value:null;var e}get error(){return null!=(e=this._result)&&!1===e.ok?e.error:null;var e}get finished(){return null!=this._result}constructor(e,t){super({}),this._result=null,this._abortHandle=null,this.abort=()=>{this._abortController=(0,n.DC)(this._abortController)},this.remove=this.abort,this._abortController=new AbortController;const{signal:r}=this._abortController;this.promise=e(r),this.promise.then((e=>{this._result=d(e),this._cleanup()}),(e=>{this._result=u(e),this._cleanup()})),this._abortHandle=(0,a.u7)(t,this.abort)}normalizeCtorArgs(){return{}}destroy(){this.abort()}_cleanup(){this._abortHandle=(0,n.xt)(this._abortHandle),this._abortController=null}};(0,i._)([(0,o.MZ)()],m.prototype,"value",null),(0,i._)([(0,o.MZ)()],m.prototype,"error",null),(0,i._)([(0,o.MZ)()],m.prototype,"finished",null),(0,i._)([(0,o.MZ)()],m.prototype,"promise",void 0),(0,i._)([(0,o.MZ)()],m.prototype,"_result",void 0),m=(0,i._)([(0,l.$)("esri.core.asyncUtils.ReactiveTask")],m)},72385:(e,t,r)=>{function i(){return new Float32Array(3)}function s(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function n(e,t,r){const i=new Float32Array(3);return i[0]=e,i[1]=t,i[2]=r,i}function a(){return i()}function o(){return n(1,1,1)}function l(){return n(1,0,0)}function c(){return n(0,1,0)}function h(){return n(0,0,1)}r.d(t,{fA:()=>n,o8:()=>s,vt:()=>i});const d=a(),u=o(),f=l(),p=c(),_=h();Object.freeze(Object.defineProperty({__proto__:null,ONES:u,UNIT_X:f,UNIT_Y:p,UNIT_Z:_,ZEROS:d,clone:s,create:i,createView:function(e,t){return new Float32Array(e,t,3)},fromValues:n,ones:o,unitX:l,unitY:c,unitZ:h,zeros:a},Symbol.toStringTag,{value:"Module"}))},75503:(e,t,r)=>{r.d(t,{E:()=>S,w:()=>o});var i=r(4576),s=r(21818),n=(r(44208),r(3694)),a=r(11006);class o{constructor(e=9,t){this._compareMinX=u,this._compareMinY=f,this._toBBox=e=>e,this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),b.prune(),w.prune(),T.prune(),A.prune()}all(e){l(this._data,e)}search(e,t){let r=this._data;const i=this._toBBox;if(v(e,r))for(b.clear();r;){for(let s=0,n=r.children.length;s<n;s++){const n=r.children[s],a=r.leaf?i(n):n;v(e,a)&&(r.leaf?t(n):y(e,a)?l(n,t):b.push(n))}r=b.pop()}}collides(e){let t=this._data;const r=this._toBBox;if(!v(e,t))return!1;for(b.clear();t;){for(let i=0,s=t.children.length;i<s;i++){const s=t.children[i],n=t.leaf?r(s):s;if(v(e,n)){if(t.leaf||y(e,n))return!0;b.push(s)}}t=b.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,r=e.length;t<r;t++)this.insert(e[t]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(this._data.children.length)if(this._data.height===t.height)this._splitRoot(this._data,t);else{if(this._data.height<t.height){const e=this._data;this._data=t,t=e}this._insert(t,this._data.height-t.height-1,!0)}else this._data=t;return this}insert(e){return e&&this._insert(e,this._data.height-1),this}clear(){return this._data=new O([]),this}remove(e){if(!e)return this;let t,r=this._data,n=null,a=0,o=!1;const l=this._toBBox(e);for(T.clear(),A.clear();r||T.length>0;){if(r||(r=T.pop(),n=T.data[T.length-1],a=A.pop()??0,o=!0),r.leaf&&(t=(0,i.qh)(r.children,(0,s.zI)(e),r.children.length,r.indexHint),-1!==t))return r.children.splice(t,1),T.push(r),this._condense(T),this;o||r.leaf||!y(r,l)?n?(a++,r=n.children[a],o=!1):r=null:(T.push(r),A.push(a),a=0,n=r,r=r.children[0])}return this}toJSON(){return this._data}fromJSON(e){return this._data=e,this}_build(e,t,r,i){const s=r-t+1;let n=this._maxEntries;if(s<=n){const i=new O(e.slice(t,r+1));return c(i,this._toBBox),i}i||(i=Math.ceil(Math.log(s)/Math.log(n)),n=Math.ceil(s/n**(i-1)));const a=new I([]);a.height=i;const o=Math.ceil(s/n),l=o*Math.ceil(Math.sqrt(n));x(e,t,r,l,this._compareMinX);for(let s=t;s<=r;s+=l){const t=Math.min(s+l-1,r);x(e,s,t,o,this._compareMinY);for(let r=s;r<=t;r+=o){const s=Math.min(r+o-1,t);a.children.push(this._build(e,r,s,i-1))}}return c(a,this._toBBox),a}_insert(e,t,r){const i=this._toBBox,s=r?e:i(e);T.clear();const n=function(e,t,r,i){for(;i.push(t),!0!==t.leaf&&i.length-1!==r;){let r,i=1/0,s=1/0;for(let n=0,a=t.children.length;n<a;n++){const a=t.children[n],o=p(a),l=m(e,a)-o;l<s?(s=l,i=o<i?o:i,r=a):l===s&&o<i&&(i=o,r=a)}t=r||t.children[0]}return t}(s,this._data,t,T);for(n.children.push(e),d(n,s);t>=0&&T.data[t].children.length>this._maxEntries;)this._split(T,t),t--;!function(e,t,r){for(let i=r;i>=0;i--)d(t.data[i],e)}(s,T,t)}_split(e,t){const r=e.data[t],i=r.children.length,s=this._minEntries;this._chooseSplitAxis(r,s,i);const n=this._chooseSplitIndex(r,s,i);if(!n)return;const a=r.children.splice(n,r.children.length-n),o=r.leaf?new O(a):new I(a);o.height=r.height,c(r,this._toBBox),c(o,this._toBBox),t?e.data[t-1].children.push(o):this._splitRoot(r,o)}_splitRoot(e,t){this._data=new I([e,t]),this._data.height=e.height+1,c(this._data,this._toBBox)}_chooseSplitIndex(e,t,r){let i,s,n;i=s=1/0;for(let a=t;a<=r-t;a++){const t=h(e,0,a,this._toBBox),o=h(e,a,r,this._toBBox),l=g(t,o),c=p(t)+p(o);l<i?(i=l,n=a,s=c<s?c:s):l===i&&c<s&&(s=c,n=a)}return n}_chooseSplitAxis(e,t,r){const i=e.leaf?this._compareMinX:u,s=e.leaf?this._compareMinY:f;this._allDistMargin(e,t,r,i)<this._allDistMargin(e,t,r,s)&&e.children.sort(i)}_allDistMargin(e,t,r,i){e.children.sort(i);const s=this._toBBox,n=h(e,0,t,s),a=h(e,r-t,r,s);let o=_(n)+_(a);for(let i=t;i<r-t;i++){const t=e.children[i];d(n,e.leaf?s(t):t),o+=_(n)}for(let i=r-t-1;i>=t;i--){const t=e.children[i];d(a,e.leaf?s(t):t),o+=_(a)}return o}_condense(e){for(let t=e.length-1;t>=0;t--){const r=e.data[t];if(0===r.children.length)if(t>0){const s=e.data[t-1],n=s.children;n.splice((0,i.qh)(n,r,n.length,s.indexHint),1)}else this.clear();else c(r,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this._compareMinX=new Function("a","b",t.join(e[0])),this._compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function l(e,t){let r=e;for(w.clear();r;){if(!0===r.leaf)for(const e of r.children)t((0,s.zI)(e));else w.pushArray(r.children);r=w.pop()??null}}function c(e,t){h(e,0,e.children.length,t,e)}function h(e,t,r,i,s){s||(s=new O([])),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let n,a=t;a<r;a++)n=e.children[a],d(s,e.leaf?i(n):n);return s}function d(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function u(e,t){return e.minX-t.minX}function f(e,t){return e.minY-t.minY}function p(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function _(e){return e.maxX-e.minX+(e.maxY-e.minY)}function m(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function g(e,t){const r=Math.max(e.minX,t.minX),i=Math.max(e.minY,t.minY),s=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,s-r)*Math.max(0,n-i)}function y(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function v(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function x(e,t,r,i,s){const n=[t,r];for(;n.length;){const t=n.pop(),r=n.pop();if(t-r<=i)continue;const o=r+Math.ceil((t-r)/i/2)*i;(0,a.q)(e,o,r,t,s),n.push(r,o,o,t)}}const b=new n.A,w=new n.A,T=new n.A,A=new n.A({deallocator:void 0});class S{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class R extends S{constructor(){super(...arguments),this.height=1,this.indexHint=new i.vW}}class O extends R{constructor(e){super(),this.children=e,this.leaf=!0}}class I extends R{constructor(e){super(),this.children=e,this.leaf=!1}}},51624:(e,t,r)=>{r.d(t,{A:()=>d});var i,s,n=r(44208),a=r(69397),o=r(93687);(s=i||(i={}))[s.varint=0]="varint",s[s.fixed64=1]="fixed64",s[s.delimited=2]="delimited",s[s.fixed32=5]="fixed32",s[s.unknown=99]="unknown";const l=4294967296,c=new TextDecoder("utf-8"),h=(0,n.A)("safari")||(0,n.A)("ios")?6:(0,n.A)("ff")?12:32;class d{constructor(e,t,r=0,s=(e?e.byteLength:0)){this._tag=0,this._dataType=i.unknown,this._init(e,t,r,s)}_init(e,t,r,i){this._data=e,this._dataView=t,this._pos=r,this._end=i}get usedMemory(){return 64+(0,a.Qf)(this._data)}asUnsafe(){return this}clone(){return new d(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(e){this._pos=e}nextTag(e){for(;;){if(this._pos===this._end)return!1;const t=this._decodeVarint();if(this._tag=t>>3,this._dataType=7&t,!e||e===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const e=this._decodeVarint();return this._tag=e>>3,this._dataType=7&e,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let e=4294967295;if(e=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128)return e;if(e=(e|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128)return e;if(e=(e|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128)return e;if(e=(e|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128)return e;if(e=(e|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128)return e;throw new Error("Varint overflow")}getUInt64(){return this._decodeVarint()}getSInt32(){const e=this.getUInt32();return e>>>1^-(1&e)}getSInt64(){return this._decodeSVarint()}getBool(){const e=0!==this._data[this._pos];return this._skip(1),e}getEnum(){return this._decodeVarint()}getFixed64(){const e=this._dataView,t=this._pos,r=e.getUint32(t,!0)+e.getUint32(t+4,!0)*l;return this._skip(8),r}getSFixed64(){const e=this._dataView,t=this._pos,r=e.getUint32(t,!0)+e.getInt32(t+4,!0)*l;return this._skip(8),r}getDouble(){const e=this._dataView.getFloat64(this._pos,!0);return this._skip(8),e}getFixed32(){const e=this._dataView.getUint32(this._pos,!0);return this._skip(4),e}getSFixed32(){const e=this._dataView.getInt32(this._pos,!0);return this._skip(4),e}getFloat(){const e=this._dataView.getFloat32(this._pos,!0);return this._skip(4),e}getString(){const e=this._getLength(),t=this._pos,r=this._toString(this._data,t,t+e);return this._skip(e),r}getBytes(){const e=this._getLength(),t=this._pos,r=this._toBytes(this._data,t,t+e);return this._skip(e),r}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(e,t,r,i){const s=this.getMessage(),n=e(s,t,r,i);return s.release(),n}processMessage(e){const t=this.getMessage(),r=e(t);return t.release(),r}getMessage(){const e=this._getLength(),t=d.pool.acquire();return t._init(this._data,this._dataView,this._pos,this._pos+e),this._skip(e),t}release(){d.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case i.varint:this._decodeVarint();break;case i.fixed64:this._skip(8);break;case i.delimited:this._skip(this._getLength());break;case i.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(e){this._skip(e)}_skip(e){if(this._pos+e>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=e}_decodeVarint(){const e=this._data;let t=this._pos,r=0,i=0;if(this._end-t>=10)do{if(i=e[t++],r|=127&i,!(128&i))break;if(i=e[t++],r|=(127&i)<<7,!(128&i))break;if(i=e[t++],r|=(127&i)<<14,!(128&i))break;if(i=e[t++],r|=(127&i)<<21,!(128&i))break;if(i=e[t++],r+=268435456*(127&i),!(128&i))break;if(i=e[t++],r+=34359738368*(127&i),!(128&i))break;if(i=e[t++],r+=4398046511104*(127&i),!(128&i))break;if(i=e[t++],r+=562949953421312*(127&i),!(128&i))break;if(i=e[t++],r+=72057594037927940*(127&i),!(128&i))break;if(i=e[t++],r+=0x8000000000000000*(127&i),!(128&i))break;throw new Error("Varint too long!")}while(0);else{let s=1;for(;t!==this._end&&(i=e[t],128&i);)++t,r+=(127&i)*s,s*=128;if(t===this._end)throw new Error("Varint overrun!");++t,r+=i*s}return this._pos=t,r}_decodeSVarint(){const e=this._data;let t,r=0,i=0;const s=1&e[this._pos];if(i=e[this._pos++],r|=127&i,!(128&i))return s?-(r+1)/2:r/2;if(i=e[this._pos++],r|=(127&i)<<7,!(128&i))return s?-(r+1)/2:r/2;if(i=e[this._pos++],r|=(127&i)<<14,!(128&i))return s?-(r+1)/2:r/2;if(i=e[this._pos++],r|=(127&i)<<21,!(128&i))return s?-(r+1)/2:r/2;if(i=e[this._pos++],r+=268435456*(127&i),!(128&i))return s?-(r+1)/2:r/2;if(i=e[this._pos++],r+=34359738368*(127&i),!(128&i))return s?-(r+1)/2:r/2;if(i=e[this._pos++],r+=4398046511104*(127&i),!(128&i))return s?-(r+1)/2:r/2;if(t=BigInt(r),i=e[this._pos++],t+=0x2000000000000n*BigInt(127&i),!(128&i))return Number(s?-(t+1n)/2n:t/2n);if(i=e[this._pos++],t+=0x100000000000000n*BigInt(127&i),!(128&i))return Number(s?-(t+1n)/2n:t/2n);if(i=e[this._pos++],t+=0x8000000000000000n*BigInt(127&i),!(128&i))return Number(s?-(t+1n)/2n:t/2n);throw new Error("Varint too long!")}_getLength(){if(this._dataType!==i.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(e,t,r){if((r=Math.min(this._end,r))-t>h){const i=e.subarray(t,r);return c.decode(i)}let i="",s="";for(let n=t;n<r;++n){const t=e[n];128&t?s+="%"+t.toString(16):(i+=decodeURIComponent(s)+String.fromCharCode(t),s="")}return s.length&&(i+=decodeURIComponent(s)),i}_toBytes(e,t,r){return r=Math.min(this._end,r),new Uint8Array(e.buffer,t,r-t)}}d.pool=new o.A(d,void 0,(e=>{e._data=null,e._dataView=null}))},95696:(e,t,r)=>{r.d(t,{A:()=>d});var i,s=r(90237),n=r(69540),a=r(25482),o=r(10107),l=(r(44208),r(53966),r(87811),r(93223)),c=r(40608);let h=i=class extends(n.A.ClonableMixin(a.A)){constructor(e){super(e),this.type="georeferenced",this.origin=null}};h.absolute=new i,(0,s._)([(0,l.e)({georeferenced:"georeferenced"},{readOnly:!0})],h.prototype,"type",void 0),(0,s._)([(0,o.MZ)({type:[Number],nonNullable:!1,json:{write:!0}})],h.prototype,"origin",void 0),h=i=(0,s._)([(0,c.$)("esri.geometry.support.MeshGeoreferencedVertexSpace")],h);const d=h},18251:(e,t,r)=>{r.d(t,{A:()=>d});var i=r(90237),s=r(69540),n=r(25482),a=r(10107),o=(r(44208),r(53966),r(87811),r(93223)),l=r(40608),c=r(51850);let h=class extends(s.A.ClonableMixin(n.A)){constructor(e){super(e),this.type="local",this.origin=(0,c.vt)()}};(0,i._)([(0,o.e)({local:"local"},{readOnly:!0})],h.prototype,"type",void 0),(0,i._)([(0,a.MZ)({type:[Number],nonNullable:!0,json:{write:!0}})],h.prototype,"origin",void 0),h=(0,i._)([(0,l.$)("esri.geometry.support.MeshLocalVertexSpace")],h);const d=h},82919:(e,t,r)=>{r.d(t,{C:()=>g,vt:()=>m,ui:()=>y,m7:()=>v});var i=r(4341),s=r(58083),n=r(38954),a=r(51850),o=r(87317),l=r(91829),c=r(71351);function h(e){return e?{ray:(0,c.vt)(e.ray),c0:e.c0,c1:e.c1}:{ray:(0,c.vt)(),c0:0,c1:Number.MAX_VALUE}}new i.I((()=>h()));var d,u,f,p=r(27921),_=r(32114);function m(e){return e?[(0,p.vt)(e[0]),(0,p.vt)(e[1]),(0,p.vt)(e[2]),(0,p.vt)(e[3]),(0,p.vt)(e[4]),(0,p.vt)(e[5])]:[(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)(),(0,p.vt)()]}function g(e,t){for(let r=0;r<x;r++)(0,p.C)(e[r],t[r]);return e}function y(e,t,r,i=T){const a=(0,s.lw)(_.Rc.get(),t,e);(0,s.B8)(a,a);for(let e=0;e<b;++e){const t=(0,o.t)(_.Km.get(),w[e],a);(0,n.i)(i[e],t[0]/t[3],t[1]/t[3],t[2]/t[3])}!function(e,t){(0,p.Cr)(t[u.FAR_BOTTOM_LEFT],t[u.NEAR_BOTTOM_LEFT],t[u.NEAR_TOP_LEFT],e[d.LEFT]),(0,p.Cr)(t[u.NEAR_BOTTOM_RIGHT],t[u.FAR_BOTTOM_RIGHT],t[u.FAR_TOP_RIGHT],e[d.RIGHT]),(0,p.Cr)(t[u.FAR_BOTTOM_LEFT],t[u.FAR_BOTTOM_RIGHT],t[u.NEAR_BOTTOM_RIGHT],e[d.BOTTOM]),(0,p.Cr)(t[u.NEAR_TOP_LEFT],t[u.NEAR_TOP_RIGHT],t[u.FAR_TOP_RIGHT],e[d.TOP]),(0,p.Cr)(t[u.NEAR_BOTTOM_LEFT],t[u.NEAR_BOTTOM_RIGHT],t[u.NEAR_TOP_RIGHT],e[d.NEAR]),(0,p.Cr)(t[u.FAR_BOTTOM_RIGHT],t[u.FAR_BOTTOM_LEFT],t[u.FAR_TOP_LEFT],e[d.FAR])}(r,i)}function v(e,t){for(let r=0;r<x;r++){const i=e[r];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]>=t[3])return!1}return!0}(f=d||(d={}))[f.LEFT=0]="LEFT",f[f.RIGHT=1]="RIGHT",f[f.BOTTOM=2]="BOTTOM",f[f.TOP=3]="TOP",f[f.NEAR=4]="NEAR",f[f.FAR=5]="FAR",function(e){e[e.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",e[e.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",e[e.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",e[e.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",e[e.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",e[e.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",e[e.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",e[e.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(u||(u={})),u.FAR_BOTTOM_RIGHT,u.NEAR_BOTTOM_RIGHT,u.NEAR_BOTTOM_LEFT,u.FAR_BOTTOM_LEFT,u.NEAR_BOTTOM_LEFT,u.NEAR_BOTTOM_RIGHT,u.NEAR_TOP_RIGHT,u.NEAR_TOP_LEFT,u.FAR_BOTTOM_RIGHT,u.FAR_BOTTOM_LEFT,u.FAR_TOP_LEFT,u.FAR_TOP_RIGHT,u.NEAR_BOTTOM_RIGHT,u.FAR_BOTTOM_RIGHT,u.FAR_TOP_RIGHT,u.NEAR_TOP_RIGHT,u.FAR_BOTTOM_LEFT,u.NEAR_BOTTOM_LEFT,u.NEAR_TOP_LEFT,u.FAR_TOP_LEFT,u.FAR_TOP_LEFT,u.NEAR_TOP_LEFT,u.NEAR_TOP_RIGHT,u.FAR_TOP_RIGHT;const x=6,b=8,w=[(0,l.fA)(-1,-1,-1,1),(0,l.fA)(1,-1,-1,1),(0,l.fA)(1,1,-1,1),(0,l.fA)(-1,1,-1,1),(0,l.fA)(-1,-1,1,1),(0,l.fA)(1,-1,1,1),(0,l.fA)(1,1,1,1),(0,l.fA)(-1,1,1,1)],T=(new i.I(h),[(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)(),(0,a.vt)()])},27615:(e,t,r)=>{r.d(t,{CK:()=>l,Hq:()=>o,MW:()=>c,TE:()=>h,yJ:()=>d});var i=r(38954),s=r(86738),n=r(95696),a=r(18251);function o(e){return null!=e.origin}function l(e){return o(e.vertexSpace)}function c(e,t){if(!o(e))return null;const[r,i,n]=e.origin;return new s.A({x:r,y:i,z:n,spatialReference:t})}function h(e,t){const{x:r,y:i,z:s,spatialReference:o}=e,l=[r,i,s??0];return"local"===(t?.vertexSpace??function(e){return e.isGeographic||e.isWebMercator?"local":"georeferenced"}(o))?new a.A({origin:l}):new n.A({origin:l})}function d(e,t){return e.type===t.type&&(e.origin===t.origin||null!=e.origin&&null!=t.origin&&(0,i.p)(e.origin,t.origin))}},31756:(e,t,r)=>{r.d(t,{j:()=>n});var i=r(83047),s=r(79258);const n={unknown:1,inches:(0,i.oU)(1,"meters","inches"),feet:(0,i.oU)(1,"meters","feet"),"us-feet":(0,i.oU)(1,"meters","us-feet"),yards:(0,i.oU)(1,"meters","yards"),miles:(0,i.oU)(1,"meters","miles"),"nautical-miles":(0,i.oU)(1,"meters","nautical-miles"),millimeters:(0,i.oU)(1,"meters","millimeters"),centimeters:(0,i.oU)(1,"meters","centimeters"),decimeters:(0,i.oU)(1,"meters","decimeters"),meters:(0,i.oU)(1,"meters","meters"),kilometers:(0,i.oU)(1,"meters","kilometers"),"decimal-degrees":1/(0,i.vl)(1,"meters",s.$O.radius)}},10536:(e,t,r)=>{function i(e){const t={};for(const r in e){if("declaredClass"===r)continue;const s=e[r];if(null!=s&&"function"!=typeof s)if(Array.isArray(s)){t[r]=[];for(let e=0;e<s.length;e++)t[r][e]=i(s[e])}else"object"==typeof s?s.toJSON&&(t[r]=JSON.stringify(s)):t[r]=s}return t}r.d(t,{z:()=>i})},53655:(e,t,r)=>{r.d(t,{SH:()=>I,ae:()=>T,cn:()=>y});var i=r(49186),s=r(51624),n=r(92722),a=r(69418);const o=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML","esriFieldTypeBigInteger","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"],l=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],c=["upperLeft","lowerLeft"];function h(e){return e>=o.length?null:o[e]}function d(e){return e>=l.length?null:l[e]}function u(e){return e>=c.length?null:c[e]}function f(e,t){return t>=e.geometryTypes.length?null:e.geometryTypes[t]}function p(e,t,r){const i=e.asUnsafe(),s=t.createPointGeometry(r);for(;i.next();)switch(i.tag()){case 3:{const e=i.getUInt32(),r=i.pos()+e;let n=0;for(;i.pos()<r;)t.addCoordinatePoint(s,i.getSInt64(),n++);break}default:i.skip()}return s}function _(e,t,r){const i=e.asUnsafe(),s=t.createGeometry(r),n=2+(r.hasZ?1:0)+(r.hasM?1:0);for(;i.next();)switch(i.tag()){case 2:{const e=i.getUInt32(),r=i.pos()+e;let n=0;for(;i.pos()<r;)t.addLength(s,i.getUInt32(),n++);break}case 3:{const e=i.getUInt32(),r=i.pos()+e;let a=0;for(t.allocateCoordinates(s);i.pos()<r;)t.addCoordinate(s,i.getSInt64(),a),a++,a===n&&(a=0);break}default:i.skip()}return s}function m(e){const t=e.asUnsafe(),r=new n.A;let i="esriGeometryPoint";for(;t.next();)switch(t.tag()){case 2:{const e=t.getUInt32(),i=t.pos()+e;for(;t.pos()<i;)r.lengths.push(t.getUInt32());break}case 3:{const e=t.getUInt32(),i=t.pos()+e;for(;t.pos()<i;)r.coords.push(t.getSInt64());break}case 1:i=a.z[t.getEnum()];break;default:t.skip()}return{queryGeometry:r,queryGeometryType:i}}function g(e){const t=e.asUnsafe();for(;t.next();)switch(t.tag()){case 1:return t.getString();case 2:return t.getFloat();case 3:return t.getDouble();case 4:return t.getSInt32();case 5:return t.getUInt32();case 6:return t.getInt64();case 7:return t.getUInt64();case 8:return t.getSInt64();case 9:return t.getBool();default:return t.skip(),null}return null}function y(e){const t=e.asUnsafe(),r={type:h(0)};for(;t.next();)switch(t.tag()){case 1:r.name=t.getString();break;case 2:r.type=h(t.getEnum());break;case 3:r.alias=t.getString();break;case 4:r.sqlType=d(t.getEnum());break;case 5:default:t.skip();break;case 6:r.defaultValue=t.getString()}return r}function v(e){const t={},r=e.asUnsafe();for(;r.next();)switch(r.tag()){case 1:t.name=r.getString();break;case 2:t.isSystemMaintained=r.getBool();break;default:r.skip()}return t}function x(e,t,r,i){const s=t.createFeature(r);let n=0;for(;e.next();)switch(e.tag()){case 1:{const t=i[n++].name;s.attributes[t]=e.processMessage(g);break}case 2:s.geometry=e.processMessageWithArgs(_,t,r);break;case 4:s.centroid=e.processMessageWithArgs(p,t,r);break;default:e.skip()}return s}function b(e){const t=[1,1,1,1],r=e.asUnsafe();for(;r.next();)switch(r.tag()){case 1:t[0]=r.getDouble();break;case 2:t[1]=r.getDouble();break;case 4:t[2]=r.getDouble();break;case 3:t[3]=r.getDouble();break;default:r.skip()}return t}function w(e){const t=[0,0,0,0],r=e.asUnsafe();for(;r.next();)switch(r.tag()){case 1:t[0]=r.getDouble();break;case 2:t[1]=r.getDouble();break;case 4:t[2]=r.getDouble();break;case 3:t[3]=r.getDouble();break;default:r.skip()}return t}function T(e){const t={originPosition:u(0)},r=e.asUnsafe();for(;r.next();)switch(r.tag()){case 1:t.originPosition=u(r.getEnum());break;case 2:t.scale=r.processMessage(b);break;case 3:t.translate=r.processMessage(w);break;default:r.skip()}return t}function A(e){const t={},r=e.asUnsafe();for(;r.next();)switch(r.tag()){case 1:t.shapeAreaFieldName=r.getString();break;case 2:t.shapeLengthFieldName=r.getString();break;case 3:t.units=r.getString();break;default:r.skip()}return t}function S(e,t){const r=t.createSpatialReference();for(;e.next();)switch(e.tag()){case 1:r.wkid=e.getUInt32();break;case 5:r.wkt=e.getString();break;case 2:r.latestWkid=e.getUInt32();break;case 3:r.vcsWkid=e.getUInt32();break;case 4:r.latestVcsWkid=e.getUInt32();break;default:e.skip()}return r}function R(e,t){const r=t.createFeatureResult(),i=e.asUnsafe();r.geometryType=f(t,0);let s=!1;for(;i.next();)switch(i.tag()){case 1:r.objectIdFieldName=i.getString();break;case 3:r.globalIdFieldName=i.getString();break;case 4:r.geohashFieldName=i.getString();break;case 5:r.geometryProperties=i.processMessage(A);break;case 7:r.geometryType=f(t,i.getEnum());break;case 8:r.spatialReference=i.processMessageWithArgs(S,t);break;case 10:r.hasZ=i.getBool();break;case 11:r.hasM=i.getBool();break;case 12:r.transform=i.processMessage(T);break;case 9:r.exceededTransferLimit=i.getBool();break;case 13:t.addField(r,i.processMessage(y));break;case 15:s||(t.prepareFeatures(r),s=!0),t.addFeature(r,i.processMessageWithArgs(x,t,r,r.fields));break;case 2:r.uniqueIdField=i.processMessage(v);break;default:i.skip()}return t.finishFeatureResult(r),r}function O(e,t){const r={};let i=null;for(;e.next();)switch(e.tag()){case 4:i=e.processMessageWithArgs(m);break;case 1:r.featureResult=e.processMessageWithArgs(R,t);break;default:e.skip()}return null!=i&&r.featureResult&&t.addQueryGeometry(r,i),r}function I(e,t){try{const r=2,i=new s.A(new Uint8Array(e),new DataView(e)),n={};for(;i.next();)i.tag()===r?n.queryResult=i.processMessageWithArgs(O,t):i.skip();return n}catch(e){throw new i.A("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e})}}},69418:(e,t,r)=>{r.d(t,{S:()=>c,z:()=>l});var i=r(83047),s=r(21325),n=r(43334),a=r(58512),o=r(92722);const l=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"];class c{constructor(e){this._options=e,this.geometryTypes=l,this._coordinatePtr=0,this._vertexDimension=0}createFeatureResult(){return new a.A}prepareFeatures(e){this._vertexDimension=2,e.hasZ&&this._vertexDimension++,e.hasM&&this._vertexDimension++}finishFeatureResult(e){if(!e?.features||!e.hasZ||!this._options.sourceSpatialReference||!e.spatialReference||(0,s.aI)(e.spatialReference,this._options.sourceSpatialReference)||e.spatialReference.vcsWkid)return;const t=(0,i.G9)(this._options.sourceSpatialReference)/(0,i.G9)(e.spatialReference);if(1!==t)for(const r of e.features){if(!(0,n.N3)(r))continue;const e=r.geometry.coords;for(let r=2;r<e.length;r+=3)e[r]*=t}}addFeature(e,t){e.features.push(t)}createFeature(){return new n.Om(null,{},null,0)}createSpatialReference(){return{wkid:0}}createGeometry(){return new o.A}addField(e,t){e.fields.push(t)}allocateCoordinates(e){e.coords.length=e.lengths.reduce(((e,t)=>e+t),0)*this._vertexDimension,this._coordinatePtr=0}addCoordinate(e,t){e.coords[this._coordinatePtr++]=t}addCoordinatePoint(e,t){e.coords.push(t)}addLength(e,t){e.lengths.push(t)}addQueryGeometry(e,t){e.queryGeometry=t.queryGeometry,e.queryGeometryType=t.queryGeometryType}createPointGeometry(){return new o.A}}},66208:(e,t,r)=>{r.d(t,{m:()=>s});var i=r(53655);function s(e,t){const r=(0,i.SH)(e,t),s=r.queryResult.featureResult,n=r.queryResult.queryGeometry,a=r.queryResult.queryGeometryType;if(s&&s.features&&s.features.length&&s.objectIdFieldName){const e=s.objectIdFieldName;for(const t of s.features)t.attributes&&(t.objectId=t.attributes[e])}return s&&(s.queryGeometry=n,s.queryGeometryType=a),s}},80893:(e,t,r)=>{r.d(t,{IJ:()=>p,Jf:()=>y,Pk:()=>m,eW:()=>f,gW:()=>g,kS:()=>_});var i=r(78888),s=r(84952),n=r(65864),a=r(17136),o=r(21325),l=r(10536),c=r(66208),h=r(58501);const d="Layer does not support extent calculation.";function u(e,t){const r=e.geometry,i=e.toJSON();delete i.compactGeometryEnabled,delete i.defaultSpatialReferenceEnabled;const s=i;let a,l,c;if(null!=r&&(l=r.spatialReference,c=(0,o.YX)(l),s.geometryType=(0,n.$B)(r),s.geometry=function(e,t){if(t&&"extent"===e.type)return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&"point"===e.type)return`${e.x},${e.y}`;const r=e.toJSON();return delete r.spatialReference,JSON.stringify(r)}(r,e.compactGeometryEnabled),s.inSR=c),i.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=i.groupByFieldsForStatistics.join(",")),i.objectIds&&(s.objectIds=i.objectIds.join(",")),i.orderByFields&&(s.orderByFields=i.orderByFields.join(",")),!i.outFields||!i.returnDistinctValues&&(t?.returnCountOnly||t?.returnExtentOnly||t?.returnIdsOnly)?delete s.outFields:i.outFields.includes("*")?s.outFields="*":s.outFields=i.outFields.join(","),i.outSR?(s.outSR=(0,o.YX)(i.outSR),a=e.outSpatialReference):r&&(i.returnGeometry||i.returnCentroid)&&(s.outSR=s.inSR,a=l),i.returnGeometry&&delete i.returnGeometry,i.outStatistics&&(s.outStatistics=JSON.stringify(i.outStatistics)),i.fullText&&(s.fullText=JSON.stringify(i.fullText)),i.pixelSize&&(s.pixelSize=JSON.stringify(i.pixelSize)),i.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&null!=l&&null!=e.quantizationParameters?.extent&&l.equals(e.quantizationParameters.extent.spatialReference)&&delete i.quantizationParameters.extent.spatialReference,s.quantizationParameters=JSON.stringify(i.quantizationParameters)),i.parameterValues&&(s.parameterValues=JSON.stringify(i.parameterValues)),i.rangeValues&&(s.rangeValues=JSON.stringify(i.rangeValues)),i.dynamicDataSource&&(s.layer=JSON.stringify({source:i.dynamicDataSource}),delete i.dynamicDataSource),i.timeExtent){const e=i.timeExtent,{start:t,end:r}=e;null==t&&null==r||(s.time=t===r?t:`${t??"null"},${r??"null"}`),delete i.timeExtent}return e.defaultSpatialReferenceEnabled&&null!=l&&null!=a&&l.equals(a)&&(s.defaultSR=s.inSR,delete s.inSR,delete s.outSR),s}async function f(e,t,r,i){const s=null!=t.timeExtent&&t.timeExtent.isEmpty?{data:{features:[]}}:await v(e,t,"json",i);return(0,h.q)(t,r,s.data),s}async function p(e,t,r,i){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:r.createFeatureResult()};const s=await _(e,t,i),n=s;return n.data=(0,c.m)(s.data,r),n}function _(e,t,r){return v(e,t,"pbf",r)}function m(e,t,r){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):v(e,t,"json",r,{returnIdsOnly:!0})}function g(e,t,r){return null!=t.timeExtent&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):v(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}async function y(e,t,r){if(null!=t.timeExtent&&t.timeExtent.isEmpty)return{data:{count:0,extent:null}};const i=await v(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}),s=i.data;if(s.hasOwnProperty("extent"))return i;if(s.features)throw new Error(d);if(s.hasOwnProperty("count"))throw new Error(d);return i}async function v(e,t,r,n={},o={}){const c="string"==typeof e?(0,s.An)(e):e,h=t.geometry?[t.geometry]:[],d=await(0,a.el)(h,null,{signal:n.signal}),f=d?.[0];null!=f&&((t=t.clone()).geometry=f);const p=(0,l.z)({...c.query,f:r,...o,...u(t,o)});return(0,i.A)((0,s.fj)(c.path,(_=o,null==t.formatOf3DObjects||_.returnCountOnly||_.returnExtentOnly||_.returnIdsOnly?"query":"query3d")),{...n,responseType:"pbf"===r?"array-buffer":"json",query:{...p,...n.query}});var _}},58501:(e,t,r)=>{r.d(t,{q:()=>s});var i=r(62815);function s(e,t,r){if(!r?.features||!r.hasZ)return;const s=(0,i.N)(r.geometryType,t,e.outSpatialReference);if(null!=s)for(const e of r.features)s(e.geometry)}},6284:(e,t,r)=>{r.r(t),r.d(t,{default:()=>ls});var i=r(90237),s=r(65529),n=r(74887),a=r(36708),o=r(10107),l=r(44208),c=r(53966),h=(r(87811),r(40608)),d=r(5443),u=r(57251),f=r(16930),p=r(19730),_=r(61956),m=r(69622),g=r(4576),y=r(32587),v=r(44794),x=r(19419);let b=class extends m.A{constructor(e){super(e),this._updatingCount=0,this._tileHandles=new y.A,this._wanted=new y.A}destroy(){for(const e of this._tileHandles.values())e.abort();this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updatingCount>0}get _boundingRect(){const{extent:e}=this;return null==e?null:(0,x.VY)(e)}get _missingTiles(){const e=new Array,t=this._wanted;for(const r of this._tileHandles.values())t.has(r.id)&&!A(r)&&e.push(r);return e}async onTileTreeChange(e){++this._updatingCount;try{const{added:t,removed:r}=e,i=this._tileHandles,{_boundingRect:s}=this,n=null!=s?t.filter((e=>(0,x.HY)(s,e.extent))):t,a=this._wanted,o=new Array;for(const e of r){const{id:r}=e;if(a.delete(r),t.some((t=>w(t,e)||w(e,t))))continue;const s=i.get(r);null!=s&&o.push(this._removeTile(s))}for(const e of n)a.set(e.id,e),o.push(this._addTile(e));await Promise.allSettled(o)}finally{--this._updatingCount}}async _removeTile(e){this._tileHandles.delete(e.id),e.abort(),this._validate();const{tile:t}=e,r=new S(e.untilSettled(),null!=t?this.createRemoveTileCommand(t):null);e.nextEvent=null;const{command:i}=await r.getCommand();i?.execute()}async _addTile(e){const{_tileHandles:t}=this,r=t.get(e.id);if(null!=r)return!A(r)||r.tile.isComplete||(r.tile=r.tile.reset(),r.nextEvent=this._onTileLoad(r)),void await r.untilSettled();const i=new T(e);this._tileHandles.set(i.id,i);const s=this.loadTile(e,i.signal);i.nextEvent=s;const a=await s;if(i.aborted)throw(0,n.NK)();i.tile=a,function(e){if(!A(e))throw new Error}(i),i.nextEvent=this._onTileLoad(i),await i.untilSettled()}async _onTileLoad(e){const{_wanted:t,_tileHandles:r,_missingTiles:i}=this,s=e.descriptor,n=new Array,a=new Array,o=new Set;for(const l of r.values()){if(l===e)continue;const{descriptor:c,id:h}=l;if(t.has(h)||i.some((({descriptor:e})=>w(e,c)||w(c,e)))){if(A(l)){if(w(s,c)){const e=l.tile;for(const t of e.objectIds())o.add(t)}if(w(c,s)){const t=e.tile,r=new Set(t.objectIds()),i=l.tile,s=i.exclude(r);l.tile=s;const o=AbortSignal.any([l.signal,e.signal]),c=l.untilSettled();n.push(new S(c,this.createRemoveTileCommand(i))),n.push(new S(c,this.createAddTileCommand(s,o),o)),a.push(l),this._validateRemoval(s,r)}}}else{l.abort(),r.delete(h);const{tile:e}=l;null!=e&&n.push(new S(l.untilSettled(),this.createRemoveTileCommand(e))),l.nextEvent=null}}o.size>0&&(e.tile=e.tile.exclude(o),this._validateRemoval(e.tile,o)),n.push(new S(e.untilSettled(),this.createAddTileCommand(e.tile,e.signal),e.signal)),a.push(e),this._validate();const l=this._joinCommands(n);for(const e of a)e.nextEvent=l;await l}async _joinCommands(e){const t=(await Promise.allSettled(e.map((async e=>e.getCommand())))).map((e=>"fulfilled"!==e.status||e.value.signal?.aborted?null:e.value.command)).filter(g.Ru);0!==t.length&&t.reduce(((e,t)=>(e.append(t),e))).execute()}_validate(){if(!(0,l.A)("feature-pipeline-3d-test-validation"))return;const e=new Array;for(const t of this._tileHandles.values()){if(!A(t))continue;const{tile:r}=t,i=r.featureCount,s=new Uint32Array(i);r.readObjectIds(s),e.push({tile:r,objectIds:new Set(s)})}for(let t=0;t<e.length;++t){const{tile:r,objectIds:i}=e[t];for(let s=t+1;s<e.length;++s){const{tile:t,objectIds:n}=e[s];for(const e of n)if(i.has(e)){const i=w(t.descriptor,r.descriptor),s=w(r.descriptor,t.descriptor);throw new Error(`${r.descriptor.id} and ${t.descriptor.id} both contain ${e}. aInB: ${i}; bInA: ${s}`)}}}}_validateRemoval(e,t){if((0,l.A)("feature-pipeline-3d-test-validation"))for(const r of e.objectIds())if(t.has(r))throw new Error(`Failed to remove ${r} from ${e.descriptor.id}!`)}};function w({lij:[e,t,r]},{lij:[i,s,n]}){const a=i-e;return a>=0&&t===s>>a&&r===n>>a}(0,i._)([(0,o.MZ)()],b.prototype,"updating",null),(0,i._)([(0,o.MZ)({constructOnly:!0})],b.prototype,"loadTile",void 0),(0,i._)([(0,o.MZ)({constructOnly:!0})],b.prototype,"createAddTileCommand",void 0),(0,i._)([(0,o.MZ)({constructOnly:!0})],b.prototype,"createRemoveTileCommand",void 0),(0,i._)([(0,o.MZ)()],b.prototype,"_updatingCount",void 0),(0,i._)([(0,o.MZ)()],b.prototype,"extent",void 0),(0,i._)([(0,o.MZ)()],b.prototype,"_boundingRect",null),(0,i._)([(0,o.MZ)()],b.prototype,"_missingTiles",null),b=(0,i._)([(0,h.$)("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],b);class T{constructor(e){this.descriptor=e,this._controller=new AbortController,this._tile=(0,v.v)(null),this.nextEvent=null}get id(){return this.descriptor.id}get tile(){return this._tile.value}set tile(e){this._tile.value=e}get signal(){return this._controller.signal}abort(){this._controller.abort()}get aborted(){return this._controller.signal.aborted}async untilSettled(){try{await this.nextEvent}catch(e){(0,n.zf)(e)||console.error(e)}}}function A(e){return null!=e.tile}class S{constructor(e,t,r){this.previousEventSettled=e,this.commandPromise=t,this.signal=r}async getCommand(){const{previousEventSettled:e,commandPromise:t,signal:r}=this,[i]=await Promise.all([t,e]);if(r?.aborted)throw(0,n.NK)();return{command:i,signal:r}}}var R=r(69397);class O{constructor(e,t){this.tile=e,this._tileIndices=t}get id(){return this.tile.id}get featureCount(){return this._tileIndices?.length??this.tile.featureCount}get usedMemory(){return R.qK+(this._tileIndices?.byteLength??0)}get extent(){return this.tile.descriptor.extent}readObjectIds(e,t){const{_tileIndices:r,tile:i}=this;return i.readObjectIds(e,r,t)}readCoordinates(e,t){const{_tileIndices:r,tile:i}=this;return i.readCoordinates(e,r,t)}subset(e){const{_tileIndices:t,tile:r}=this;if(null==t)return new O(r,e);const i=new Uint32Array(e.length);for(let r=0;r<i.length;++r)i[r]=t[e[r]];return new O(r,i)}}class I{constructor(){this._tileToFeatureData=new Map}add(e){this._tileToFeatureData.set(e.tile,e)}remove(e){this._tileToFeatureData.delete(e)}get(e){return this._tileToFeatureData.get(e)}}var M=r(75503),C=r(27647),E=r(92722);class F{constructor(e,t){this._index=e,this._view=t}get usedMemory(){return R.qK+R.RS}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(e){return this._view.getAttribute(this._index,e)}getAttributeAsTimestamp(e){return this._view.getAttributeAsTimestamp(this._index,e)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(e){return this._view.getCentroid(this._index,e)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(e){return new D(this._index,this._view,e)}}class D extends F{constructor(e,t,r){super(e,t),this._geometryOverride=r}getOptimizedGeometry(){return this._geometryOverride}getCentroid(e){return(0,C.Q)(new E.A,this._geometryOverride,e.hasZ,e.hasM)}}class P{constructor(){this._tileBounds=new Map,this.events=new s.A,this.featureAdapter=L.shared}get usedMemory(){return R.qK+R.qK*this._tileBounds.size}addTile(e){const{featureCount:t}=e;if(0===t)return;const r=new M.w(9,(t=>e.getBounds(t))),i=new Array;for(let e=0;e<t;++e)i[e]=e;r.load(i),this._tileBounds.set(e,r),this.events.emit("changed")}removeTile(e){this._tileBounds.delete(e),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(e){for(const[t,r]of this._tileBounds)r.all((r=>e(new F(r,t))))}forEachInBounds(e,t){N.minX=e[0],N.minY=e[1],N.maxX=e[2],N.maxY=e[3];for(const[e,r]of this._tileBounds)r.search(N,(r=>t(new F(r,e))))}forEachBounds(e,t){for(const r of e)t(r.getBoundingBox())}getFullExtent(e){let t=1/0,r=1/0,i=-1/0,s=-1/0;for(const e of this._tileBounds.values()){const{minX:n,minY:a,maxX:o,maxY:l}=e.toJSON();t=Math.min(t,n),r=Math.min(r,a),i=Math.min(i,o),s=Math.min(s,l)}return{xmin:t,ymin:r,xmax:i,ymax:s,spatialReference:e}}}class L{getObjectId(e){return e.getObjectId()}getAttribute(e,t){return e.getAttribute(t)}getAttributeAsTimestamp(e,t){return e.getAttributeAsTimestamp(t)}getAttributes(e){return e.getAttributes()}getGeometry(e){return e.getOptimizedGeometry()}getCentroid(e,t){return e.getCentroid(t)}cloneWithGeometry(e,t){return e.cloneWithGeometry(t)}}L.shared=new L;const N=new M.E;var z=r(80893);class B{constructor(e,t,r=function(e){const t=e.reduce(((e,{featureCount:t})=>e+t),0),r=new Array;if(0===t)return r;const i=e[0].featureCount;for(let e=0;e<t;++e)r[2*e]=Math.floor(e/i),r[2*e+1]=e%i;return r}(t)){this.descriptor=e,this._pages=t,this._addressTable=r;const i=R.ez+t.reduce(((e,{usedMemory:t})=>e+t),0),s=3*R.RS,n=(0,R.Qf)(r);this.usedMemory=R.qK+i+s+n,this.featureCount=Math.floor(this._addressTable.length/2),this.isComplete=this.featureCount===t.reduce(((e,t)=>e+t.featureCount),0)}get id(){return this.descriptor.id}getObjectId(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getObjectId(r)}getAttribute(e,t){const{pageIndex:r,featurePageIndex:i}=this._translateIndex(e);return this._pages[r].getAttribute(i,t)}getAttributeAsTimestamp(e,t){const{pageIndex:r,featurePageIndex:i}=this._translateIndex(e);return this._pages[r].getAttributeAsTimestamp(i,t)}getAttributes(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getAttributes(r)}getCoordinates(e,t,r){const{pageIndex:i,featurePageIndex:s}=this._translateIndex(e);this._pages[i].getCoordinates(s,t,r)}getOptimizedGeometry(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getOptimizedGeometry(r)}getCentroid(e,t){const{pageIndex:r,featurePageIndex:i}=this._translateIndex(e);return this._pages[r].getCentroid(i,t)}getBounds(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBounds(r)}getBoundingBox(e){const{pageIndex:t,featurePageIndex:r}=this._translateIndex(e);return this._pages[t].getBoundingBox(r)}readObjectIds(e,t=this._allFeatureIndices(),r=0){let i=r;for(const{page:r,indices:s}of this._batchPageIndices(t))i=r.readObjectIds(e,s,i);return i}readCoordinates(e,t=this._allFeatureIndices(),r=0){let i=r;for(const{page:r,indices:s}of this._batchPageIndices(t))i=r.readCoordinates(e,s,i);return i}*objectIds(e=this._allFeatureIndices()){for(const{page:t,indices:r}of this._batchPageIndices(e))for(const e of t.objectIds(r))yield e}exclude(e){if(0===e.size)return this;const{_addressTable:t,featureCount:r}=this,i=new Array;for(let s=0;s<r;++s){const r=this.getObjectId(s);e.has(r)||(i.push(t[2*s]),i.push(t[2*s+1]))}return new B(this.descriptor,this._pages,i)}reset(){const{isComplete:e,_pages:t}=this;return e?this:new B(this.descriptor,t)}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_translateIndex(e){const{_addressTable:t}=this;return{pageIndex:t[2*e],featurePageIndex:t[2*e+1]}}*_batchPageIndices(e){const t=new Array;{let r=0,i=new Array;for(const s of e){const{pageIndex:e,featurePageIndex:n}=this._translateIndex(s);r!==e&&(0!==i.length&&t.push({pageIndex:r,indices:i}),r=e,i=[]),i.push(n)}0!==i.length&&t.push({pageIndex:r,indices:i})}const{_pages:r}=this;for(const{pageIndex:e,indices:i}of t)yield{page:r[e],indices:i}}}var V=r(49186),H=r(51624),j=r(51850),U=r(70328),G=r(62577),k=r(95466),q=r(53655);class Z{constructor(e){this._reader=new H.A(new Uint8Array(e),new DataView(e)),this._index=function(e){for(;e.next();){if(2===e.tag())return W(e.getMessage());e.skip()}$()}(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(e){return this.getAttribute(e,this._index.objectIdFieldName)}getAttribute(e,t){const{_index:{fieldsIndex:r,attributeIndices:i}}=this,s=r.get(t)?.index;if(null==s)return;const n=i[e*r.fields.length+s],a=this._reader;return a.move(n),X(a)}getAttributeAsTimestamp(e,t){const r=this.getAttribute(e,t);return"string"==typeof r?new Date(r).getTime():"number"==typeof r||null==r?r:null}getAttributes(e){const{_index:{fieldsIndex:t,attributeIndices:r}}=this,i=e*t.fields.length,s=this._reader,n={};for(const e of t.fields){const t=r[i+e.index];s.move(t),n[e.name]=X(s)}return n}getCoordinates(e,t,r=0){const i=this._reader,{transform:s,featureIndices:n}=this._index,{scale:a,translate:o}=s;i.move(n[e]),this._readCoordinates(a,o,t,r)}getOptimizedGeometry(e){const t=(0,j.vt)();return this.getCoordinates(e,t),new E.A([],t)}getCentroid(e,{hasZ:t,hasM:r}){this.getCoordinates(e,J);const[i,s,n]=J,a=[i,s];return t&&(a[3]=n),r&&(a[t?4:3]=0),new E.A([],a)}getBounds(e){this.getCoordinates(e,J);const[t,r]=J,i=new M.E;return i.minX=t,i.minY=r,i.maxX=t,i.maxY=r,i}getBoundingBox(e){this.getCoordinates(e,J);const[t,r,i]=J;return(0,U.fA)(t,r,i,t,r,i)}readObjectIds(e,t=this._allFeatureIndices(),r=0){const i=this._reader,{objectIdFieldName:s,attributeIndices:n,fieldsIndex:a}=this._index,o=a.get(s).index,l=a.fields.length;for(const s of t){const t=n[s*l+o];i.move(t),e[r++]=X(i)}return r}readCoordinates(e,t=this._allFeatureIndices(),r=0){const i=this._reader,{transform:s,featureIndices:n}=this._index,{scale:a,translate:o}=s;for(const s of t){const t=n[s];i.move(t),r=this._readCoordinates(a,o,e,r)}return r}*objectIds(e=this._allFeatureIndices()){const t=this._reader,{objectIdFieldName:r,attributeIndices:i,fieldsIndex:s}=this._index,n=s.get(r).index,a=s.fields.length;for(const r of e){const e=i[r*a+n];t.move(e),yield X(t)}}*_allFeatureIndices(){const{featureCount:e}=this;for(let t=0;t<e;++t)yield t}_readCoordinates([e,t,r],[i,s,n],a,o){const l=this._reader,c=l.getLength(),h=l.pos()+c;for(;l.pos()<h&&l.next();)switch(l.tag()){case 2:{const c=l.getLength(),h=l.pos()+c;for(;l.pos()<h&&l.next();)3===l.tag()?(l.getUInt32(),a[o++]=i+e*l.getSInt64(),a[o++]=s+t*l.getSInt64(),a[o++]=n+r*l.getSInt64()):l.skip();break}default:l.skip()}return o}}function W(e){for(;e.next();){if(1===e.tag())return Y(e.getMessage());e.skip()}$()}function Y(e){let t,r,i=!1,s=!1,n=0;const a=new Array,o=new Array,l=new Array;for(;e.next();)switch(e.tag()){case 1:r=e.getString();break;case 7:0!==e.getEnum()&&$();break;case 9:i=e.getBool()??!1;break;case 12:t=(0,G.Q1)(e.processMessage(q.ae));break;case 13:{const t=e.processMessage(q.cn);t.index=n++,a.push(t);break}case 15:{o.push(e.pos());const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r&&e.next();)1===e.tag()?(l.push(e.pos()),e.skip()):e.skip();break}case 10:s=e.getBool()??!1;break;default:e.skip()}const c=new k.A(a);return null!=t&&s&&null!=r&&c.has(r)||$(),{transform:t,exceededTransferLimit:i,fieldsIndex:c,objectIdFieldName:r,featureIndices:o,attributeIndices:l}}function $(){const e=new V.A("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(e),e}function X(e){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}const J=(0,j.vt)();class Q{constructor(e,t,r,i,s){this.spatialReference=e,this.url=r,this.objectIdField=i,this.capabilities=s;const{supportsMaxRecordCountFactor:n,maxRecordCount:a}=this.capabilities.query,o=n?4:1,l=(a??8e3)*o;this._pageSize=Math.min(8e3,l);const c=t.clone();c.cacheHint=!0,c.resultType="tile",c.outSpatialReference=e,c.returnGeometry=!0,c.returnZ=!0,c.maxRecordCountFactor=o,c.num=this._pageSize,c.outFields=[i],this._baseQuery=c}async fetch(e,t){const{spatialReference:r}=this,i=(0,x.w1)(e.extent,r),s=this._baseQuery.clone();s.geometry=i;const a=new Array;let o=0,l=!1,c=1;for(;!l;){const e=[];for(let r=0;r<c;++r)e.push(this._fetchPage(s,o++,t));const r=await Promise.all(e);(0,n.Te)(t);for(const e of r){const t=0!==e.featureCount;l||=!e.exceededTransferLimit||!t,t&&a.push(e)}c=Math.min(c+1,4)}return new B(e,a)}async _fetchPage(e,t,r){const i=e.clone();i.start=t*this._pageSize;const s=(await(0,z.kS)(this.url,i,{signal:r})).data;return(0,n.Te)(r),new Z(s)}}var K=r(24151),ee=r(97146),te=r(36563),re=r(97768),ie=r(91829),se=r(37585),ne=r(48163),ae=r(34727),oe=r(26857);new Map,(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t)})();const le=[];{const e=16;for(let t=0;t<360;t+=360/e)le.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var ce,he;(he=ce||(ce={}))[he.Left=0]="Left",he[he.Center=1]="Center",he[he.Right=2]="Right",Object.freeze({left:0,center:.5,right:1});const de=Object.freeze({"bottom-left":(0,ne.fA)(0,0),bottom:(0,ne.fA)(.5,0),"bottom-right":(0,ne.fA)(1,0),left:(0,ne.fA)(0,.5),center:(0,ne.fA)(.5,.5),right:(0,ne.fA)(1,.5),"top-left":(0,ne.fA)(0,1),top:(0,ne.fA)(.5,1),"top-right":(0,ne.fA)(1,1)});var ue=r(4431),fe=r(49255);const pe={required:[]};fe.V.Depth;class _e extends m.A{precompile(e){return!!this.acquireTechniques(e)}consumes(){return pe}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}modify(e){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}queryRenderOccludedState(e){return!1}}class me extends _e{}class ge extends _e{}var ye=r(89192);class ve{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach(((e,t)=>{null!=e&&this._repository.release(this._material,t)}))}load(e,t,r){const i=this._material.produces.get(t);if(!i?.(r))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,t,r));const s=this._map.get(r);if(null!=s){if(s.ensureResources(e)===ye.Am.LOADED)return s;this._repository.requestRender()}return null}}var xe=r(13464),be=r(72824);class we extends be.gy{constructor(e=(0,j.vt)()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}}let Te=class extends me{constructor(e){super(e),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new we,this._bufferWriter=null}get produces(){return this._produces}get numFeatures(){let e=0;return this._renderGeometries.forEach((t=>e+=t.numElements/6)),e}get usedMemory(){let e=0;return this._renderGeometries.forEach((t=>{e+=t.vao.usedMemory})),e}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach(((e,t)=>{this._produces.set(t,(t=>t!==fe.V.Highlight&&t!==fe.V.ShadowHighlight&&e(t)))}))}destroy(){this._glMaterials.dispose();const e=this._renderGeometries.keys();for(const t of e)this.removeRenderGeometry(t)}acquireTechniques(e){const t=this.material;if(!t.shouldRender(e))return null;const{output:r,bind:i}=e,s=t.produces.get(i.slot);if(!s?.(r))return null;if(r===fe.V.Highlight||r===fe.V.ShadowHighlight)return null;const n=this._glMaterials.load(e.rctx,i.slot,r);return n?.beginSlot(i)}render(e,t){const r=this._renderGeometries;if(0===r.size)return;const{bind:i}=e,s=i.slot===xe.N.OCCLUDER_MATERIAL||i.slot===xe.N.TRANSPARENT_OCCLUDER_MATERIAL?i.slot:null,n=e.rctx;n.runAppleAmdDriverHelper(),n.bindTechnique(t,i,this.material.parameters);const a=t.program;for(const[e,o]of r)this._drawParameters.origin=o.localOrigin,a.bindDraw(i,this.material.parameters,this._drawParameters),t.ensureAttributeLocations(o.vao),n.bindVAO(o.vao),n.setPipelineState(t.getPipeline(!1,s)),n.drawArrays(t.primitiveType,0,o.numElements)}initializeRenderContext(e,t){this._glMaterials=new ve(this.material,e.materials),this._vaoCache=e.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,(0,ue.U)(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}addRenderGeometry(e,t,r){this.removeRenderGeometry(e);const i=this._vaoCache.newVao(t.data.byteLength);i.vertexBuffers.get("geometry").setSubData(new Uint8Array(t.data),0,0,t.data.byteLength);const s={localOrigin:r,vao:i,numElements:t.elementCount};return this._renderGeometries.set(e,s),s}removeRenderGeometry(e){const t=this._renderGeometries.get(e);null!=t&&(this._vaoCache.deleteVao(t.vao),this._renderGeometries.delete(e))}hasHighlightOptions(e){return!1}};(0,i._)([(0,o.MZ)({constructOnly:!0})],Te.prototype,"material",void 0),Te=(0,i._)([(0,h.$)("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],Te);var Ae,Se,Re,Oe,Ie=r(46540),Me=r(91869),Ce=r(9093),Ee=r(38954),Fe=r(1843),De=r(90629),Pe=r(58083),Le=r(87317),Ne=r(82919),ze=r(71351),Be=r(44280);r(3694),(Oe=Ae||(Ae={}))[Oe.Default=0]="Default",Oe[Oe.Screenshot=1]="Screenshot",Oe[Oe.ObjectAndLayerID=2]="ObjectAndLayerID",function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(Se||(Se={}));let Ve=Re=class extends m.A{constructor(e){super(e),this._ray=(0,ze.vt)(),this._viewport=(0,ie.fA)(0,0,1,1),this._padding=(0,ie.fA)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,ne.fA)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,Ce.vt)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,Ce.vt)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,Ce.vt)(),this._frustumDirty=!0,this._frustum=(0,Ne.vt)(),this._fullViewport=(0,ie.vt)(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=(0,j.vt)(),this._up=(0,j.vt)(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return(0,Ee.d)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,Pe.C)(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),(0,Ee.i)((0,j.vt)(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),(0,Ee.i)((0,j.vt)(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),(0,Ee.i)((0,j.vt)(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(1===this.pixelRatio)return this._viewport;const e=(0,Le.b)((0,ie.vt)(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&(0,Le.e)(e,t)?t:e}get screenPadding(){if(1===this.pixelRatio)return this._padding;const e=(0,Le.b)((0,ie.vt)(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&(0,Le.e)(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[Se.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[Se.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[Se.RIGHT]+this._padding[Se.LEFT]}set fullWidth(e){this.width=e-(this._padding[Se.RIGHT]+this._padding[Se.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[Se.TOP]+this._padding[Se.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[Se.TOP]+this._padding[Se.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[Se.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[Se.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){(0,Le.a)(this._padding,e)||(this._viewport[0]+=e[Se.LEFT]-this._padding[Se.LEFT],this._viewport[1]+=e[Se.BOTTOM]-this._padding[Se.BOTTOM],this._viewport[2]-=e[Se.RIGHT]+e[Se.LEFT]-(this._padding[Se.RIGHT]+this._padding[Se.LEFT]),this._viewport[3]-=e[Se.TOP]+e[Se.BOTTOM]-(this._padding[Se.TOP]+this._padding[Se.BOTTOM]),(0,Le.c)(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,Pe.lw)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return(0,Pe.B8)((0,Ce.vt)(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||(0,Ce.vt)()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return function(e,t,r){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+r*r))}(this._fov,this.width,this.height)}set fovX(e){this._fov=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/t)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return function(e,t,r){return 2*Math.atan(r*Math.tan(.5*e)/Math.sqrt(t*t+r*r))}(this._fov,this.width,this.height)}set fovY(e){this._fov=function(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/r)}(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,Ee.j)(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,Pe.B8)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,Pe.mg)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const{near:t,far:r}=this;return 2*t*r/(r+t-e*(r-t))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}get _projectionMatrixInternal(){const e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2)*2,i=r*this._aspect,s=r/this.rows,n=i/this.columns,a=-i/2+this.column*n,o=a+n,l=-r/2+this.row*s,c=l+s,h=(0,Pe.$h)((0,Ce.vt)(),a*(1+2*this._padding[Se.LEFT]/e),o*(1+2*this._padding[Se.RIGHT]/e),l*(1+2*this._padding[Se.BOTTOM]/t),c*(1+2*this._padding[Se.TOP]/t),this.near,this.far),d=this._get("projectionMatrix");return d&&(0,Pe.aI)(d,h)?d:h}copyFrom(e){(0,Ee.c)(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,(0,Le.c)(this._viewport,e.viewport),this.notifyChange("_viewport"),(0,Le.c)(this._padding,e.padding),this.notifyChange("_padding"),(0,se.C)(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,Pe.C)(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,Ne.C)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,Pe.C)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,Le.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up,this.fov=e.fov}clone(){return(new Re).copyFrom(this)}equals(e){return(0,Ee.p)(this.eye,e.eye)&&(0,Ee.p)(this.center,e.center)&&(0,Ee.p)(this.up,e.up)&&(0,Le.a)(this._viewport,e.viewport)&&(0,Le.a)(this._padding,e.padding)&&(0,se.t2)(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||(0,Le.d)(e.screenPadding,this.screenPadding)>=t||(0,Le.d)(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;(0,Ee.a)(Ge,e.eye,e.center),(0,Ee.a)(ke,this.eye,this.center);const r=(0,Ee.f)(Ge,ke),i=(0,Ee.z)(Ge),s=(0,Ee.z)(ke),n=5e-4;return r*r>=(1-1e-10)*i*s&&(0,Ee.y)(e.eye,this.eye)<Math.max(i,s)*n*n}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs((0,Be.gr)(this.viewForward,(0,Ee.d)(Ge,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=(0,De.gs)()){return e[0]=(this.padding[Se.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[Se.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,r=.5){return e[0]=this.padding[Se.LEFT]+this.width*t,e[1]=this.padding[Se.BOTTOM]+this.height*r,e[2]=.5,e}setGLViewport(e){const t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}applyProjection(e,t){e!==je&&(0,Ee.c)(je,e),je[3]=1,(0,Le.t)(je,je,this.projectionMatrix);const r=Math.abs(je[3]);(0,Ee.h)(je,je,1/r);const i=this.fullViewport;t[0]=(0,ae.Cc)(0,i[0]+i[2],.5+.5*je[0]),t[1]=(0,ae.Cc)(0,i[1]+i[3],.5+.5*je[1]),t[2]=.5*(je[2]+1),t[3]=r}unapplyProjection(e,t){const r=this.fullViewport;je[0]=(e[0]/(r[0]+r[2])*2-1)*e[3],je[1]=(e[1]/(r[1]+r[3])*2-1)*e[3],je[2]=(2*e[2]-1)*e[3],je[3]=e[3],null!=this.inverseProjectionMatrix&&((0,Le.t)(je,je,this.inverseProjectionMatrix),t[0]=je[0],t[1]=je[1],t[2]=je[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,qe),this.renderToScreen(qe,t),t}projectToRenderScreen(e,t){if(je[0]=e[0],je[1]=e[1],je[2]=e[2],je[3]=1,(0,Le.t)(je,je,this.viewProjectionMatrix),0===je[3])return null;const r=je;(0,Ee.h)(r,r,1/Math.abs(je[3]));const i=this.fullViewport,s=(0,ae.Cc)(0,i[0]+i[2],.5+.5*r[0]),n=(0,ae.Cc)(0,i[1]+i[3],.5+.5*r[1]);return"x"in t?(t.x=s,t.y=n):(t[0]=s,t[1]=n,t.length>2&&(t[2]=.5*(r[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,qe),t)}unprojectFromRenderScreen(e,t){if((0,Pe.lw)(Ue,this.projectionMatrix,this.viewMatrix),!(0,Pe.B8)(Ue,Ue))return null;const r=this.fullViewport;return je[0]=2*(e[0]-r[0])/r[2]-1,je[1]=2*(e[1]-r[1])/r[3]-1,je[2]=2*e[2]-1,je[3]=1,(0,Le.t)(je,je,Ue),0===je[3]?null:(t[0]=je[0]/je[3],t[1]=je[1]/je[3],t[2]=je[2]/je[3],t)}constrainWindowSize(e,t,r,i){const s=e*this.pixelRatio,n=t*this.pixelRatio,a=Math.max(s-r/2,0),o=Math.max(this.fullHeight-n-i/2,0),l=-Math.min(s-r/2,0),c=-Math.min(this.fullHeight-n-i/2,0),h=r-l- -Math.min(this.fullWidth-s-r/2,0),d=i-c- -Math.min(n-i/2,0);return[Math.round(a),Math.round(o),Math.round(h),Math.round(d)]}computeUp(e){e===K.RT.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const r=e[0]*this.pixelRatio,i=this.fullHeight-e[1]*this.pixelRatio;return t[0]=r,t[1]=i,t}renderToScreen(e,t){const r=e[0]/this.pixelRatio,i=(this.fullHeight-e[1])/this.pixelRatio;t[0]=r,t[1]=i}_computeUpGlobal(){(0,Ee.d)(Ge,this.center,this.eye);const e=(0,Ee.l)(this.center);e<1?((0,Ee.i)(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs((0,Ee.f)(Ge,this.center))>.9999*(0,Ee.l)(Ge)*e||((0,Ee.e)(this._up,Ge,this.center),(0,Ee.e)(this._up,this._up,Ge),(0,Ee.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){(0,Ee.o)(Ge,this.eye,this.center),Math.abs(Ge[2])<=.9999&&((0,Ee.h)(Ge,Ge,Ge[2]),(0,Ee.i)(this._up,-Ge[0],-Ge[1],1-Ge[2]),(0,Ee.n)(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t,r=""){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,Ee.p)(e,t)||((0,Ee.c)(t,e),this._markViewDirty(),r.length&&this.notifyChange(r)):c.A.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,Ne.ui)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,Pe.t5)(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};(0,i._)([(0,o.MZ)()],Ve.prototype,"_viewport",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"_padding",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"_fov",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"_nearFar",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"_viewDirty",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"_viewMatrix",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"_pixelRatio",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"pixelRatio",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"row",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"column",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"_rows",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"rows",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"_columns",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"columns",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"eye",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"center",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"_center",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"up",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"_up",void 0),(0,i._)([(0,o.MZ)()],Ve.prototype,"viewMatrix",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"viewForward",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"viewUp",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"viewRight",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"nearFar",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"near",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"far",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"viewport",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"screenViewport",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"screenPadding",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"x",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"y",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"width",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"height",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"fullWidth",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"fullHeight",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"_aspect",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"padding",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"projectionMatrix",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"inverseProjectionMatrix",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"fov",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"fovX",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"fovY",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"viewInverseTransposeMatrix",null),(0,i._)([(0,o.MZ)({readOnly:!0})],Ve.prototype,"_projectionMatrixInternal",null),(0,i._)([(0,o.MZ)()],Ve.prototype,"relativeElevation",void 0),Ve=Re=(0,i._)([(0,h.$)("esri.views.3d.webgl.RenderCamera")],Ve);const He=Ve,je=(0,ie.vt)(),Ue=(0,Ce.vt)(),Ge=(0,j.vt)(),ke=(0,j.vt)(),qe=(0,De.r_)();var Ze=r(39341);class We{constructor(e=1/0,t=-1/0){this.near=e,this.far=t}set(e,t){this.near=e,this.far=t}union(e){null!=e&&(this.near=Math.min(this.near,e.near),this.far=Math.max(this.far,e.far))}within(e){return this.near<=e&&e<=this.far}}We.zero=new We(0,0);var Ye=r(62258),$e=r(78230),Xe=r(620),Je=r(77690),Qe=r(29242),Ke=r(13030),et=r(32728),tt=r(48852),rt=r(63907);class it{constructor(e,t,r){this._elementSize=t,this._buffer=tt.g.createVertex(e,rt._U.STATIC_DRAW),this.resize(r)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(e,t,r,i=0){const s=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(r.array,i*this.elementSize).set(s)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const r=e*this._elementSize,i=t*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),r,r,i)}resize(e){const t=e*this._elementSize,r=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=r,this._buffer.setSize(t),this._capacity=e}}class st{constructor(e){this.modelOriginHi=e.getField(Ie.r.INSTANCEMODELORIGINHI,Ke.xs),this.modelOriginLo=e.getField(Ie.r.INSTANCEMODELORIGINLO,Ke.xs),this.model=e.getField(Ie.r.INSTANCEMODEL,Ke.jZ),this.modelNormal=e.getField(Ie.r.INSTANCEMODELNORMAL,Ke.jZ),this.featureAttribute=e.getField(Ie.r.INSTANCEFEATUREATTRIBUTE,Ke.Eq),this.color=e.getField(Ie.r.INSTANCECOLOR,Ke.XP),this.objectAndLayerIdColor=e.getField(Ie.r.INSTANCEOBJECTANDLAYERIDCOLOR,Ke.XP)}}class nt{constructor(e,t){this._rctx=e,this._instanceBufferLayout=t,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){(0,Xe.vA)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,Xe.vA)(this._updating,"not updating"),this.size<g.$U*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,Xe.vA)(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),(0,Xe.vA)(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){(0,Xe.vA)(this._updating,"not updating"),(0,Xe.vA)(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(at,Math.floor(this._capacity*g.Ji));this._resize(e)}_shrink(){const e=Math.max(at,Math.floor(this._capacity*g.He));this._resize(e)}_resize(e){if((0,Xe.vA)(this._updating,"not updating"),e===this._capacity)return;const t=new it(this._rctx,this._instanceBufferLayout.stride,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,r=this._compactInstances(t);(0,Xe.vA)(r===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=r,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new st(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const t=this._headIndex,r=this._tailIndex;return r<t?(this._buffer.copyRange(r,t,e),t-r):r>t?(this._buffer.copyRange(r,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-r),t+(this._capacity-r)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const at=64;var ot;!function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"}(ot||(ot={}));class lt{constructor(e){this.localTransform=e.getField(Ie.r.LOCALTRANSFORM,Ke.E$),this.globalTransform=e.getField(Ie.r.GLOBALTRANSFORM,Ke.E$),this.modelOrigin=e.getField(Ie.r.MODELORIGIN,Ke.Xm),this.model=e.getField(Ie.r.INSTANCEMODEL,Ke.jZ),this.modelNormal=e.getField(Ie.r.INSTANCEMODELNORMAL,Ke.jZ),this.modelScaleFactors=e.getField(Ie.r.MODELSCALEFACTORS,Ke.gH),this.boundingSphere=e.getField(Ie.r.BOUNDINGSPHERE,Ke.Aj),this.featureAttribute=e.getField(Ie.r.FEATUREATTRIBUTE,Ke.Eq),this.color=e.getField(Ie.r.COLOR,Ke.XP),this.objectAndLayerIdColor=e.getField(Ie.r.OBJECTANDLAYERIDCOLOR,Ke.XP),this.state=e.getField(Ie.r.STATE,Ke.SL),this.lodLevel=e.getField(Ie.r.LODLEVEL,Ke.SL)}}let ct=class extends m.A{constructor(e,t){super(e),this.events=new s.A,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=function(e){let t=(0,Fe.BP)().mat4f64(Ie.r.LOCALTRANSFORM).mat4f64(Ie.r.GLOBALTRANSFORM).vec4f64(Ie.r.BOUNDINGSPHERE).vec3f64(Ie.r.MODELORIGIN).mat3f(Ie.r.INSTANCEMODEL).mat3f(Ie.r.INSTANCEMODELNORMAL).vec2f(Ie.r.MODELSCALEFACTORS);return e.includes(Ie.r.FEATUREATTRIBUTE)&&(t=t.vec4f(Ie.r.FEATUREATTRIBUTE)),e.includes(Ie.r.COLOR)&&(t=t.vec4u8(Ie.r.COLOR)),e.includes(Ie.r.OBJECTANDLAYERIDCOLOR)&&(t=t.vec4u8(Ie.r.OBJECTANDLAYERIDCOLOR)),t=t.u8(Ie.r.STATE).u8(Ie.r.LODLEVEL),t}(t),this._capacity=at,this._buffer=this._layout.createBuffer(this._capacity),this._view=new lt(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,ot.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const t=this._view.state;(0,Xe.vA)(e>=0&&e<this._capacity&&!!(t.get(e)&ot.ALLOCATED),"invalid instance handle"),this._getStateFlag(e,ot.ACTIVE)?this._setStateFlags(e,ot.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;(0,Xe.vA)(e>=0&&e<this._capacity&&!!(t.get(e)&ot.ALLOCATED),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,r=!0){this._view.localTransform.setMat(e,t),r&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,r=!0){this._view.globalTransform.setMat(e,t),r&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,r=ht,i=dt;t.localTransform.getMat(e,ut),t.globalTransform.getMat(e,ft);const s=(0,Pe.lw)(ft,ft,ut);(0,Ee.i)(r,s[12],s[13],s[14]),t.modelOrigin.setVec(e,r),(0,Je.z0)(i,s),t.model.setMat(e,i);const n=(0,et.wp)(ht,s);n.sort(),t.modelScaleFactors.set(e,0,n[1]),t.modelScaleFactors.set(e,1,n[2]),(0,Je.B8)(i,i),(0,Je.mg)(i,i),t.modelNormal.setMat(e,i),this._setStateFlags(e,ot.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const r=this._view;r.model.getMat(e,dt),r.modelOrigin.getVec(e,ht),t[0]=dt[0],t[1]=dt[1],t[2]=dt[2],t[3]=0,t[4]=dt[3],t[5]=dt[4],t[6]=dt[5],t[7]=0,t[8]=dt[6],t[9]=dt[7],t[10]=dt[8],t[11]=0,t[12]=ht[0],t[13]=ht[1],t[14]=ht[2],t[15]=1}applyShaderTransformation(e,t){null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),null!=this.shaderTransformation&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(ht,this,e),t*=Math.max(ht[0],ht[1],ht[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);return null!=this.shaderTransformation&&(this.shaderTransformation.scaleFactor(ht,this,e),t*=function(e,t,r){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),r))}(ht[0],ht[1],ht[2])),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,ot.VISIBLE,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,ot.VISIBLE)}setHighlight(e,t){const{_highlightOptionsMap:r}=this,i=r.get(e);t?t!==i&&(r.set(e,t),this._setStateFlag(e,ot.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):i&&(r.delete(e),this._setStateFlag(e,ot.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(e){return this._getStateFlag(e,ot.HIGHLIGHT)}geHighlightOptionsPrev(e){const t=this._highlightOptionsMapPrev.get(e)??null;return this._highlightOptionsMapPrev.delete(e),t}getHighlightName(e){const t=this.highlightOptionsMap.get(e)??null;return t?this._highlightOptionsMapPrev.set(e,t):this._highlightOptionsMapPrev.delete(e),t}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let r=0;r<this._capacity;++r)this.getState(r)&e&&++t;return t}_setStateFlags(e,t){const r=this._view.state;t=r.get(e)|t,r.set(e,t)}_clearStateFlags(e,t){const r=this._view.state;t=r.get(e)&~t,r.set(e,t)}_setStateFlag(e,t,r){r?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max(at,Math.floor(this._capacity*g.Ji)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new lt(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&ot.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};(0,i._)([(0,o.MZ)({constructOnly:!0})],ct.prototype,"shaderTransformation",void 0),(0,i._)([(0,o.MZ)()],ct.prototype,"_size",void 0),(0,i._)([(0,o.MZ)({readOnly:!0})],ct.prototype,"size",null),ct=(0,i._)([(0,h.$)("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],ct);const ht=(0,j.vt)(),dt=(0,Qe.vt)(),ut=(0,Ce.vt)(),ft=(0,Ce.vt)();var pt=r(97937);class _t extends $e.A{constructor(e,t){super((e=>(0,pt.w)(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere))),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=(0,pt.c)(),this._tmpMat4=(0,Ce.vt)()}addInstance(e){const t=this._instanceData.view.boundingSphere,r=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);(0,Ee.t)((0,pt.a)(this._tmpSphere),this._boundingSphere.center,r),this._tmpSphere[3]=this._boundingSphere.radius*(0,et.hG)(r),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class mt{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,r){const i=r.computeScreenPixelSizeAt(e),s=this._worldSpaceRadius*t/i;let n=0;for(let e=1;e<this._minScreenSpaceRadii.length;++e)s>=this._minScreenSpaceRadii[e]&&(n=e);return n}}var gt=r(42293);const yt=()=>c.A.getLogger("esri.views.webgl.VertexArrayObject");let vt=class{constructor(e,t,r,i,s=null){this._context=e,this._locations=t,this._layout=r,this._buffers=i,this._indexBuffer=s,this._glName=null,this._initialized=!1}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get byteSize(){return Array.from(this._buffers.values()).reduce(((e,t)=>e+t.usedMemory),null!=this._indexBuffer?this._indexBuffer.usedMemory:0)}get layout(){return this._layout}get locations(){return this._locations}get usedMemory(){return this.byteSize+(this._buffers.size+(this._indexBuffer?1:0))*R.i5}get cachedMemory(){return this.usedMemory}dispose(){this._context?(this._context.getBoundVAO()===this&&this._context.bindVAO(null),this._buffers.forEach((e=>e.dispose())),this._buffers.clear(),this._indexBuffer=(0,re.WD)(this._indexBuffer),this.disposeVAOOnly()):(this._glName||this._buffers.size>0)&&yt().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(rt.vt.VertexArrayObject,this)),this._context=null}initialize(){if(this._initialized)return;const{gl:e}=this._context,t=e.createVertexArray();e.bindVertexArray(t),this._bindLayout(),e.bindVertexArray(null),this._glName=t,this._context.instanceCounter.increment(rt.vt.VertexArrayObject,this),this._initialized=!0}bind(){this.initialize(),this._context.gl.bindVertexArray(this.glName)}_bindLayout(){const{_buffers:e,_layout:t,_indexBuffer:r}=this;e||yt().error("Vertex buffer dictionary is empty!");const i=this._context.gl;this._buffers.forEach(((e,r)=>{const i=t.get(r);i?(0,gt.yu)(this._context,this._locations,e,i):yt().error("Vertex element descriptor is empty!")})),null!=r&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,r.glName)}unbind(){this.initialize(),this._context.gl.bindVertexArray(null)}};class xt extends vt{}class bt{constructor(e,t){const r=e.renderContext.rctx,i=t.geometry,s=t.geometry.getRenderGeometry(),n=s.material;this._materials=e.materials,n.setParameters({instancedDoublePrecision:!0}),this.geometry=i,this.material=n,this.glMaterials=new ve(n,this._materials),this.vertexBufferLayout=s.vertexBufferLayout,this.vbo=tt.g.createVertex(r,rt._U.STATIC_DRAW,s.buffer),this.vao=new xt(r,Ze.D,new Map([["geometry",(0,ue.U)(s.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=s.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,r,i,s,n,a,o){return this.geometry.intersect(e,t,r,i,s,n,a,o)}}class wt{static async create(e,t,r){const i=await Promise.allSettled(t.components.map((t=>e.controller.schedule((()=>new bt(e,t)),r)))),s=i.map((e=>"fulfilled"===e.status?e.value:null)).filter(g.Ru);if((0,n.G4)(r)||s.length!==i.length){s.forEach((e=>e.destroy())),(0,n.Te)(r);for(const e of i)if("rejected"===e.status)throw e.reason}return new wt(t.minScreenSpaceRadius,s)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach((e=>e.destroy()))}intersect(e,t,r,i,s,n,a){this.components.forEach((o=>o.intersect(e,t,r,i,s,n,this.boundingSphere,a)))}get boundingBox(){if(null==this._boundingBox){const e=(0,U.Ie)();this.components.forEach((t=>{null!=t.boundingInfo&&((0,U.iT)(e,t.boundingInfo.bbMin),(0,U.iT)(e,t.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const e=this.boundingBox,t=(0,j.vt)();(0,U.gX)(e,t),this._boundingSphere={center:t,radius:.5*(0,U._F)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}var Tt=r(43616),At=r(28449);const St=(0,j.vt)(),Rt=new Float32Array(6);var Ot=r(97225),It=r(68197);new It.A("cyan"),new It.A("black");const Mt="default";new It.A("yellow");var Ct=r(63076);let Et=class extends ge{constructor(e,t){super(e),this.type=Ye.dz.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new He,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[xe.N.OPAQUE_MATERIAL,e=>this._produces(e)],[xe.N.TRANSPARENT_MATERIAL,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new ct({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(Ct.W6.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=function(e){let t=(0,Fe.BP)().vec3f(Ie.r.INSTANCEMODELORIGINHI).vec3f(Ie.r.INSTANCEMODELORIGINLO).mat3f(Ie.r.INSTANCEMODEL).mat3f(Ie.r.INSTANCEMODELNORMAL);return null!=e&&e.includes("featureAttribute")&&(t=t.vec4f(Ie.r.INSTANCEFEATUREATTRIBUTE)),null!=e&&e.includes("color")&&(t=t.vec4u8(Ie.r.INSTANCECOLOR)),null!=e&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(Ie.r.INSTANCEOBJECTANDLAYERIDCOLOR)),t}(this.optionalFields),this._glInstanceBufferLayout=(0,ue.U)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",(()=>this._requestUpdateCycle())),this._instanceData.events.on("instance-transform-changed",(({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)})),this._instanceData.events.on("instance-visibility-changed",(({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)})),this._instanceData.events.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0)))])}get _allRenderInstanceData(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)e.push(t[1]);return e}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)t[0]!==Mt&&e.push(t[1]);return e}hasHighlightOptions(e){return this._highlightRenderInstanceDataMap.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some((e=>e.components.some((e=>e.material.hasEmissions))))}get usedMemory(){return this._allRenderInstanceData.reduce(((e,t)=>t.reduce(((e,t)=>e+t.usedMemory),e)),this._levels.reduce(((e,t)=>e+t.components.reduce(((e,t)=>e+t.usedMemory),0)),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,r)=>{const i=this._allRenderInstanceData[0][r].size+this._allRenderInstanceData[1][r].size,s=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*s,trianglesPerInstance:s})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}_createRenderInstanceDataArray(e=[]){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map((r=>{e.push(new nt(t,this._instanceBufferLayout))})),e}async initializeRenderContext(e,t){this._context=e,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const r=await Promise.allSettled(this.symbol.levels.map((r=>wt.create(e,r,t)))),i=r.map((e=>"fulfilled"===e.status?e.value:null)).filter(g.Ru);if((0,n.G4)(t)||i.length!==r.length){i.forEach((e=>e.destroy())),(0,n.Te)(t);for(const e of r)if("rejected"===e.status)throw e.reason}this._levels=i,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,r=e.levels.map((e=>e.minScreenSpaceRadius));return new mt(t,r)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceDataMap.forEach((e=>e.forEach((e=>e.destroy()))))}_hasTransparentLevels(){return this._levels.some((e=>e.components.some((e=>{const t=e.material.produces.get(xe.N.TRANSPARENT_MATERIAL);return t?.(fe.V.Color)}))))}hasHighlights(){return(0,Me.Bs)(this._highlightRenderInstanceDataMap,(e=>e.some((e=>e.size>0))))}_produces(e){return(e!==fe.V.Highlight||this.hasHighlights())&&(e!==fe.V.ShadowHighlight||this.hasHighlightOptions(Mt))}prepareRender(e){if(!oe.b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Ct.Bb),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const r=new Array,i=this.levels;return t.forEach((t=>i.forEach((({components:i},s)=>i.forEach((i=>r.push(this._beginComponent(e,t[s],i)))))))),r}render(e,t){const r=this._getInstanceDatas(e);if(!r||null==t)return;let i=0;e.rctx.bindVAO();const s=this.levels;r.forEach((r=>s.forEach((({components:s},n)=>s.forEach((s=>this._renderComponent(e,t[i++],r[n],s,n)))))))}_getInstanceDatas(e){const{output:t,bind:r}=e,i=t===fe.V.Highlight,s=t===fe.V.ShadowHighlight,n=!i&&!s,a=t!==fe.V.ShadowExcludeHighlight;if(n)return a?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;if(a){if(i){const e=r.highlight?.name;if(!e)return null;const t=this._highlightRenderInstanceDataMap.get(e);return t?[t]:null}const e=this._highlightRenderInstanceDataMap.get(Mt);return s?e?[e]:null:Array.from(this._highlightRenderInstanceDataMap.values())}return null}intersect(e,t,r,i){if(!this.baseMaterial.visible||null==this._octree)return;const s=(0,j.vt)();(0,Ee.d)(s,i,r);const n=s=>{this._instanceData.getCombinedModelTransform(s,Lt),e.transform.set(Lt),(0,Ee.t)(Nt,r,e.transform.inverse),(0,Ee.t)(zt,i,e.transform.inverse);const n=this._instanceData.getState(s),a=this._instanceData.getLodLevel(s),o=this._levels.length;(0,Xe.vA)(!!(n&ot.ACTIVE),"invalid instance state"),(0,Xe.vA)(a>=0&&a<o,"invaid lod level"),this._levels[a].intersect(e,t,Nt,zt,s,this.metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(n):this._octree.forEachAlongRay(r,s,n)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){const e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new _t(e,this.baseBoundingSphere);for(let r=0;r<e.capacity;++r)t.get(r)&ot.ACTIVE&&this._octreeCached.addInstance(r)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,re.pR)(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return new We;const t=e.viewForward,r=this._octree.findClosest(t,$e.A.DepthOrder.FRONT_TO_BACK,e.frustum),i=this._octree.findClosest(t,$e.A.DepthOrder.BACK_TO_FRONT,e.frustum);if(null==r||null==i)return new We;const s=e.eye,n=this._instanceData.view;n.boundingSphere.getVec(r,Pt),(0,Ee.d)(Pt,Pt,s);const a=(0,Ee.f)(Pt,t)-Pt[3];n.boundingSphere.getVec(i,Pt),(0,Ee.d)(Pt,Pt,s);const o=(0,Ee.f)(Pt,t)+Pt[3];return new We(a,o)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.startUpdateCycle()))))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:r,_levelSelector:i}=this;this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.beginUpdate()))));const s=this._instanceData,n=s.view;let a=s.size;const o=s.capacity;let l=this._instanceIndex;const c=Math.ceil(o/500);for(let h=0;h<a&&!e.done;++h){l===this._cycleStartIndex&&this._startUpdateCycle();const h=n.state.get(l);let d=0;if(!(h&ot.ALLOCATED)){l=l+1===o?0:l+1,a++;continue}const u=n.lodLevel.get(l);if(h&ot.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[u].freeTail(),h&ot.HIGHLIGHT_ACTIVE){const e=s.geHighlightOptionsPrev(l);if(e){const t=this._highlightRenderInstanceDataMap.get(e);if(!t)throw new V.A("Internal error in lodRenderer");t[u].freeTail()}}if(h&ot.REMOVE)s.freeInstance(l);else if(h&ot.VISIBLE){let e=0;if(t&&(n.modelOrigin.getVec(l,Dt),e=i.selectLevel(Dt,s.getCombinedMedianScaleFactor(l),r)),d=h&~(ot.ACTIVE|ot.TRANSFORM_CHANGED),e>=0)if(h&ot.HIGHLIGHT){const t=s.getHighlightName(l);if(t){const r=()=>{const e=this._createRenderInstanceDataArray();return e.forEach((e=>e.beginUpdate())),e},i=(0,Me.tE)(this._highlightRenderInstanceDataMap,t,r);if(e>=i.length)throw new V.A(`LodRenderer internal error - missing lodLevel ${e}`);Ft(i[e],n,l)}d|=ot.HIGHLIGHT_ACTIVE}else Ft(this._defaultRenderInstanceData[e],n,l),d|=ot.DEFAULT_ACTIVE;n.state.set(l,d),n.lodLevel.set(l,e)}else d=h&~(ot.ACTIVE|ot.TRANSFORM_CHANGED),n.state.set(l,d);if(null!=this._octreeCached){const e=!!(h&ot.ACTIVE),t=!!(d&ot.ACTIVE);!e&&t?this._octreeCached.addInstance(l):e&&!t?this._octreeCached.removeInstance(l):e&&t&&h&ot.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))}l=l+1===o?0:l+1,l%c==0&&e.madeProgress()}this._instanceIndex=l,this._allRenderInstanceData.forEach((e=>e.forEach((e=>e.endUpdate())))),this._context.requestRender()}_beginComponent(e,t,r){if(0===t.size)return null;const i=r.glMaterials.load(e.rctx,e.bind.slot,e.output);return i?.beginSlot(e.bind)}_renderComponent(e,t,r,i,s){if(!t)return;const{bind:n,rctx:a}=e;a.runAppleAmdDriverHelper();const o=a.bindTechnique(t,n,i.material.parameters,Vt);a.bindVAO(i.vao),t.ensureAttributeLocations(i.vao),oe.b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===fe.V.Color&&(o.setUniform4fv("externalColor",Bt[Math.min(s,Bt.length-1)]),o.setUniform1i("colorMixMode",Tt.Um.replace));const l=r.capacity,c=r.headIndex,h=r.tailIndex,d=r.firstIndex,u=this._glInstanceBufferLayout,f=(e,s)=>{(0,gt.yu)(a,Ze.D,r.buffer,u,e),a.drawArraysInstanced(t.primitiveType,0,i.vertexCount,s-e),(0,gt.Hi)(a,Ze.D,r.buffer,u)};i.material.parameters.transparent&&null!=d?c>h?((0,Xe.vA)(d>=h&&d<=c,"invalid firstIndex"),f(d,c),f(h,d)):c<h&&(d<=c?((0,Xe.vA)(d>=0&&d<=c,"invalid firstIndex"),f(d,c),f(h,l),f(0,d)):((0,Xe.vA)(d>=h&&d<=l,"invalid firstIndex"),f(d,l),f(0,c),f(h,d))):c>h?f(h,c):c<h&&(f(0,c),f(h,l)),a.bindVAO(null)}};function Ft(e,t,r){const i=e.allocateHead();!function(e,t,r,i){(function(e,t,r,i,s){St[0]=e.get(t,0),St[1]=e.get(t,1),St[2]=e.get(t,2),(0,At.jS)(St,Rt,3),r.set(s,0,Rt[0]),i.set(s,0,Rt[1]),r.set(s,1,Rt[2]),i.set(s,1,Rt[3]),r.set(s,2,Rt[4]),i.set(s,2,Rt[5])})(e.modelOrigin,t,r.modelOriginHi,r.modelOriginLo,i),r.model.copyFrom(i,e.model,t),r.modelNormal.copyFrom(i,e.modelNormal,t),e.color&&r.color&&r.color.copyFrom(i,e.color,t),e.objectAndLayerIdColor&&r.objectAndLayerIdColor&&r.objectAndLayerIdColor.copyFrom(i,e.objectAndLayerIdColor,t),e.featureAttribute&&r.featureAttribute&&r.featureAttribute.copyFrom(i,e.featureAttribute,t)}(t,r,e.view,i)}(0,i._)([(0,o.MZ)({constructOnly:!0})],Et.prototype,"symbol",void 0),(0,i._)([(0,o.MZ)({constructOnly:!0})],Et.prototype,"optionalFields",void 0),(0,i._)([(0,o.MZ)({constructOnly:!0})],Et.prototype,"metadata",void 0),(0,i._)([(0,o.MZ)({constructOnly:!0})],Et.prototype,"shaderTransformation",void 0),(0,i._)([(0,o.MZ)()],Et.prototype,"_instanceData",void 0),(0,i._)([(0,o.MZ)()],Et.prototype,"_cycleStartIndex",void 0),(0,i._)([(0,o.MZ)({readOnly:!0})],Et.prototype,"_enableLevelSelection",null),(0,i._)([(0,o.MZ)()],Et.prototype,"_updateCyclesWithStaticCamera",void 0),(0,i._)([(0,o.MZ)({readOnly:!0})],Et.prototype,"running",null),Et=(0,i._)([(0,h.$)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],Et);const Dt=(0,j.vt)(),Pt=(0,ie.vt)(),Lt=(0,Ce.vt)(),Nt=(0,j.vt)(),zt=(0,j.vt)(),Bt=[(0,ie.fA)(1,0,1,1),(0,ie.fA)(0,0,1,1),(0,ie.fA)(0,1,0,1),(0,ie.fA)(1,1,0,1),(0,ie.fA)(1,0,0,1)],Vt=new Ot.V;r(65215);var Ht=r(86305);r(16396);class jt{get ray(){return this._ray}get distanceInRenderSpace(){return null!=this.dist?((0,Ee.h)(Ut,this.ray.direction,this.dist),(0,Ee.l)(Ut)):null}withinDistance(e){return!!(0,Ht.i3)(this)&&this.distanceInRenderSpace<=e}getIntersectionPoint(e){return!!(0,Ht.i3)(this)&&((0,Ee.h)(Ut,this.ray.direction,this.dist),(0,Ee.g)(e,this.ray.origin,Ut),!0)}getTransformedNormal(e){return(0,Ee.c)(Gt,this.normal),Gt[3]=0,(0,Le.t)(Gt,Gt,this.transformation),(0,Ee.c)(e,Gt),(0,Ee.n)(e,e)}constructor(e){this.intersector=Ye.dz.OBJECT,this.normal=(0,j.vt)(),this.transformation=(0,Ce.vt)(),this._ray=(0,ze.vt)(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=Ye.dz.OBJECT,(0,ze.C)(e,this._ray)}set(e,t,r,i,s,n,a){this.intersector=e,this.dist=r,(0,Ee.c)(this.normal,i??j.Cb),(0,Pe.C)(this.transformation,s??Ce.zK),this.target=t,this.drapedLayerOrder=n,this.drapedLayerGraphicOrder=a}copy(e){(0,ze.C)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,Ee.c)(this.normal,e.normal),(0,Pe.C)(this.transformation,e.transformation)}}const Ut=(0,j.vt)(),Gt=(0,ie.vt)();var kt=r(87582);class qt{constructor(e,t,r,i){this.material=e,this.bufferWriter=e.createBufferWriter(),this.vertexBufferLayout=this.bufferWriter.vertexBufferLayout,this.buffer=t,this.elementCount=r,this.boundingInfo=i}get numTriangles(){return this.elementCount/3}get numVertices(){return this.elementCount}computeUsedMemory(){return this.buffer.byteLength+R.i5}getRenderGeometry(){return this}intersect(e,t,r,i,s,n,a,o){const l=this.bufferWriter,c=this.buffer;l.intersect(c,e,r,i,((r,i,l,c,h)=>function(e,t,r,i,s,n,a,o,l,c){if(e<0)return;if(n&&!n(s.rayBegin,s.rayEnd,e))return;const h=new kt.h(a.layerUid,a.graphicUid(l),r,o,c);if((null==s.results.min.drapedLayerOrder||i>=s.results.min.drapedLayerOrder)&&(null==s.results.min.dist||e<s.results.min.dist)&&s.results.min.set(Ye.dz.LOD,h,e,t,s.transform.transform,i),s.options.store!==Ye.oH.MIN&&(null==s.results.max.drapedLayerOrder||i>=s.results.max.drapedLayerOrder)&&(null==s.results.max.dist||e>s.results.max.dist)&&s.results.max.set(Ye.dz.LOD,h,e,t,s.transform.transform,i),s.options.store===Ye.oH.ALL){const r=function(e){return new jt(e)}(s.results.min.ray);r.set(Ye.dz.LOD,h,e,t,s.transform.transform,i),s.results.all.push(r)}}(r,i,l,h,e,t,n,a,s,o)))}}class Zt{constructor(e,t=null){this.geometry=e,this.textures=t}get material(){return this.geometry.material}get numTriangles(){return this.geometry.numTriangles}}class Wt{constructor(e,t,r){this.components=e,this.minScreenSpaceRadius=t,this.pivotOffset=r;const i=(0,g.Am)(this.components.map((e=>e.geometry)));this.numVertices=i.reduce(((e,t)=>e+t.numVertices),0)}}class Yt{constructor(e){this.levels=e,this.levels.sort(((e,t)=>e.minScreenSpaceRadius===t.minScreenSpaceRadius?e.numVertices-t.numVertices:e.minScreenSpaceRadius-t.minScreenSpaceRadius))}getMaterials(){const e=[];return this.levels.forEach((t=>t.components.forEach((t=>e.push(t.geometry.material))))),(0,g.Am)(e)}getTextures(){const e=new Array;return this.levels.forEach((t=>t.components.forEach((t=>{null!=t.textures&&e.push(...t.textures)})))),(0,g.Am)(e)}getGeometries(){const e=new Array;return this.levels.forEach((t=>t.components.forEach((t=>{e.push(t.geometry)})))),(0,g.Am)(e)}getEngineGeometries(){return this.getGeometries().map((e=>e.engineGeometry)).filter((e=>null!=e))}computeUsedMemory(){const e=this.getGeometries(),t=this.getTextures(),r=e.reduce(((e,t)=>e+t.computeUsedMemory()),0);return t.reduce(((e,t)=>e+t.memoryEstimate),0)+r}}let $t=class{constructor(e){this._optionalFields=new Array,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=e.layerUid,this.view=e.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._featureIdToInstanceIndex.size}get usedMemory(){const e=this._lodRendererResources?.lodRenderer,t=e?.symbol;return(t?.computeUsedMemory()??0)+16*this._featureIdToInstanceIndex.size}destroy(){this._disposeResourceHandles.forEach((e=>e()))}async doLoad(e,t,r){(0,l.A)("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(Ie.r.OBJECTANDLAYERIDCOLOR);const i=function(e,t){const r=t.levels.map((t=>{const r=t.components.map((t=>{const r=e(t.materialId);if(!function(e){return null!=e&&"materialType"in e&&"default"===e.materialType}(r))throw new Error("LodRenderer only supports DefaultMaterial");const i=new qt(r,t.renderGeometryBuffer.data,t.renderGeometryBuffer.elementCount,t.boundingInfo);return new Zt(i)}));return new Wt(r,t.minScreenSpaceRadius)}));return new Yt(r)}((e=>t(e)),e),s=this.view._stage,a=i.getMaterials();s.addMany(a),this._addDisposeResource((()=>s.removeMany(a)));const o=i.getTextures();s.addMany(o),this._addDisposeResource((()=>{o.forEach((e=>e.unload())),s.removeMany(o)})),await Promise.all(o.map((e=>this.view._stage.schedule((()=>e.load(s.renderView.renderingContext)),r)))),(0,n.Te)(r);const c=await this._createLodRenderer(i,r);this._lodRendererResources={lodRenderer:c,materials:a,textures:o}}addInstances(e){const t=this._lodRendererResources;if(null==t)return;const{featureIds:r,localTransforms:i,globalTransforms:s}=e,n=t.lodRenderer;if(null==n)return;const a=n.instanceData,o=r.length;for(let e=0;e<o;++e){const t=r[e],n=a.addInstance(),o=a.view,l=16*e;o.localTransform.copyFromTypedBuffer(n,i,l),o.globalTransform.copyFromTypedBuffer(n,s,l),a.updateModelTransform(n),a.setVisible(n,!0),this._featureIdToInstanceIndex.set(t,n)}}removeInstances(e){const t=this._lodRendererResources;if(null==t)return;const r=t.lodRenderer.instanceData,i=this._featureIdToInstanceIndex,s=e.length;for(let t=0;t<s;++t){const s=e[t],n=i.get(s);null!=n&&(r.removeInstance(n),i.delete(s))}}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createLodRenderer(e,t){const r=this.view._stage,i={layerUid:this.layerUid,graphicUid:e=>1,notifyGraphicGeometryChanged:e=>1,notifyGraphicVisibilityChanged:e=>1},s=new Et({symbol:e,optionalFields:this._optionalFields,metadata:i,shaderTransformation:null},this.scheduler);return s.slicePlaneEnabled=!1,this._addDisposeResource((()=>{r.removeRenderPlugin(s),s.destroy()})),await r.addRenderPlugin(s,t),s}};$t=(0,i._)([(0,h.$)("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],$t);var Xt=r(40804),Jt=r(48833);const Qt=(0,ie.CN)(.25,.25,.75,.75);function Kt(e,t,r){return r&&(t/=Math.SQRT2),ir(e,((i,s)=>{let n=i-.5*e+.25,a=.5*e-s-.75;if(r){const e=(n+a)/Math.SQRT2;a=(a-n)/Math.SQRT2,n=e}return Math.max(Math.abs(n),Math.abs(a))-.5*t}))}function er(e,t,r,i=0){t-=i,r&&(t*=Math.SQRT2);const s=.5*t;return ir(e,((t,n)=>{let a,o=t-.5*e,l=.5*e-n-1;if(r){const e=(o+l)/Math.SQRT2;l=(l-o)/Math.SQRT2,o=e}return o=Math.abs(o),l=Math.abs(l),a=o>l?o>s?Math.sqrt((o-s)*(o-s)+l*l):l:l>s?Math.sqrt(o*o+(l-s)*(l-s)):o,a-=i/2,a}))}function tr(e,t,r){return(i,s)=>{const n=i-e,a=s-t;return Math.sqrt(n*n+a*a)-r}}function rr(e,t,r){const i=Math.sqrt(t*t+r*r);return(s,n)=>{const a=Math.abs(s-e)-r,o=n-e+t/2+.75,l=(t*a+r*o)/i,c=-o;return Math.max(l,c)}}function ir(e,t){const r=new Uint8Array(4*e*e);for(let i=0;i<e;i++)for(let s=0;s<e;s++){const n=s+e*i;let a=t(s,i);a=a/e+.5,(0,Xt.U)(a,r,4*n)}return r}var sr=r(11787);var nr=r(78662),ar=r(40268),or=r(16943),lr=r(25634),cr=r(11725),hr=r(77194);class dr{constructor(){this.scale=0,this.factor=0,this.minScaleFactor=0}}var ur=r(59907),fr=r(13259),pr=r(97220),_r=r(98958),mr=r(59643),gr=r(33524),yr=r(90644);class vr extends _r.w{constructor(e,t){super(e,t,new pr.$(fr.H,(()=>r.e(8241).then(r.bind(r,48241))))),this.primitiveType=t.occlusionPass?rt.WR.POINTS:rt.WR.TRIANGLES}initializePipeline(e){const{oitPass:t,hasPolygonOffset:r,draped:i,output:s,depthTestEnabled:n,occlusionPass:a}=e,o=t===mr.Y.NONE,l=t===mr.Y.ColorAlpha,c=s===fe.V.Highlight,h=n&&!i&&!l&&!a&&!c;return(0,yr.Ey)({blending:(0,fe.RN)(s)?o?yr.Os:(0,gr.ez)(t):null,depthTest:n&&!i?{func:rt.MT.LEQUAL}:null,depthWrite:h?yr.Uy:null,drawBuffers:(0,gr.m6)(t,s),colorWrite:yr.kn,polygonOffset:r?xr:null})}}const xr={factor:0,units:-4};var br=r(53466),wr=r(22911),Tr=r(51976),Ar=r(35256);class Sr extends Ar.E{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hasRotation=!1,this.debugDrawLabelBorder=!1,this.hasPolygonOffset=!1,this.depthTestEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.occlusionPass=!1,this.occludedFragmentFade=!1,this.objectAndLayerIdColorInstanced=!1,this.horizonCullingEnabled=!0,this.isFocused=!0,this.textureCoordinateType=br.I.None,this.emissionSource=wr.ZX.None,this.discardInvisibleFragments=!0,this.hasVvInstancing=!1}}(0,i._)([(0,Tr.W)()],Sr.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"occlusionTestEnabled",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"signedDistanceFieldEnabled",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"sampleSignedDistanceFieldTexelCenter",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"vvSize",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"vvColor",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"hasVerticalOffset",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"hasScreenSizePerspective",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"hasRotation",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"debugDrawLabelBorder",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"hasPolygonOffset",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"depthTestEnabled",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"pixelSnappingEnabled",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"draped",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"terrainDepthTest",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"cullAboveTerrain",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"occlusionPass",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"occludedFragmentFade",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"objectAndLayerIdColorInstanced",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"horizonCullingEnabled",void 0),(0,i._)([(0,Tr.W)()],Sr.prototype,"isFocused",void 0);var Rr=r(49788);class Or extends cr.im{constructor(e,t){super(e,Xr),this.produces=new Map([[xe.N.HUD_MATERIAL,e=>(0,fe.Mb)(e)&&!this.parameters.drawAsLabel],[xe.N.LABEL_MATERIAL,e=>(0,fe.Mb)(e)&&this.parameters.drawAsLabel],[xe.N.OCCLUSION_PIXELS,()=>this.parameters.occlusionTest],[xe.N.DRAPED_MATERIAL,e=>this.parameters.draped&&(0,fe.Mb)(e)]]),this._visible=!0,this._configuration=new Sr(t)}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.draped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.sampleSignedDistanceFieldTexelCenter=this.parameters.sampleSignedDistanceFieldTexelCenter,this._configuration.hasRotation=this.parameters.hasRotation,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=t.slot===xe.N.OCCLUSION_PIXELS,this._configuration.occludedFragmentFade=this.parameters.occludedFragmentFade,this._configuration.horizonCullingEnabled=this.parameters.horizonCullingEnabled,this._configuration.isFocused=this.parameters.isFocused,this._configuration.depthTestEnabled=this.parameters.depthEnabled||t.slot===xe.N.OCCLUSION_PIXELS,(0,fe.RN)(e)&&(this._configuration.debugDrawLabelBorder=!!oe.b.LABELS_SHOW_BORDER),this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}intersect(e,t,r,i,s,n){const{options:{selectionMode:a,hud:o,excludeLabels:l},point:c,camera:h}=r,{parameters:d}=this;if(!a||!o||l&&d.isLabel||!e.visible||!c)return;const{scaleX:u,scaleY:f}=this._getScreenScale(e,h.pixelRatio);(0,Je.z0)(Vr,t),e.attributes.has(Ie.r.FEATUREATTRIBUTE)&&function(e){const t=e[0],r=e[1],i=e[2],s=e[3],n=e[4],a=e[5],o=e[6],l=e[7],c=e[8],h=1/Math.sqrt(t*t+r*r+i*i),d=1/Math.sqrt(s*s+n*n+a*a),u=1/Math.sqrt(o*o+l*l+c*c);e[0]=t*h,e[1]=r*h,e[2]=i*h,e[3]=s*d,e[4]=n*d,e[5]=a*d,e[6]=o*u,e[7]=l*u,e[8]=c*u}(Vr);const p=e.attributes.get(Ie.r.POSITION),_=e.attributes.get(Ie.r.SIZE),m=e.attributes.get(Ie.r.NORMAL),g=e.attributes.get(Ie.r.ROTATION),y=e.attributes.get(Ie.r.CENTEROFFSETANDDISTANCE);(0,Xe.vA)(p.size>=3);const v=(0,fr.c)(d),x="screen"===this.parameters.centerOffsetUnits;for(let e=0;e<p.data.length/p.size;e++){const i=e*p.size;(0,Ee.i)(Fr,p.data[i],p.data[i+1],p.data[i+2]),(0,Ee.t)(Fr,Fr,t),(0,Ee.t)(Fr,Fr,h.viewMatrix);const s=e*y.size;if((0,Ee.i)(Ur,y.data[s],y.data[s+1],y.data[s+2]),!x&&(Fr[0]+=Ur[0],Fr[1]+=Ur[1],0!==Ur[2])){const e=Ur[2];(0,Ee.n)(Ur,Fr),(0,Ee.d)(Fr,Fr,(0,Ee.h)(Ur,Ur,e))}const a=e*m.size;if((0,Ee.i)(Dr,m.data[a],m.data[a+1],m.data[a+2]),Mr(Dr,Vr,h,qr),this._applyVerticalOffsetTransformationView(Fr,qr,h,Er),h.applyProjection(Fr,Pr),Pr[0]>-1){x&&(Ur[0]||Ur[1])&&(Pr[0]+=Ur[0]*h.pixelRatio,0!==Ur[1]&&(Pr[1]+=(0,hr.m0)(Ur[1],Er.factorAlignment)*h.pixelRatio),h.unapplyProjection(Pr,Fr)),Pr[0]+=this.parameters.screenOffset[0]*h.pixelRatio,Pr[1]+=this.parameters.screenOffset[1]*h.pixelRatio,Pr[0]=Math.floor(Pr[0]),Pr[1]=Math.floor(Pr[1]);const t=e*_.size;Yr[0]=_.data[t],Yr[1]=_.data[t+1],(0,hr.MD)(Yr,Er.factor,Yr);const i=Zr*h.pixelRatio;let s=0;d.textureIsSignedDistanceField&&(s=Math.min(d.outlineSize,.5*Yr[0])*h.pixelRatio/2),Yr[0]*=u,Yr[1]*=f;const a=e*g.size,o=d.rotation+g.data[a];if(Cr(c,Pr[0],Pr[1],Yr,i,s,o,d,v)){const e=r.ray;if((0,Ee.t)(Nr,Fr,(0,Pe.B8)(jr,h.viewMatrix)),Pr[0]=c[0],Pr[1]=c[1],h.unprojectFromRenderScreen(Pr,Fr)){const t=(0,j.vt)();(0,Ee.c)(t,e.direction);const r=1/(0,Ee.l)(t);(0,Ee.h)(t,t,r),n((0,Ee.j)(e.origin,Fr)*r,t,-1,!0,1,Nr)}}}}}intersectDraped(e,t,r,i,s,n){const a=e.attributes.get(Ie.r.POSITION),o=e.attributes.get(Ie.r.SIZE),l=e.attributes.get(Ie.r.ROTATION),c=this.parameters,h=(0,fr.c)(c),{scaleX:d,scaleY:u}=this._getScreenScale(e,e.screenToWorldRatio),f=Wr*e.screenToWorldRatio;for(let t=0;t<a.data.length/a.size;t++){const r=t*a.size,p=a.data[r],_=a.data[r+1],m=t*o.size;Yr[0]=o.data[m],Yr[1]=o.data[m+1];let g=0;c.textureIsSignedDistanceField&&(g=Math.min(c.outlineSize,.5*Yr[0])*e.screenToWorldRatio/2),Yr[0]*=d,Yr[1]*=u;const y=t*l.size,v=c.rotation+l.data[y];Cr(i,p,_,Yr,f,g,v,c,h)&&s(n.dist,n.normal,-1,!1)}}createBufferWriter(){return new Kr}_updateScaleInfo(e,t,r){const i=this.parameters;null!=i.screenSizePerspective?(0,hr.cJ)(r,t,i.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minScaleFactor=0),null!=i.screenSizePerspectiveAlignment?(0,hr.cJ)(r,t,i.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minScaleFactor=e.factor.minScaleFactor)}applyShaderOffsetsView(e,t,r,i,s,n,a){const o=Mr(t,r,s,qr);return this._applyVerticalGroundOffsetView(e,o,s,a),this._applyVerticalOffsetTransformationView(a,o,s,n),this._applyPolygonOffsetView(a,o,i[3],s,a),this._applyCenterOffsetView(a,i,a),a}applyShaderOffsetsNDC(e,t,r,i,s){return this._applyCenterOffsetNDC(e,t,r,i),null!=s&&(0,Ee.c)(s,i),this._applyPolygonOffsetNDC(i,t,r,i),i}_applyPolygonOffsetView(e,t,r,i,s){const n=i.aboveGround?1:-1;let a=Math.sign(r);0===a&&(a=n);const o=n*a;if(this.parameters.shaderPolygonOffset<=0)return(0,Ee.c)(s,e);const l=(0,ae.qE)(Math.abs(t.cosAngle),.01,1),c=1-Math.sqrt(1-l*l)/l/i.viewport[2];return(0,Ee.h)(s,e,o>0?c:1/c),s}_applyVerticalGroundOffsetView(e,t,r,i){const s=(0,Ee.l)(e),n=r.aboveGround?1:-1,a=r.computeRenderPixelSizeAtDist(s)*ar.R,o=(0,Ee.h)(Fr,t.normal,n*a);return(0,Ee.g)(i,e,o),i}_applyVerticalOffsetTransformationView(e,t,r,i){const s=this.parameters;if(!s.verticalOffset?.screenLength){if(s.screenSizePerspective||s.screenSizePerspectiveAlignment){const r=(0,Ee.l)(e);this._updateScaleInfo(i,r,t.cosAngle)}else i.factor.scale=1,i.factorAlignment.scale=1;return e}const n=(0,Ee.l)(e),a=s.screenSizePerspectiveAlignment??s.screenSizePerspective,o=(0,Tt.kE)(r,n,s.verticalOffset,t.cosAngle,a);return this._updateScaleInfo(i,n,t.cosAngle),(0,Ee.h)(t.normal,t.normal,o),(0,Ee.g)(e,e,t.normal)}_applyCenterOffsetView(e,t,r){const i="screen"!==this.parameters.centerOffsetUnits;return r!==e&&(0,Ee.c)(r,e),i&&(r[0]+=t[0],r[1]+=t[1],t[2]&&((0,Ee.n)(Dr,r),(0,Ee.g)(r,r,(0,Ee.h)(Dr,Dr,t[2])))),r}_applyCenterOffsetNDC(e,t,r,i){const s="screen"!==this.parameters.centerOffsetUnits;return i!==e&&(0,Ee.c)(i,e),s||(i[0]+=t[0]/r.fullWidth*2,i[1]+=t[1]/r.fullHeight*2),i}_applyPolygonOffsetNDC(e,t,r,i){const s=this.parameters.shaderPolygonOffset;if(e!==i&&(0,Ee.c)(i,e),s){const e=r.aboveGround?1:-1,n=e*Math.sign(t[3]);i[2]-=(n||e)*s}return i}set visible(e){this._visible=e}get visible(){const{color:e,outlineSize:t,outlineColor:r}=this.parameters,i=e[3]>=Rr.Q||t>=Rr.Q&&r[3]>=Rr.Q;return this._visible&&i}createGLMaterial(e){return new Ir(e)}calculateRelativeScreenBounds(e,t,r=(0,x.vt)()){return function(e,t,r,i){i[0]=e.anchorPosition[0]*-t[0]+e.screenOffset[0]*r,i[1]=e.anchorPosition[1]*-t[1]+e.screenOffset[1]*r}(this.parameters,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}_getScreenScale(e,t){const r=e.attributes.get(Ie.r.FEATUREATTRIBUTE);if(null==r)return{scaleX:t,scaleY:t};const i=(0,ie.ci)(r.data,kr);return(0,nr.VC)(Gr,this.parameters,i),{scaleX:Gr[0]*t,scaleY:Gr[1]*t}}}class Ir extends lr.m8{constructor(e){super({...e,...e.material.parameters})}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.getTechnique(vr,e)}}function Mr(e,t,r,i){return function(e){return(t=e)instanceof Float32Array&&t.length>=16||function(e){return Array.isArray(e)&&e.length>=16}(e);var t}(t)&&(t=(0,Je.z0)(Hr,t)),(0,Ee.q)(i.normal,e,t),(0,Ee.t)(i.normal,i.normal,r.viewInverseTransposeMatrix),i.cosAngle=(0,Ee.f)(Lr,$r),i}function Cr(e,t,r,i,s,n,a,o,l){let c=t-s-i[0]*l[0],h=c+i[0]+2*s,d=r-s-i[1]*l[1],u=d+i[1]+2*s;const f=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&null!=f&&(c+=i[0]*f[0],d+=i[1]*f[1],h-=i[0]*(1-f[2]),u-=i[1]*(1-f[3]),c-=n,h+=n,d-=n,u+=n),(0,se.hZ)(Br,t,r),(0,se.e$)(zr,e,Br,(0,ae.kU)(a)),zr[0]>c&&zr[0]<h&&zr[1]>d&&zr[1]<u}const Er=new class{constructor(){this.factor=new dr,this.factorAlignment=new dr}},Fr=(0,j.vt)(),Dr=(0,j.vt)(),Pr=(0,ie.vt)(),Lr=(0,j.vt)(),Nr=(0,j.vt)(),zr=(0,ne.vt)(),Br=(0,ne.vt)(),Vr=(0,Qe.vt)(),Hr=(0,Qe.vt)(),jr=(0,Ce.vt)(),Ur=(0,j.vt)(),Gr=(0,j.vt)(),kr=(0,ie.vt)(),qr={normal:Lr,cosAngle:0},Zr=1,Wr=2,Yr=[0,0],$r=(0,j.fA)(0,0,1);class Xr extends lr.NV{constructor(){super(...arguments),this.renderOccluded=cr.m$.Occlude,this.isDecoration=!1,this.color=(0,ie.CN)(1,1,1,1),this.polygonOffset=!1,this.anchorPosition=(0,ne.fA)(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.sampleSignedDistanceFieldTexelCenter=!1,this.outlineColor=(0,ie.CN)(1,1,1,1),this.outlineSize=0,this.distanceFieldBoundingBox=(0,ie.vt)(),this.rotation=0,this.hasRotation=!1,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.occludedFragmentFade=!1,this.horizonCullingEnabled=!1,this.centerOffsetUnits="world",this.drawAsLabel=!1,this.depthEnabled=!0,this.isFocused=!0,this.focusEffect="none",this.draped=!1,this.isLabel=!1}}const Jr=(0,Fe.BP)().vec3f(Ie.r.POSITION).vec3f(Ie.r.NORMAL).vec2f(Ie.r.UV0).vec4u8(Ie.r.COLOR).vec2f(Ie.r.SIZE).f32(Ie.r.ROTATION).vec4f(Ie.r.CENTEROFFSETANDDISTANCE).vec4f(Ie.r.FEATUREATTRIBUTE),Qr=Jr.clone().vec4u8(Ie.r.OBJECTANDLAYERIDCOLOR);class Kr{constructor(){this.vertexBufferLayout=(0,or.E)()?Qr:Jr}elementCount(e){return 6*e.get(Ie.r.POSITION).indices.length}write(e,t,r,i,s,n){(0,ur.Hk)(r.get(Ie.r.POSITION),e,s.position,n,6),(0,ur.p1)(r.get(Ie.r.NORMAL),t,s.normal,n,6);const a=r.get(Ie.r.UV0)?.data;let o=0,l=0,c=1,h=1;a&&a.length>=4&&(o=a[0],l=a[1],c=a[2],h=a[3]),c=Math.min(1.99999,c+1),h=Math.min(1.99999,h+1);let d=r.get(Ie.r.POSITION).indices.length,u=n;const f=s.uv0;for(let e=0;e<d;++e)f.set(u,0,o),f.set(u,1,l),u++,f.set(u,0,c),f.set(u,1,l),u++,f.set(u,0,c),f.set(u,1,h),u++,f.set(u,0,c),f.set(u,1,h),u++,f.set(u,0,o),f.set(u,1,h),u++,f.set(u,0,o),f.set(u,1,l),u++;(0,ur.tb)(r.get(Ie.r.COLOR),4,s.color,n,6);const{data:p,indices:_}=r.get(Ie.r.SIZE);d=_.length;const m=s.size;u=n;for(let e=0;e<d;++e){const t=p[2*_[e]],r=p[2*_[e]+1];for(let e=0;e<6;++e)m.set(u,0,t),m.set(u,1,r),u++}if((0,ur.uO)(r.get(Ie.r.ROTATION),s.rotation,n,6),r.get(Ie.r.CENTEROFFSETANDDISTANCE)?(0,ur.Ut)(r.get(Ie.r.CENTEROFFSETANDDISTANCE),s.centerOffsetAndDistance,n,6):(0,ur.Pq)(s.centerOffsetAndDistance,n,6*d),r.get(Ie.r.FEATUREATTRIBUTE)?(0,ur.Ut)(r.get(Ie.r.FEATUREATTRIBUTE),s.featureAttribute,n,6):(0,ur.Pq)(s.featureAttribute,n,6*d),null!=i){const e=r.get(Ie.r.POSITION)?.indices;if(e){const t=e.length,r=s.getField(Ie.r.OBJECTANDLAYERIDCOLOR,Ke.XP);(0,ur.tH)(i,r,t,n,6)}}}}var ei=r(74810);let ti=class extends m.A{constructor(e){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=e.view,this.layerUid=e.layerUid}initialize(){}destroy(){this.removeAllHandles(),this._lodRenderers.forEach((e=>e.destroy()))}async executeRenderCommands(e){for(const t of e)switch(t.id){case"create-material":await this._createMaterial(t);break;case"create-direct-renderer":await this._createDirectRenderer(t);break;case"add-direct-renderer-geometry":await this._addDirectRendererGeometry(t),this._updateFeatureCount();break;case"remove-direct-renderer-geometry":await this._removeDirectRendererGeometry(t),this._updateFeatureCount();break;case"create-lod-renderer":await this._createLodRenderer(t);break;case"add-lod-instances":await this._addLodInstances(t),this._updateFeatureCount();break;case"remove-lod-instances":await this._removeLodInstances(t),this._updateFeatureCount()}}_updateFeatureCount(){let e=0;for(const t of this._directRenderers.values())e+=t.numFeatures;for(const t of this._lodRenderers.values())e+=t.numFeatures;this._set("totalFeatures",e)}get usedMemory(){let e=0;for(const t of this._directRenderers.values())e+=t.usedMemory;for(const t of this._lodRenderers.values())e+=t.usedMemory;return e}async _createMaterial(e){const{view:t}=this,{sharedSymbolResources:r}=t;if(null==r)throw new Error("No shared symbol resources found!");const{textures:i}=r,s=t.state.viewingMode===K.RT.Global;let n=null;switch(e.type){case"default":n=function(e,t,r){const i={usePBR:t.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:ei.Bt,ambient:j.Un,diffuse:j.Un,hasSlicePlane:t.slicePlaneEnabled,castShadows:t.castShadows,offsetTransparentBackfaces:!t.isPrimitive};return function(e){const t=e.opacity??1,r=t<1;e.transparent=r,e.opacity=t,e.cullFace=r?ye.s2.None:ye.s2.Back}(i),t.screenSizePerspectiveEnabled&&(i.screenSizePerspective=e.screenSizePerspectiveSettings),i.externalColor=ie.Un,i.isInstanced=!0,new sr.$U(i,{spherical:r,doublePrecisionRequiresObfuscation:!0})}(r,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:t._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},s);break;case"hud":{const[e,t]=ri(i,s);this.addHandles([(0,te.hA)((()=>(0,re.Gz)(t)))]),n=e}break;default:throw new Error(`unable to create unknown material type ${e.type}`)}this._materials.set(e.materialId,n)}_getMaterial(e){return this._materials.get(e)}async _createDirectRenderer(e){const t=e.materialId,r=this._getMaterial(t);if(null==r)throw new Error(`material not found ${t}`);const{view:i}=this,s=new Te({material:r});this._directRenderers.set(t,s),i._stage.addRenderPlugin(s),i._stage.renderView.renderer.updateHasFlags()}async _addDirectRendererGeometry(e){const t=e.renderGeometryId,r=e.materialId;await this._removeDirectRendererGeometry({renderGeometryId:t});const i=this._directRenderers.get(r);if(null==i)return void console.error("no renderer assigned to provided material");const s=i.addRenderGeometry(t,e.renderGeometryBuffer,e.localOrigin);this._renderGeometries.set(t,{renderGeometry:s,materialId:r}),this.view._stage.renderView.requestRender()}async _removeDirectRendererGeometry(e){const t=e.renderGeometryId,r=this._renderGeometries.get(t);if(null==r)return;const i=r.materialId,s=this._directRenderers.get(i);null!=s?s.removeRenderGeometry(e.renderGeometryId):console.error("no renderer assigned to provided material")}async _createLodRenderer(e){const t=new $t({view:this.view,layerUid:this.layerUid}),r=new AbortController;await t.doLoad(e.lodRenderGeometry,(e=>this._getMaterial(e)),r.signal),this._lodRenderers.set(e.lodRendererId,t)}async _addLodInstances(e){const t=this._lodRenderers.get(e.lodRendererId);if(null==t)throw new Error("no lod renderer assigned to provided lod renderer Id");t.addInstances(e.data)}async _removeLodInstances(e){const t=this._lodRenderers.get(e.lodRendererId);if(null==t)throw new Error("no lod renderer assigned to provided lod renderer Id");t.removeInstances(e.featureIds)}};function ri(e,t){const r={anchorPosition:de.center,occlusionTest:!0,hasSlicePlane:!1,color:[1,0,0,1],outlineColor:[0,0,0,1],outlineSize:1,distanceFieldBoundingBox:Qt};if(null!=e){const t=e.fromData("circle-icon",(()=>function(e,t=128,r=.5*t,i=0){const s=function(e,t=128,r=.5*t,i=0){switch(e){case"circle":default:return function(e,t){const r=e/2-.5;return ir(e,tr(r,r,t/2))}(t,r);case"square":return function(e,t){return Kt(e,t,!1)}(t,r);case"cross":return function(e,t,r=0){return er(e,t,!1,r)}(t,r,i);case"x":return function(e,t,r=0){return er(e,t,!0,r)}(t,r,i);case"kite":return function(e,t){return Kt(e,t,!0)}(t,r);case"triangle":return function(e,t){return ir(e,rr(e/2,t,t/2))}(t,r);case"arrow":return function(e,t){const r=t,i=t/2,s=e/2,n=.8*r,a=tr(s,(e-t)/2-n,Math.sqrt(n*n+i*i)),o=rr(s,r,i);return ir(e,((e,t)=>Math.max(o(e,t),-a(e,t))))}(t,r)}}(e,t,r,i);return new Jt.g(s,{mipmap:!1,wrap:{s:rt.pF.CLAMP_TO_EDGE,t:rt.pF.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0,reloadable:!0})}("circle")));r.textureId=t.texture.id,r.textureIsSignedDistanceField=!0,r.sampleSignedDistanceFieldTexelCenter=!1}return[new Or(r,t),null]}(0,i._)([(0,o.MZ)({readOnly:!0})],ti.prototype,"totalFeatures",void 0),ti=(0,i._)([(0,h.$)("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],ti);class ii{constructor(e){this._bufferWriter=null,this._bufferWriter=e.createBufferWriter()}createBuffer(e,t){const r=this._bufferWriter;let i=null;if(e.transformation&&t)(0,Pe.C)(si,e.transformation),si[12]-=t[0],si[13]-=t[1],si[14]-=t[2],i=si;else{if(t)throw new Error("not implemented");e.transformation&&(i=e.transformation)}let s=null;i&&((0,Pe.B8)(ni,si),(0,Pe.mg)(ni,ni),s=ni);const n=e.attributes,a=r.elementCount(n),o=r.vertexBufferLayout.stride/4;a>Math.floor(ai/o)&&console.warn("geometry with very large number of elements encountered");const l=r.vertexBufferLayout.createBuffer(a);return r.write(i,s,n,e.objectAndLayerIdColor,l,0),{data:l.buffer,elementCount:a}}}const si=(0,Ce.vt)(),ni=(0,Ce.vt)(),ai=4194304;var oi=r(29920);class li{constructor(e){this._context=e,this._commands=[],this._transferables=new Set}createMaterial(e){const t=this._context,r=t.generateId("material");switch(e){case"default":{const e=new sr.$U({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),i=new ii(e);t.registerRenderGeometryBufferWriter(r,i)}break;case"hud":{const e=ri(null,this._context.globalViewingMode)[0],i=new ii(e);t.registerRenderGeometryBufferWriter(r,i)}}return this._commands.push({id:"create-material",type:e,materialId:r}),r}createDirectRenderer(e){const t=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:t,materialId:e}),t}addDirectRendererGeometry(e,t,r){const i=t.materialId,s=this._context.getRenderGeometryBufferWriter(i);if(null==s)throw new Error(`no bufferwriter found for material ${i}`);const n=s.createBuffer(t,r);this._transferables.add(n.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:e,materialId:i,renderGeometryBuffer:n,localOrigin:r})}removeDirectRendererGeometry(e){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:e})}createLodRenderer(e){const t=this._context.generateId("lod-renderer"),r={levels:e.levels.map((e=>({components:e.components.map((e=>{const t=e.attributes.get(Ie.r.POSITION);if(!t||0===t.indices.length)throw new Error("positions attribute expected");const r=(0,ee.tM)(t.indices.length/3),i=new oi.j(r,3,t),s=this._context.getRenderGeometryBufferWriter(e.materialId);if(null==s)throw new Error("writer not found");const n=s.createBuffer(e,null);return this._transferables.add(n.data),{materialId:e.materialId,renderGeometryBuffer:n,boundingInfo:{bbMax:i.bbMax,bbMin:i.bbMin}}})),minScreenSpaceRadius:e.minScreenSpaceRadius})))};return this._commands.push({id:"create-lod-renderer",lodRendererId:t,lodRenderGeometry:r}),t}addLodInstances(e,t){this._commands.push({id:"add-lod-instances",lodRendererId:e,data:t}),this._transferables.add(t.featureIds.buffer),this._transferables.add(t.globalTransforms.buffer),this._transferables.add(t.localTransforms.buffer)}removeLodInstances(e,t){this._commands.push({id:"remove-lod-instances",lodRendererId:e,featureIds:t}),this._transferables.add(t.buffer)}append(e){if(e._context!==this._context)throw new Error("Cannot append encoders from different contexts");const{_commands:t,_transferables:r}=this;for(const r of e._commands)t.push(r);for(const t of e._transferables)r.add(t)}async dispatch(){const e=this._commands,t=Array.from(this._transferables);this._clearCommandBuffer(),await this._context.dispatchRenderCommands(e,t)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}}class ci{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===K.RT.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new li(this)}async dispatchRenderCommands(e,t){0!==e.length&&await this._dispatchRenderCommandsCallback(e,t)}registerRenderGeometryBufferWriter(e,t){this._bufferWriters.set(e,t)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}}class hi{constructor(e,t){this._renderCommands=e,this._pipelineStateCommands=t}append(e){this.appendRenderCommands(e._renderCommands),this.appendPipelineStateCommands(e._pipelineStateCommands)}appendRenderCommands(e){this._renderCommands.append(e)}appendPipelineStateCommand(e){this._pipelineStateCommands.push(e)}appendPipelineStateCommands(e){const{_pipelineStateCommands:t}=this;for(const r of e)t.push(r)}execute(){for(const e of this._pipelineStateCommands)e();this._renderCommands.dispatch()}}var di=r(9762),ui=r(27993);function fi(e,t){const{featureCount:r}=e;if(0===r)return new Uint32Array;const i=new Uint32Array(r);return e.readObjectIds(i),i}function pi(e,t){const{featureCount:r}=e;if(0===r)return new Float64Array;const i=new Float64Array(3*r);return e.readCoordinates(i),i}var _i=r(48353),mi=r(8887),gi=r(83047);function yi(e){const t=new Map;for(const[r,i]of e)t.set(r,{...i,indices:(0,ee.Dg)(i.indices)});return t}r(12359),r(95108),r(27615),r(52106),r(4718),r(34275),r(65864);var vi,xi,bi=r(57917),wi=r(72385),Ti=(r(4197),r(11868)),Ai=r(27921),Si=r(46610);(xi=vi||(vi={})).length=function(e,t){const r=e[t],i=e[t+1],s=e[t+2];return Math.sqrt(r*r+i*i+s*s)},xi.normalize=function(e,t){const r=e[t],i=e[t+1],s=e[t+2],n=1/Math.sqrt(r*r+i*i+s*s);e[t]*=n,e[t+1]*=n,e[t+2]*=n},xi.scale=function(e,t,r){e[t]*=r,e[t+1]*=r,e[t+2]*=r},xi.add=function(e,t,r,i,s,n=t){(s=s||e)[n]=e[t]+r[i],s[n+1]=e[t+1]+r[i+1],s[n+2]=e[t+2]+r[i+2]},xi.subtract=function(e,t,r,i,s,n=t){(s=s||e)[n]=e[t]-r[i],s[n+1]=e[t+1]-r[i+1],s[n+2]=e[t+2]-r[i+2]},r(96672),r(87170);const Ri=new Array(36);for(let e=0;e<6;e++)for(let t=0;t<6;t++)Ri[6*e+t]=e;const Oi=new Array(36);for(let e=0;e<6;e++)Oi[6*e]=0,Oi[6*e+1]=1,Oi[6*e+2]=2,Oi[6*e+3]=2,Oi[6*e+4]=3,Oi[6*e+5]=0;const Ii=(0,wi.fA)(-.5,0,-.5),Mi=(0,wi.fA)(.5,0,-.5),Ci=(0,wi.fA)(0,0,.5),Ei=(0,wi.fA)(0,.5,0),Fi=(0,wi.vt)(),Di=(0,wi.vt)(),Pi=(0,wi.vt)(),Li=(0,wi.vt)(),Ni=(0,wi.vt)();function zi(e,t){switch(e){case"cone":return((e,r,i=!1)=>({levels:e.map((e=>{const s=yi(r(e.tesselation));return i&&function(e){const t=e,r=t.get(Ie.r.POSITION).data,i=t.get(Ie.r.NORMAL).data;if(i){const t=Bi(e,Ie.r.NORMAL).data;for(let e=0;e<i.length;e+=3){const r=i[e+1];t[e+1]=-i[e+2],t[e+2]=r}}if(r){const t=Bi(e,Ie.r.POSITION).data;for(let e=0;e<r.length;e+=3){const i=r[e+1];t[e+1]=-r[e+2],t[e+2]=i}}}(s),{components:[{attributes:s,objectAndLayerIdColor:void 0,transformation:null,materialId:t}],minScreenSpaceRadius:e.minScreenSpaceRadius}}))}))(Vi,(e=>function(e,t,r,i,s=!0,n=!0){let a=0;const o=t,l=e;let c=(0,wi.fA)(0,a,0),h=(0,wi.fA)(0,a+l,0),d=(0,wi.fA)(0,-1,0),u=(0,wi.fA)(0,1,0);i&&(a=l,h=(0,wi.fA)(0,0,0),c=(0,wi.fA)(0,a,0),d=(0,wi.fA)(0,1,0),u=(0,wi.fA)(0,-1,0));const f=[h,c],p=[d,u],_=r+2,m=Math.sqrt(l*l+o*o);if(i)for(let e=r-1;e>=0;e--){const t=e*(2*Math.PI/r),i=(0,wi.fA)(Math.cos(t)*o,a,Math.sin(t)*o);f.push(i);const s=(0,wi.fA)(l*Math.cos(t)/m,-o/m,l*Math.sin(t)/m);p.push(s)}else for(let e=0;e<r;e++){const t=e*(2*Math.PI/r),i=(0,wi.fA)(Math.cos(t)*o,a,Math.sin(t)*o);f.push(i);const s=(0,wi.fA)(l*Math.cos(t)/m,o/m,l*Math.sin(t)/m);p.push(s)}const g=new Array,y=new Array;if(s){for(let e=3;e<f.length;e++)g.push(1),g.push(e-1),g.push(e),y.push(0),y.push(0),y.push(0);g.push(f.length-1),g.push(2),g.push(1),y.push(0),y.push(0),y.push(0)}if(n){for(let e=3;e<f.length;e++)g.push(e),g.push(e-1),g.push(0),y.push(e),y.push(e-1),y.push(1);g.push(0),g.push(2),g.push(f.length-1),y.push(1),y.push(2),y.push(p.length-1)}const v=(0,Ti.oe)(3*_);for(let e=0;e<_;e++)v[3*e]=f[e][0],v[3*e+1]=f[e][1],v[3*e+2]=f[e][2];const x=(0,Ti.oe)(3*_);for(let e=0;e<_;e++)x[3*e]=p[e][0],x[3*e+1]=p[e][1],x[3*e+2]=p[e][2];return[[Ie.r.POSITION,new Si.n(v,g,3,!0)],[Ie.r.NORMAL,new Si.n(x,y,3,!0)]]}(1,.5,e,!1)),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function Bi(e,t){let r=e.get(t);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:(0,bi.S)(r.data)},e.set(t,r)),r}(0,Ee.d)(Fi,Ii,Ei),(0,Ee.d)(Di,Ii,Mi),(0,Ee.e)(Pi,Fi,Di),(0,Ee.n)(Pi,Pi),(0,Ee.d)(Fi,Mi,Ei),(0,Ee.d)(Di,Mi,Ci),(0,Ee.e)(Li,Fi,Di),(0,Ee.n)(Li,Li),(0,Ee.d)(Fi,Ci,Ei),(0,Ee.d)(Di,Ci,Ii),(0,Ee.e)(Ni,Fi,Di),(0,Ee.n)(Ni,Ni),Pi[0],Pi[1],Pi[2],Li[0],Li[1],Li[2],Ni[0],Ni[1],Ni[2],(0,j.vt)();const Vi=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class Hi{constructor(e){this._context=e,this.lodRendererId=null,this._loaded=!1,this._loadingPromise=null,this._primitive="cone"}get loaded(){return this._loaded}load(){return null==this._loadingPromise&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder(),t=e.createMaterial("default"),r=zi(this._primitive,t);this.lodRendererId=e.createLodRenderer(r),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const t=this._context.renderCommandContext.createEncoder();if(null==this.lodRendererId)throw new Error("expected lod renderer id to not be null");const{featureCount:r}=e;if(0===r)return t;const i=(0,U.vt)((0,mi.Fq)(this._primitive)),s=(0,j.ci)((0,U.Ej)(i)),n=(0,j.ci)((0,mi.Bb)(s,{isPrimitive:!0,width:100,depth:null,height:null})),a=new Float64Array(16*r),o=new Float64Array(16*r),l=pi(e,this._context);for(let e=0;e<r;++e){const t=e,r=l[3*e+0],i=l[3*e+1],c=l[3*e+2],h=this._computeGlobalTransform(r,i,c,this._context.viewSpatialReference,Gi),d=this._computeLocalTransform(n,s,Ui);this._writeMatrixToTypedBuffer(a,t,d),this._writeMatrixToTypedBuffer(o,t,h)}const c=fi(e,this._context),h={featureIds:new Uint32Array(c),localTransforms:a,globalTransforms:o};return t.addLodInstances(this.lodRendererId,h),t}async createRemoveCommand(e){const t=this._context.renderCommandContext.createEncoder();if(null==this.lodRendererId)return t;const r=fi(e,this._context);return t.removeLodInstances(this.lodRendererId,r),t}_writeMatrixToTypedBuffer(e,t,r){let i=16*t;for(let t=0;t<16;t++)e[i++]=r[t]}_computeGlobalTransform(e,t,r,i,s){return ji[0]=e,ji[1]=t,ji[2]=r,(0,_i.l)(i,ji,s,this._context.renderSpatialReference),s}_computeLocalTransform(e,t,r){return(0,Pe.D_)(r),this._applyObjectScale(e,t,r),r}_applyObjectScale(e,t,r){const i=function(e=j.Un,t,r,i=1){const s=new Array(3);if(null==t||null==r)s[0]=1,s[1]=1,s[2]=1;else{let i,n=0;for(let a=2;a>=0;a--){const o=e[a],l=null!=o,c=0===a&&!i&&!l,h=r[a];let d;"symbol-value"===o||c?d=0!==h?t[a]/h:1:l&&"proportional"!==o&&isFinite(o)&&(d=0!==h?o/h:1),null!=d&&(s[a]=d,i=d,n=Math.max(n,Math.abs(d)))}for(let e=2;e>=0;e--)null==s[e]?s[e]=i:0===s[e]&&(s[e]=.001*n)}for(let e=2;e>=0;e--)s[e]/=i;return(0,j.ci)(s)}(e,e,t,this._context.renderCoordsHelper.unitInMeters);1===i[0]&&1===i[1]&&1===i[2]||(0,Pe.hs)(r,r,i)}}const ji=(0,j.vt)(),Ui=(0,Ce.vt)(),Gi=(0,Ce.vt)();class ki{constructor(e){this._context=e,this.materialId=null,this._loaded=!1,this._loadingPromise=null}get loaded(){return this._loaded}load(){return null==this._loadingPromise&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder();this.materialId=e.createMaterial("hud"),e.createDirectRenderer(this.materialId),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const t=this._context.renderCommandContext.createEncoder();if(null==this.materialId)throw new Error("expected material not to be null");const{featureCount:r,id:i}=e;if(0===r)return t;const s=function(e,t){const{featureCount:r}=e;if(0===r)return new Float64Array;const i=pi(e),s=t.viewSpatialReference,n=t.renderSpatialReference,a=new Float64Array(3*r);if(!(0,di.projectBuffer)(i,s,0,a,n,0,r))throw new Error("Failed to project coordinates");return a}(e,this._context),n=function(e,t){const r=t.viewSpatialReference,i=t.renderSpatialReference,{extent:s}=e,n=(0,x.gX)(s),a=(0,j.vt)();return(0,ui.F)([n[0],n[1],0],r,a,i),a}(e,this._context),a=new Float64Array([0,0,1]),o=new Float64Array([255,255,255,255]),l=new Float64Array([24,24]),c=new Float64Array([0,0,0,1]),h=new Float64Array([0,0]),d=new Float64Array([0]),u=new Uint32Array(r);for(let e=0;e<r;++e)u[e]=e;const f=new Uint32Array(r);for(let e=0;e<r;++e)f[e]=0;const p=new Si.n(s,u,3,!0),_=new Si.n(a,f,3,!0),m=new Si.n(h,f,2,!0),g=new Si.n(o,f,4,!0),y=new Si.n(d,f,1,!0),v=new Si.n(l,f,2,!0),b=new Si.n(c,f,4,!0),w={attributes:yi([[Ie.r.POSITION,p],[Ie.r.NORMAL,_],[Ie.r.UV0,m],[Ie.r.COLOR,g],[Ie.r.ROTATION,y],[Ie.r.SIZE,v],[Ie.r.CENTEROFFSETANDDISTANCE,b]]),objectAndLayerIdColor:void 0,transformation:(0,Ce.vt)(),materialId:this.materialId};return t.addDirectRendererGeometry(i,w,n),t}async createRemoveCommand(e){const t=this._context.renderCommandContext.createEncoder();return t.removeDirectRendererGeometry(e.id),t}}class qi{constructor(e){this._symbols=new Array,this._featureDataPartitioning=new Map,this._context=e}async load(){this._symbols[0]=new ki(this._context),this._symbols[1]=new Hi(this._context)}async createAddCommand(e){const t=this._partition(e),r=await Promise.all(t.map((async({index:e,features:t})=>{const r=await this._provisionSymbol(e);return await(r?.createAddCommand(t))}))),i=this._context.renderCommandContext.createEncoder();for(const e of r)null!=e&&i.append(e);return new hi(i,[()=>{this._featureDataPartitioning.set(e,t)}])}async createRemoveCommand(e){const{_featureDataPartitioning:t}=this,r=t.get(e),i=this._context.renderCommandContext.createEncoder();if(null==r)return new hi(this._context.renderCommandContext.createEncoder(),[]);const s=await Promise.all(r.map((async({index:e,features:t})=>{const r=this._getLoadedSymbol(e);return await(r?.createRemoveCommand(t))})));for(const e of s)null!=e&&i.append(e);return new hi(i,[()=>{t.delete(e)}])}async _provisionSymbol(e){if(null==e)return null;const t=this._symbols[e];return t?(t.loaded||await t.load(),t):null}_getLoadedSymbol(e){if(null==e)return null;const t=this._symbols[e];return null!=t&&t.loaded?t:null}_partition(e){const t=fi(e,this._context);if(null==t)throw new Error("unable to fetch objectIds");const{featureCount:r}=e,i=[[],[]];for(let e=0;e<r;++e)i[t[e]%2].push(e);return i.map(((t,r)=>new Zi(r,e.subset(new Uint32Array(t))))).filter((e=>e.features.featureCount>0))}}class Zi{constructor(e,t){this.index=e,this.features=t}}var Wi=r(73941),Yi=r(98764),$i=r(65806);const Xi=(0,j.vt)();var Ji=r(88582),Qi=r(17352);function Ki(e,t,r=function(e){return{operations:e,value:e.create()}}(e)){return r.operations=e,e.copy(t,r.value),r}const es=2**50;function ts(e,t,r,i){return e.operations.setAltitudeAt(e.value,t,r,i)}function rs(e,t,r){return e.operations.elevate(e.value,t,r.value)}const is=(0,j.vt)();(0,j.vt)();var ss=r(32114);function ns(e){return"point"===e.type}class as{constructor(e,t,r,i){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=r,this._coordinateSystem=i,this._tmpCoordinateSystem=function(e){const{value:t,operations:r}=e;return{operations:r,value:r.create(t)}}(i),this.referenceEllipsoid=(0,Wi.tO)(t),this.sphericalPCPF=(0,Yi.lO)(t)}set extent(e){e&&function(e,t,r){e.operations.setExtent(e.value,t,r.value)}(this._coordinateSystem,e,this._coordinateSystem)}get extent(){return function(e,t){return e.operations.getExtent(e.value,t),t}(this._coordinateSystem,(0,x.vt)())}getAltitude(e){return function(e,t){return e.operations.altitudeAt(e.value,t)}(this._coordinateSystem,e)}setAltitude(e,t,r=e){return ts(this._coordinateSystem,r,t,e)}setAltitudeOfTransformation(e,t){!function(e,t,r,i){t!==i&&(0,Pe.C)(i,t),(0,Ee.i)(is,i[12],i[13],i[14]),ts(e,is,r,is),i[12]=is[0],i[13]=is[1],i[14]=is[2]}(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return function(e,t,r){return e.operations.axisAt(e.value,t,Ji._.Z,r)}(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,r){return function(e,t,r,i){return e.operations.axisAt(e.value,t,r,i)}(this._coordinateSystem,e,t,r)}basisMatrixAtPosition(e,t){const r=this.worldBasisAtPosition(e,Ji._.X,ss.rq.get()),i=this.worldBasisAtPosition(e,Ji._.Y,ss.rq.get()),s=this.worldBasisAtPosition(e,Ji._.Z,ss.rq.get());return(0,Pe.hZ)(t,r[0],r[1],r[2],0,i[0],i[1],i[2],0,s[0],s[1],s[2],0,0,0,0,1),t}headingAtPosition(e,t){const r=this.worldUpAtPosition(e,ss.rq.get()),i=this.worldBasisAtPosition(e,Ji._.Y,ss.rq.get()),s=(0,Be.EJ)(t,i,r);return(0,ae.KJ)(s)}intersectManifoldClosestSilhouette(e,t,r){return rs(this._coordinateSystem,t,this._tmpCoordinateSystem),function(e,t,r){e.operations.intersectRayClosestSilhouette(e.value,t,r)}(this._tmpCoordinateSystem,e,r),r}intersectManifold(e,t,r){rs(this._coordinateSystem,t,this._tmpCoordinateSystem);const i=ss.rq.get();return function(e,t,r){return e.operations.intersectRay(e.value,t,r)}(this._tmpCoordinateSystem,e,i)?(0,Ee.c)(r,i):null}intersectInfiniteManifold(e,t,r){if(this.viewingMode===K.RT.Global)return this.intersectManifold(e,t,r);rs(this._coordinateSystem,t,this._tmpCoordinateSystem);const i=this._tmpCoordinateSystem.value,s=ss.rq.get();return(0,Ai.Ui)(i.plane,e,s)?(0,Ee.c)(r,s):null}toRenderCoords(e,t,r){return ns(e)?(0,$i.g)(e,t,this.spatialReference):(0,ui.F)(e,t,r,this.spatialReference)}fromRenderCoords(e,t,r=null){return ns(t)?(null!=r&&(t.spatialReference=r),function(e,t,r){return!!(0,ui.F)(e,t,Xi,r.spatialReference)&&(r.x=Xi[0],r.y=Xi[1],r.z=Xi[2],!0)}(e,this.spatialReference,t)?t:null):(0,ui.F)(e,this.spatialReference,t,r)?t:null}static create(e,t){switch(e){case K.RT.Local:return new as(K.RT.Local,t,(0,gi.GA)(t),Ki(Qi.b,(0,Qi.f)([0,0,0],[es,0,0],[0,es,0])));case K.RT.Global:return new as(K.RT.Global,t,1,function(e){return Ki(pt.s,(0,pt.f)(0,0,0,(0,Wi.tO)(e).radius))}(t))}}static renderUnitScaleFactor(e,t){return(0,gi.KX)(e)/(0,gi.KX)(t)}}let os=class extends s.A.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureDataStore=new I,this._featureStore=new P,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager?.destroy()}async setup({viewSpatialReference:e,renderSpatialReference:t,viewingMode:r,baseQuery:i,url:s,objectIdField:n,capabilities:o,fieldsIndex:l,timeInfo:c,fullExtent:h}){const m=f.A.fromJSON(e),g=f.A.fromJSON(t);this._fetcher=new Q(m,_.A.fromJSON(i),s,n,o),this._queryEngine=new p.do({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:n,fieldsIndex:l,availableFields:[n],spatialReference:e,featureStore:this._featureStore,timeInfo:c}),this._renderer=new qi({viewSpatialReference:m,renderSpatialReference:g,renderCoordsHelper:as.create(r,g),renderCommandContext:new ci({viewingMode:r,dispatchRenderCommandsCallback:(e,t)=>this.remoteClient.invoke("dispatchRenderCommands",e,{transferList:t})})}),this._defaultQueryJSON=new _.A({outSpatialReference:m}).toJSON();let y=null;if(null!=h){const e=d.A.fromJSON(h);await(0,u.initializeProjection)(e.spatialReference,m),y=(0,u.project)(e,m)}return this._tileManager=new b({loadTile:(e,t)=>this._fetcher.fetch(e,t),createAddTileCommand:(e,t)=>this._createAddTileCommand(e,t),createRemoveTileCommand:e=>this._createRemoveTileCommand(e),extent:y}),this.addHandles((0,a.wB)((()=>this.updating),(e=>{this.emit("notify-updating",{updating:e})})),a.Vh),await this._renderer.load(),cs}async executeQuery(e,t){return{result:await this._queryEngine.executeQuery(this._ensureQuery(e),t)}}async executeQueryForIds(e,t){const r=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(e),t);return{result:Array.from(r)}}async executeQueryForCount(e,t){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(e),t)}}async executeQueryForExtent(e,t){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(e),t)}}async executeQueryForLatestObservations(e,t){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(e),t)}}async onTileTreeChange(e){return await this._tileManager.onTileTreeChange(e),cs}async _createAddTileCommand(e,t){const r=new O(e),i=await this._renderer.createAddCommand(r);return(0,n.Te)(t),i.appendPipelineStateCommand((()=>{this._featureDataStore.add(r),this._featureStore.addTile(e)})),i}async _createRemoveTileCommand(e){const t=this._featureStore,r=this._featureDataStore,i=this._renderer,s=r.get(e);if(null==s)return null;const n=await i.createRemoveCommand(s);return n.appendPipelineStateCommand((()=>{r.remove(e),t.removeTile(e)})),n}_ensureQuery(e){return e??this._defaultQueryJSON}};(0,i._)([(0,o.MZ)()],os.prototype,"updating",null),os=(0,i._)([(0,h.$)("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],os);const ls=os,cs={result:void 0}},4431:(e,t,r)=>{r.d(t,{U:()=>n});var i=r(63907),s=r(74038);function n(e,t=0){const r=e.stride;return Array.from(e.fields.keys()).map((i=>{const n=e.fields.get(i),o=n.constructor.ElementCount,l=a(n.constructor.ElementType),c=n.offset,h=n.optional?.glNormalized??!1;return new s._(i,o,l,c,r,h,t)}))}function a(e){const t=o[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const o={u8:i.pe.UNSIGNED_BYTE,u16:i.pe.UNSIGNED_SHORT,u32:i.pe.UNSIGNED_INT,i8:i.pe.BYTE,i16:i.pe.SHORT,i32:i.pe.INT,f32:i.pe.FLOAT}},47522:(e,t,r)=>{r.d(t,{K:()=>n});var i=r(32976),s=r(31821);function n(e){e.uniforms.add(new i.o("alignPixelEnabled",(e=>e.alignPixelEnabled))),e.code.add(s.H`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`),e.code.add(s.H`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`)}},40268:(e,t,r)=>{r.d(t,{Q:()=>u,R:()=>d});var i=r(35640),s=r(52587),n=r(20693),a=r(14314),o=r(33094),l=r(20304),c=r(31821),h=r(46540);const d=.5;function u(e,t){e.include(s.Y6),e.attributes.add(h.r.POSITION,"vec3"),e.attributes.add(h.r.NORMAL,"vec3"),e.attributes.add(h.r.CENTEROFFSETANDDISTANCE,"vec4");const r=e.vertex;(0,n.NB)(r,t),(0,n.yu)(r,t),r.uniforms.add(new a.I("viewport",(e=>e.camera.fullViewport)),new l.m("polygonOffset",(e=>e.shaderPolygonOffset)),new o.U("cameraGroundRelative",(e=>e.camera.aboveGround?1:-1))),t.hasVerticalOffset&&(0,i.V)(r),r.constants.add("smallOffsetAngle","float",.984807753012208),r.code.add(c.H`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),r.code.add(c.H`
    float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
      float pointGroundSign = ${t.terrainDepthTest?c.H.float(0):c.H`sign(pointGroundDistance)`};
      if (pointGroundSign == 0.0) {
        pointGroundSign = cameraGroundRelative;
      }

      // cameraGroundRelative is -1 if camera is below ground, 1 if above ground
      // groundRelative is 1 if both camera and symbol are on the same side of the ground, -1 otherwise
      float groundRelative = cameraGroundRelative * pointGroundSign;

      // view angle dependent part of polygon offset emulation: we take the absolute value because the sign that is
      // dropped is instead introduced using the ground-relative position of the symbol and the camera
      if (polygonOffset > .0) {
        float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
        float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
        float factor = (1.0 - tanAlpha / viewport[2]);

        // same side of the terrain
        if (groundRelative > 0.0) {
          posView *= factor;
        }
        // opposite sides of the terrain
        else {
          posView /= factor;
        }
      }

      return groundRelative;
    }
  `),t.draped&&!t.hasVerticalOffset||(0,n.S7)(r),t.draped||(r.uniforms.add(new o.U("perDistancePixelRatio",(e=>Math.tan(e.camera.fovY/2)/(e.camera.fullViewport[2]/2)))),r.code.add(c.H`
    void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
      float distanceToCamera = length(posView);

      // Compute offset in world units for a half pixel shift
      float pixelOffset = distanceToCamera * perDistancePixelRatio * ${c.H.float(d)};

      // Apply offset along normal in the direction away from the ground surface
      vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;

      // Apply the same offset also on the view space position
      vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;

      posModel += modelOffset;
      posView += viewOffset;
    }
  `)),t.screenCenterOffsetUnitsEnabled&&(0,n.Nz)(r),t.hasScreenSizePerspective&&(0,s.OH)(r),r.code.add(c.H`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      vec3 centerOffset = centerOffsetAndDistance.xyz;
      float pointGroundDistance = centerOffsetAndDistance.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.hasScreenSizePerspective&&(t.hasVerticalOffset||t.screenCenterOffsetUnitsEnabled)?"vec3 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.hasVerticalOffset?t.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.hasVerticalOffset?c.H`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${t.screenCenterOffsetUnitsEnabled?"":c.H`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${t.screenCenterOffsetUnitsEnabled?t.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${t.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `)}},63578:(e,t,r)=>{r.d(t,{I:()=>a});var i=r(47522),s=r(96598),n=r(31821);function a(e,t){const{vertex:r,fragment:a}=e;e.include(s.Z,t),r.include(i.K),r.main.add(n.H`vec4 posProjCenter;
if (dot(position, position) > 0.0) {
ProjectHUDAux projectAux;
vec4 posProj = projectPositionHUD(projectAux);
posProjCenter = alignToPixelCenter(posProj, viewport.zw);
forwardViewPosDepth(projectAux.posView);
vec3 vpos = projectAux.posModel;
if (rejectBySlice(vpos)) {
posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
}
} else {
posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
}
gl_Position = posProjCenter;
gl_PointSize = 1.0;`),a.main.add(n.H`fragColor = vec4(1);
if(discardByTerrainDepth()) {
fragColor.g = 0.5;
}`)}},13755:(e,t,r)=>{r.d(t,{y:()=>c});var i,s=r(47522);!function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"}(i||(i={}));var n=r(14314),a=r(33094),o=r(31821),l=r(12791);function c(e){e.vertex.uniforms.add(new a.U("renderTransparentlyOccludedHUD",(e=>e.hudRenderStyle===i.Occluded?1:e.hudRenderStyle===i.NotOccluded?0:.75)),new n.I("viewport",(e=>e.camera.fullViewport)),new l.x("hudVisibilityTexture",(e=>e.hudVisibility?.getTexture()))),e.vertex.include(s.K),e.vertex.code.add(o.H`bool testHUDVisibility(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}},62258:(e,t,r)=>{var i,s;r.d(t,{dz:()=>i,oH:()=>s}),function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL",e[e.TILES3D=8]="TILES3D"}(i||(i={})),function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"}(s||(s={}))},65215:(e,t,r)=>{r.d(t,{HE:()=>i,R6:()=>s}),r(51850);class i{constructor(e){this.layerUid=e}}class s extends i{constructor(e,t){super(e),this.graphicUid=t}}},78230:(e,t,r)=>{r.d(t,{A:()=>f});var i,s,n=r(93687),a=r(3694),o=r(38954),l=r(51850),c=r(82919),h=r(71351),d=r(97937),u=r(620);class f{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new p,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),p.clearPool(),C[0]=null,L.prune(),j.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const r=p.acquire();for(let i=0;i<t;i++){const t=e[i];this._isDegenerate(t)?this._degenerateObjects.add(t):(r.init(this._root),this._add(t,r))}p.release(r)}remove(e,t=null){this._objectCount-=e.length;const r=p.acquire();for(const i of e){const e=t??(0,d.e)(this.objectToBoundingSphere(i),N);R(e[3])?(r.init(this._root),g(i,e,r)):this._degenerateObjects.delete(i)}p.release(r),this._shrink()}update(e,t){if(!R(t[3])&&this._isDegenerate(e))return;const r=function(e){return C[0]=e,C}(e);this.remove(r,t),this.add(r)}forEachAlongRay(e,t,r){const i=(0,h.LV)(e,t);_(this._root,(e=>{if(!function(e,t){return w((0,d.a)(t.bounds),2*-t.halfSize,D),w((0,d.a)(t.bounds),2*t.halfSize,P),(0,u.O_)(e.origin,e.direction,D,P)}(i,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(i,e)&&r(e)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,r,i){const s=(0,h.LV)(e,t);_(this._root,(e=>{if(!function(e,t,r){return w((0,d.a)(t.bounds),2*-t.halfSize,D),w((0,d.a)(t.bounds),2*t.halfSize,P),r.applyToMinMax(D,P),(0,u.O_)(e.origin,e.direction,D,P)}(s,e,i))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(s,e,i)&&r(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(s,e,i)&&r(e)})),!0}))}forEach(e){_(this._root,(t=>{const r=t.node;return r.terminals.forAll(e),null!==r.residents&&r.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,r,i=()=>!0,s=1/0){let n=1/0,a=1/0,l=null;const h=A(e,t),u=o=>{if(--s,!i(o))return;const h=this.objectToBoundingSphere(o);if(!(0,c.m7)(r,h))return;const u=S(e,t,(0,d.a)(h)),f=u-h[3],p=u+h[3];f<n&&(n=f,a=p,l=o)};return m(this._root,(i=>{if(s<=0||!(0,c.m7)(r,i.bounds))return!1;if((0,o.h)(F,h,i.halfSize),(0,o.g)(F,F,(0,d.a)(i.bounds)),S(e,t,F)>a)return!1;const n=i.node;return n.terminals.forAll((e=>u(e))),null!==n.residents&&n.residents.forAll((e=>u(e))),!0}),e,t),l}forEachInDepthRange(e,t,r,i,s,n,a){let l=-1/0,h=1/0;const u={setRange:e=>{r===f.DepthOrder.FRONT_TO_BACK?(l=Math.max(l,e.near),h=Math.min(h,e.far)):(l=Math.max(l,-e.far),h=Math.min(h,-e.near))}};u.setRange(i);const p=S(t,r,e),_=A(t,r),g=A(t,-r),y=e=>{if(!a(e))return;const i=this.objectToBoundingSphere(e),o=(0,d.a)(i),f=S(t,r,o)-p,_=f-i[3],m=f+i[3];_>h||m<l||!(0,c.m7)(n,i)||s(e,u)};m(this._root,(e=>{if(!(0,c.m7)(n,e.bounds))return!1;if((0,o.h)(F,_,e.halfSize),(0,o.g)(F,F,(0,d.a)(e.bounds)),S(t,r,F)-p>h)return!1;if((0,o.h)(F,g,e.halfSize),(0,o.g)(F,F,(0,d.a)(e.bounds)),S(t,r,F)-p<l)return!1;const i=e.node;return i.terminals.forAll((e=>y(e))),null!==i.residents&&i.residents.forAll((e=>y(e))),!0}),t,r)}forEachNode(e){_(this._root,(t=>e(t.node,t.bounds,t.halfSize,t.depth)))}forEachNeighbor(e,t){const r=(0,d.g)(t),i=(0,d.a)(t),s=t=>{const s=this.objectToBoundingSphere(t),n=(0,d.g)(s),a=r+n;return!((0,o.s)((0,d.a)(s),i)-a*a<=0)||e(t)};let n=!0;const a=e=>{n&&(n=s(e))};_(this._root,(e=>{const t=(0,d.g)(e.bounds),s=r+t;if((0,o.s)((0,d.a)(e.bounds),i)-s*s>0)return!1;const l=e.node;return l.terminals.forAll(a),n&&null!==l.residents&&l.residents.forAll(a),n})),n&&this.forEachDegenerateObject(a)}_intersectsObject(e,t){const r=this.objectToBoundingSphere(t);return!(r[3]>0)||(0,d.i)(r,e)}_intersectsObjectWithOffset(e,t,r){const i=this.objectToBoundingSphere(t);return!(i[3]>0)||(0,d.i)(r.applyToBoundingSphere(i),e)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let r=0;r<t.length;r++){const i=p.acquire().init(e);this._add(t.at(r),i),p.release(i)}}_grow(e,t){if(0!==t&&(T(e,t,(e=>this.objectToBoundingSphere(e)),z),R(z[3])&&!this._fitsInsideTree(z)))if(v(this._root.node))(0,d.e)(z,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const e=this._rootBoundsForRootAsSubNode(z);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(z,e):this._growRootAsSubNode(e),p.release(e)}}_rebuildTree(e,t){(0,o.c)((0,d.a)(B),(0,d.a)(t.bounds)),B[3]=t.halfSize,T([e,B],2,(e=>e),V);const r=p.acquire().init(this._root);this._root.initFrom(null,V,V[3]),this._root.increaseHalfSize(1.25),_(r,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),p.release(r)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return _(this._root,(e=>(r=Math.max(r,e.depth),r+t<=this._maximumDepth))),r+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],r=e;let i=-1/0;const s=this._root.bounds,n=this._root.halfSize;for(let e=0;e<3;e++){const a=s[e]-n-(r[e]-t),o=r[e]+t-(s[e]+n),l=Math.max(0,Math.ceil(a/(2*n))),c=Math.max(0,Math.ceil(o/(2*n)))+1,h=2**Math.ceil(Math.log(l+c)*Math.LOG2E);i=Math.max(i,h),H[e].min=l,H[e].max=c}for(let e=0;e<3;e++){let t=H[e].min,r=H[e].max;const a=(i-(t+r))/2;t+=Math.ceil(a),r+=Math.floor(a);const o=s[e]-n-t*n*2;E[e]=o+(r+t)*n}const a=i*n;return E[3]=a*M,p.acquire().initFrom(null,E,a,0)}_growRootAsSubNode(e){const t=this._root.node;(0,o.c)((0,d.a)(z),(0,d.a)(this._root.bounds)),z[3]=this._root.halfSize,this._root.init(e),e.advanceTo(z,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let r=0,i=0;for(;i<t.length&&null==e;)r=i++,e=t[r];for(;i<t.length;)if(t[i++])return-1;return r}_isDegenerate(e){return!R(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,r=this._root.halfSize;return e[3]<=r&&e[0]>=t[0]-r&&e[0]<=t[0]+r&&e[1]>=t[1]-r&&e[1]<=t[1]+r&&e[2]>=t[2]-r&&e[2]<=t[2]+r}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:r}=this,i=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:r,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:i}}}_nodeToJSON(e){const t=e.children.map((e=>e?this._nodeToJSON(e):null)),r=e.residents?.map((e=>this.objectToBoundingSphere(e))),i=e.terminals?.map((e=>this.objectToBoundingSphere(e)));return{children:t,residents:r,terminals:i}}static fromJSON(e){const t=new f((e=>e),{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}}class p{constructor(){this.bounds=(0,d.c)(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,r,i=this.depth){return this.node=null!=e?e:p.createEmptyNode(),t&&(0,d.e)(t,this.bounds),this.halfSize=r,this.depth=i,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*M}advance(e){let t=this.node.children[e];t||(t=p.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const r=O[e];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,r=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!r)return t&&t(this,-1),!1;this.node.residents=null}const i=this._childIndex(e);t&&t(this,i),this.advance(i)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new a.A({shrink:!0}),residents:new a.A({shrink:!0})}}static acquire(){return p._pool.acquire()}static release(e){p._pool.release(e)}static clearPool(){p._pool.prune()}}function _(e,t){let r=p.acquire().init(e);const i=[r];for(;0!==i.length;){if(r=i.pop(),t(r)&&!r.isLeaf())for(let e=0;e<r.node.children.length;e++)r.node.children[e]&&i.push(p.acquire().init(r).advance(e));p.release(r)}}function m(e,t,r,i=f.DepthOrder.FRONT_TO_BACK){let s=p.acquire().init(e);const n=[s];for(function(e,t,r){if(!j.length)for(let e=0;e<8;++e)j.push({index:0,distance:0});for(let r=0;r<8;++r){const i=O[r];j.data[r].index=r,j.data[r].distance=S(e,t,i)}j.sort(((e,t)=>e.distance-t.distance));for(let e=0;e<8;++e)r[e]=j.data[e].index}(r,i,U);0!==n.length;){if(s=n.pop(),t(s)&&!s.isLeaf())for(let e=7;e>=0;--e){const t=U[e];s.node.children[t]&&n.push(p.acquire().init(s).advance(t))}p.release(s)}}function g(e,t,r){L.clear();const i=r.advanceTo(t,((e,t)=>{L.push(e.node),L.push(t)}))?r.node.terminals:r.node.residents;if(i.removeUnordered(e),0===i.length)for(let e=L.length-2;e>=0&&y(L.data[e],L.data[e+1]);e-=2);}function y(e,t){return t>=0&&(e.children[t]=null),!!v(e)&&(null===e.residents&&(e.residents=new a.A({shrink:!0})),!0)}function v(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}function x(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function b(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function w(e,t,r){r[0]=e[0]+t,r[1]=e[1]+t,r[2]=e[2]+t}function T(e,t,r,i){if(1===t){const t=r(e[0]);(0,d.e)(t,i)}else{D[0]=1/0,D[1]=1/0,D[2]=1/0,P[0]=-1/0,P[1]=-1/0,P[2]=-1/0;for(let i=0;i<t;i++){const t=r(e[i]);R(t[3])&&(x(D,t),b(P,t))}(0,o.m)((0,d.a)(i),D,P,.5),i[3]=Math.max(P[0]-D[0],P[1]-D[1],P[2]-D[2])/2}}function A(e,t){let r,i=1/0;for(let s=0;s<8;++s){const n=S(e,t,I[s]);n<i&&(i=n,r=I[s])}return r}function S(e,t,r){return t*(e[0]*r[0]+e[1]*r[1]+e[2]*r[2])}function R(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}p._pool=new n.A(p),(s=(i=f).DepthOrder||(i.DepthOrder={}))[s.FRONT_TO_BACK=1]="FRONT_TO_BACK",s[s.BACK_TO_FRONT=-1]="BACK_TO_FRONT";const O=[(0,l.fA)(-1,-1,-1),(0,l.fA)(1,-1,-1),(0,l.fA)(-1,1,-1),(0,l.fA)(1,1,-1),(0,l.fA)(-1,-1,1),(0,l.fA)(1,-1,1),(0,l.fA)(-1,1,1),(0,l.fA)(1,1,1)],I=[(0,l.fA)(-1,-1,-1),(0,l.fA)(-1,-1,1),(0,l.fA)(-1,1,-1),(0,l.fA)(-1,1,1),(0,l.fA)(1,-1,-1),(0,l.fA)(1,-1,1),(0,l.fA)(1,1,-1),(0,l.fA)(1,1,1)],M=Math.sqrt(3),C=[null],E=(0,d.c)(),F=(0,l.vt)(),D=(0,l.vt)(),P=(0,l.vt)(),L=new a.A,N=(0,d.c)(),z=(0,d.c)(),B=(0,d.c)(),V=(0,d.c)(),H=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],j=new a.A,U=[0,0,0,0,0,0,0,0]},86305:(e,t,r)=>{r.d(t,{i3:()=>s}),r(38954);var i=r(51850);function s(e){return null!=e?.dist}r(17352),r(62258),(0,i.vt)()},87582:(e,t,r)=>{r.d(t,{h:()=>s}),r(62258);var i=r(65215);r(86305);class s extends i.R6{constructor(e,t,r,i,s){super(e,t),this.layerUid=e,this.graphicUid=t,this.triangleNr=r,this.baseBoundingSphere=i,this.numLodLevels=s}}},48852:(e,t,r)=>{r.d(t,{g:()=>c});var i=r(4576),s=(r(44208),r(53966)),n=r(34275),a=r(94656),o=r(63907);const l=()=>s.A.getLogger("esri.views.webgl.BufferObject");class c{static createIndex(e,t,r){return new c(e,o.NZ.ELEMENT_ARRAY_BUFFER,t,r)}static createVertex(e,t,r){return new c(e,o.NZ.ARRAY_BUFFER,t,r)}static createUniform(e,t,r){return new c(e,o.NZ.UNIFORM_BUFFER,t,r)}static createPixelPack(e,t=o._U.STREAM_READ,r){const i=new c(e,o.NZ.PIXEL_PACK_BUFFER,t);return r&&i.setSize(r),i}static createPixelUnpack(e,t=o._U.STREAM_DRAW,r){return new c(e,o.NZ.PIXEL_UNPACK_BUFFER,t,r)}static createTransformFeedback(e,t=o._U.STATIC_DRAW,r){const i=new c(e,o.NZ.TRANSFORM_FEEDBACK_BUFFER,t);return i.setSize(r),i}constructor(e,t,r,i){this._context=e,this.bufferType=t,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(o.vt.BufferObject,this),this._glName=this._context.gl.createBuffer(),(0,a.Y2)(this._context.gl),i&&this.setData(i)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get usedMemory(){if(this.bufferType===o.NZ.ELEMENT_ARRAY_BUFFER){if(this._indexType===o.pe.UNSIGNED_INT)return 4*this._size;if(this._indexType===o.pe.UNSIGNED_SHORT)return 2*this._size}return this._size}get _isVAOAware(){return this.bufferType===o.NZ.ELEMENT_ARRAY_BUFFER||this.bufferType===o.NZ.ARRAY_BUFFER}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(o.vt.BufferObject,this),this._context=null):this._glName&&l().warn("Leaked WebGL buffer object")}setSize(e,t=null){if(this.bufferType===o.NZ.ELEMENT_ARRAY_BUFFER&&null!=t)switch(this._indexType=t,t){case o.pe.UNSIGNED_SHORT:e*=2;break;case o.pe.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let t=e.byteLength;this.bufferType===o.NZ.ELEMENT_ARRAY_BUFFER&&((0,n.mg)(e)?this._indexType=o.pe.UNSIGNED_BYTE:(0,n.jq)(e)?(t/=2,this._indexType=o.pe.UNSIGNED_SHORT):(0,n.XJ)(e)&&(t/=4,this._indexType=o.pe.UNSIGNED_INT)),this._setBufferData(t,e)}_setBufferData(e,t=null){this._size=e;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const i=this._context.gl;null!=t?i.bufferData(this.bufferType,t,this.usage):i.bufferData(this.bufferType,e,this.usage),(0,a.Y2)(i),this._isVAOAware&&this._context.bindVAO(r)}setSubData(e,t,r,i){if(!e)return;const s=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const{gl:n}=this._context;n.bufferSubData(this.bufferType,t*e.BYTES_PER_ELEMENT,e,r,i-r),(0,a.Y2)(n),this._isVAOAware&&this._context.bindVAO(s)}getSubData(e,t=0,r,s){if(r<0||s<0)return;const n=function(e){return(0,i.Xj)(e)}(e)?e.BYTES_PER_ELEMENT:1;if(n*((r??0)+(s??0))>e.byteLength)return;t+n*(s??0)>this.usedMemory&&l().warn("Potential problem getting subdata: requested data exceeds buffer size!");const a=this._context.gl;this.bufferType===o.NZ.TRANSFORM_FEEDBACK_BUFFER?(this._context.bindBuffer(this,o.NZ.TRANSFORM_FEEDBACK_BUFFER),a.getBufferSubData(o.NZ.TRANSFORM_FEEDBACK_BUFFER,t,e,r,s),this._context.unbindBuffer(o.NZ.TRANSFORM_FEEDBACK_BUFFER)):(this._context.bindBuffer(this,o.NZ.COPY_READ_BUFFER),a.getBufferSubData(o.NZ.COPY_READ_BUFFER,t,e,r,s),this._context.unbindBuffer(o.NZ.COPY_READ_BUFFER))}async getSubDataAsync(e,t=0,r,i){await this._context.clientWaitAsync(),this.getSubData(e,t,r,i)}}},74038:(e,t,r)=>{r.d(t,{_:()=>i});class i{constructor(e,t,r,i,s,n=!1,a=0){this.name=e,this.count=t,this.type=r,this.offset=i,this.stride=s,this.normalized=n,this.divisor=a}}}}]);