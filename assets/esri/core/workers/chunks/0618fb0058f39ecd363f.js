"use strict";(self.webpackChunkRemoteClient=self.webpackChunkRemoteClient||[]).push([[6946],{36946:(e,t,s)=>{s.d(t,{uploadAssets:()=>h});var a=s(3172),r=s(20102),o=s(92604),n=s(95330),i=s(81271),l=s(41123),u=s(84470),p=s(66677);const c=1e6,d=20*c,f=2e9,y=3;async function m({data:e,name:t,description:s},r,o){let l=null;try{const u=(0,i.v_)(r,"uploads"),m=(0,i.v_)(u,"info"),{data:w}=await(0,a.default)(m,{query:{f:"json"},responseType:"json"});(0,n.k_)(o);const h=(0,p.M8)(r),g=w.maxUploadFileSize*c,T=h?f:g,b=h?Math.min(d,g):d;if(e.size>T)throw new Error("Data too large");const _=(0,i.v_)(u,"register"),{data:$}=await(0,a.default)(_,{query:{f:"json",itemName:t,description:s},responseType:"json",method:"post"});if((0,n.k_)(o),!$.success)throw new Error("Registration failed");const{itemID:v}=$.item;l=(0,i.v_)(u,v);const E=(0,i.v_)(l,"uploadPart"),F=Math.ceil(e.size/b),k=new Array;for(let t=0;t<F;++t)k.push(e.slice(t*b,Math.min((t+1)*b,e.size)));const j=k.slice().reverse(),N=new Array,D=async()=>{for(;0!==j.length;){const e=k.length-j.length,t=j.pop(),s=new FormData;s.append("f","json"),s.append("file",t),s.append("partId",`${e}`);const{data:r}=await(0,a.default)(E,{timeout:0,body:s,responseType:"json",method:"post"});if((0,n.k_)(o),!r.success)throw new Error("Part upload failed")}};for(let e=0;e<y&&0!==j.length;++e)N.push(D());await Promise.all(N);const S=(0,i.v_)(l,"commit"),{data:U}=await(0,a.default)(S,{query:{f:"json",parts:k.map(((e,t)=>t)).join(",")},responseType:"json",method:"post"});if((0,n.k_)(o),!U.success)throw new Error("Commit failed");return U.item}catch(e){if(null!=l){const e=(0,i.v_)(l,"delete");await(0,a.default)(e,{query:{f:"json"},responseType:"json",method:"post"})}throw e}}var w=s(2981);async function h(e,t,s){return e.length?Promise.all(e.map((e=>async function(e,{layer:t,ongoingUploads:s},a){const o=s.get(e);if(o)return o;if(!function(e){return!!e.infoFor3D&&!!e.url}(t))throw new r.Z(`${t.type}-layer:upload-failure`,"Layer does not support asset uploads.",new Error);if(function(e,t){const{parsedUrl:s}=t;return null!=s&&e.metadata.externalSources.some((e=>(0,u.JG)(e,s)))}(e,t))return e;const i=async function(e,t,s){const{metadata:a}=e,{displaySource:o}=a,i=g(o?.source,t),u=!!i,p=a.externalSources.length>0,c=u?async function(e,t,s){return{source:await b(e,t,s),original:!0}}(i,t,s):p?async function(e,t,s){const a=v(t),{externalSources:o}=e.metadata,n=function(e,t){for(const s of e){const e=g(s.source,t);if(e)return e}return null}(o,t);if(!n)throw new r.Z(`${t.type}-layer:upload-failure`,"Could not find an external source that is supported by the service.",new Error);const i=await b(n,t,s);return e.addExternalSources([{source:i,original:!0}]),{source:await $(i,t,a)}}(e,t,s):async function(e,t,s){const a=async function(e,t,s){const a=v(t),r=await e.load(s),o=await r.toBinaryGLTF({ignoreLocalTransform:!0});(0,n.k_)(s);const i=await o.buffer();return(0,n.k_)(s),{blob:new Blob([i.data],{type:i.type}),assetName:`${(0,l.z)()}.glb`,assetType:a}}(e,t,s);return{source:await _([a],t,s),extent:e.extent.clone(),original:!0}}(e,t,s),d=await c;return(0,n.k_)(s),e.addExternalSources([d]),e}(e,t,a);s.set(e,i);try{await i}finally{s.delete(e)}return e}(e,t,s)))):[]}function g(e,t){if(!e)return null;const{infoFor3D:{supportedFormats:s,editFormats:a}}=t,r=(0,u.zE)(e),o=new Array;let n=!1;for(let e=0;e<r.length;++e){const t=T(r[e],s);if(!t)return null;a.includes(t.assetType)&&(n=!0),o.push(t)}return n?o:null}function T(e,t){const s=(0,u.vj)(e,t);return s?{asset:e,assetType:s}:null}async function b(e,t,s){return _(e.map((e=>async function(e,t){const{asset:s,assetType:a}=e;if(s instanceof File)return{blob:s,assetName:s.name,assetType:a};const r=await s.toBlob(t);return(0,n.k_)(t),{blob:r,assetName:s.assetName,assetType:a}}(e,s))),t,s)}async function _(e,t,s){const l=await Promise.all(e.map((async e=>{const a=async function(e,t,s){const{blob:a,assetType:l,assetName:u}=e;let p=null;try{const e=await m({data:a,name:u},t.url,s);(0,n.k_)(s),p={assetType:l,assetUploadId:e.itemID}}catch(e){(0,n.r9)(e),o.Z.getLogger("esri.layers.graphics.sources.support.uploadAssets").warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!p){const e=await(0,i.IR)(a);if((0,n.k_)(s),!e.isBase64)throw new r.Z(`${t.type}-layer:uploadAssets-failure`,"Expected gltf data in base64 format after conversion.",new Error);p={assetType:l,assetData:e.data}}if(!p)throw new r.Z(`${t.type}-layer:uploadAssets-failure`,"Unable to prepare uploadAsset request options.",new Error);return{item:p,assetName:u}}(await e,t,s);return(0,n.k_)(s),a})));(0,n.k_)(s);const{uploadResults:p}=await async function(e,t,s){const o=await(0,a.default)((0,i.v_)(t.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(e)},method:"post",responseType:"json"});if((0,n.k_)(s),o.data.uploadResults.length!==e.length)throw new r.Z(`${t.type}-layer:uploadAssets-failure`,`Bad response. Uploaded ${e.length} items and received ${o.data.uploadResults.length} results.`,new Error);return o.data}(l.map((({item:e})=>e)),t,s);return(0,n.k_)(s),e.map(((e,s)=>function(e,t,s){const{success:a}=t;if(!a){const{error:a}=t;throw new r.Z(`${s.type}-layer:upload-failure`,`Failed to upload mesh file ${e.assetName}. Error code: ${a.code}. Error message: ${a.messages}`,new Error)}const{assetHash:o}=t,{assetName:n,item:{assetType:i}}=e,{infoFor3D:{supportedFormats:l}}=s,p=(0,w.d1)(i,l);if(!p)throw new r.Z(`${s.type}-layer:upload-failure`,`The service allowed us to upload an asset of FormatID ${i}, but it does not list it in its supported formats.`,new Error);return new u.CP(n,p,[new u.LL(`${s.parsedUrl.path}/assets/${o}`,o)])}(l[s],p[s],t)))}async function $(e,t,s){const o=e.map((({assetName:e,parts:t})=>({assetName:e,assetHash:t[0].partHash}))),n=(await(0,a.default)((0,i.v_)(t.parsedUrl.path,"convert3D"),{query:{f:"json",assets:JSON.stringify(o),transportType:"esriTransportTypeUrl",targetFormat:s},responseType:"json",timeout:0})).data,{infoFor3D:{supportedFormats:l}}=t;return n.assets.map((e=>{const s=(0,w.S0)(e.contentType,l);if(!s)throw new r.Z(`${t.type}-layer:upload-failure`,`The service allowed us to upload an asset of FormatID ${s}, but it does not list it in its supported formats.`,new Error);return new u.CP(e.assetName,e.contentType,[new u.LL(e.assetURL,e.assetHash)])}))}function v(e){const{infoFor3D:t}=e,s=(0,w.S0)("model/gltf-binary",t.supportedFormats)??(0,w.Ow)("glb",t.supportedFormats);if(!s)throw new r.Z(`${e.type}-layer:upload-failure`,"Layer does not support glb.",new Error);return s}}}]);