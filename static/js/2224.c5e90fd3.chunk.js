"use strict";(globalThis.webpackChunkmy_app=globalThis.webpackChunkmy_app||[]).push([[2224],{15909:(e,t,r)=>{r.d(t,{D:()=>n});var a=r(80292);function n(e){e?.writtenProperties&&e.writtenProperties.forEach((e=>{let{target:t,propName:r,newOrigin:n}=e;(0,a.l)(t)&&n&&t.originOf(r)!==n&&t.updateOrigin(r,n)}))}},80292:(e,t,r)=>{function a(e){return e&&"getAtOrigin"in e&&"originOf"in e}r.d(t,{l:()=>a})},2224:(e,t,r)=>{r.r(t),r.d(t,{save:()=>A,saveAll:()=>K,saveAllAs:()=>k,saveAs:()=>R});var a=r(63780),n=r(10064),o=r(15909),i=r(64326),l=r(65286),s=r(25899),u=r(74368),p=r(37933),c=r(32698),d=r(73117);const y="Feature Service",f="feature-layer-utils",m=`${f}-save`,w=`${f}-save-as`,v=`${f}-saveall`,h=`${f}-saveall-as`;function b(e){return{isValid:(0,p.fP)(e)&&("feature"!==e.type||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function g(e){const t=[],r=[];for(const{layer:a,layerJSON:n}of e)a.isTable?r.push(n):t.push(n);return{layers:t,tables:r}}function I(e){return g([e])}async function P(e,t){return/\/\d+\/?$/.test(e.url)?I(t[0]):S(t,e)}async function S(e,t){if(!t)return e.reverse(),g(e);const{layer:{url:r,customParameters:a,apiKey:n}}=e[0];let o=await t.fetchData("json");null!=o?.layers&&null!=o?.tables||(o=await async function(e,t,r){e||={},e.layers||=[],e.tables||=[];const{url:a,customParameters:n,apiKey:o}=t,{serviceJSON:l,layersJSON:s}=await(0,u.V)(a,{customParameters:n,apiKey:o}),p=N(e.layers,l.layers,r),c=N(e.tables,l.tables,r);e.layers=p.itemResources,e.tables=c.itemResources;const d=[...p.added,...c.added],y=s?[...s.layers,...s.tables]:[];return await async function(e,t,r,a){const n=t.map((e=>{let{id:t}=e;return new i.default({url:r,layerId:t,sourceJSON:a.find((e=>{let{id:r}=e;return r===t}))})}));await Promise.allSettled(n.map((e=>e.load()))),n.forEach((t=>{const{layerId:r,loaded:a,defaultPopupTemplate:n}=t;a&&null!=n&&T(t,{id:r,popupInfo:n.toJSON()},e)}))}(e,d,a,y),e}(o,{url:r??"",customParameters:a,apiKey:n},e.map((e=>e.layer.layerId))));for(const i of e)T(i.layer,i.layerJSON,o);return o}function N(e,t,r){const n=(0,a.e5)(e,t,((e,t)=>e.id===t.id));e=e.filter((e=>!n.removed.some((t=>t.id===e.id))));const o=n.added.map((e=>{let{id:t}=e;return{id:t}}));return o.forEach((t=>{let{id:r}=t;e.push({id:r})})),{itemResources:e,added:o.filter((e=>{let{id:t}=e;return!r.includes(t)}))}}function T(e,t,r){e.isTable?$(r.tables,t):$(r.layers,t)}function $(e,t){const r=e.findIndex((e=>{let{id:r}=e;return r===t.id}));-1===r?e.push(t):e[r]=t}function O(e,t){if(!e.length)throw new n.Z(`${t}:missing-parameters`,"'layers' array should contain at least one feature layer")}function U(e,t){const r=e.map((e=>e.layerId));if(new Set(r).size!==r.length)throw new n.Z(`${t}:invalid-parameters`,"'layers' array should contain only one instance each of layer or table in a feature service")}async function Z(e){O(e,v),await Promise.all(e.map((e=>e.load())));for(const t of e)(0,l.DC)(t,v,b),(0,l.Ym)({layer:t,itemType:y,errorNamePrefix:v});(function(e,t){const r=e.map((e=>e.portalItem.id));if(new Set(r).size>1)throw new n.Z(`${t}:invalid-parameters`,"All layers in the 'layers' array should be loaded from the same portal item")})(e,v),U(e,v)}async function x(e,t){const{url:r,layerId:a,title:n,fullExtent:o,isTable:i}=e,l=(0,s.Qc)(r);t.url="FeatureServer"===l?.serverType?r:`${r}/${a}`,t.title||=n,t.extent=null,i||null==o||(t.extent=await(0,d.$o)(o)),(0,d.ck)(t,d.Kz.METADATA),(0,d.ck)(t,d.Kz.MULTI_LAYER),(0,d.qj)(t,d.Kz.SINGLE_LAYER),i&&(0,d.qj)(t,d.Kz.TABLE)}async function D(e){O(e,h),await Promise.all(e.map((e=>e.load())));for(const t of e)(0,l.DC)(t,h,b);(function(e,t){for(const a of e){const r=a.parsedUrl.path,o=(0,s.Qc)(r),i=o?.url.path;if(!i)throw new n.Z(`${t}:invalid-parameters`,(0,l.xG)(a,`has unsupported url pattern: ${r}`),{layer:a});const u=o?.serverType;if("FeatureServer"!==u&&"MapServer"!==u)throw new n.Z(`${t}:invalid-parameters`,(0,l.xG)(a,`has unsupported server type: ${u}`),{layer:a});if("MapServer"===u&&e.length>1)throw new n.Z(`${t}:invalid-parameters`,"Only one layer or table in a map service can be saved")}const r=(0,s.Qc)(e[0].parsedUrl.path)?.url.path;if(!e.every((e=>(0,s.Qc)(e.parsedUrl.path)?.url.path===r)))throw new n.Z(`${t}:invalid-parameters`,"'layers' array should only contain layers or tables that belong to the same feature service")})(e,h),U(e,h)}async function A(e,t){return(0,l.a1)({layer:e,itemType:y,validateLayer:b,createItemData:(e,t)=>P(t,[e]),errorNamePrefix:m},t)}async function K(e,t){await Z(e);const r=e[0].portalItem,a=(0,c.Yv)(r),n=await Promise.all(e.map((e=>(0,l.Nw)(e,a,t)))),i=await P(r,e.map(((e,t)=>({layer:e,layerJSON:n[t]}))));return(0,l.UY)(r),await r.update({data:i}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),(0,o.D)(a),r.clone()}async function R(e,t,r){return(0,l.po)({layer:e,itemType:y,validateLayer:b,createItemData:(e,t)=>Promise.resolve(I(e)),errorNamePrefix:w,newItem:t,setItemProperties:x},r)}async function k(e,t,r){await D(e);const n=(0,l.uT)({itemType:y,errorNamePrefix:h,newItem:t}),i=(0,c.Yv)(n),u=await Promise.all(e.map((e=>(0,l.Nw)(e,i,r)))),p=await S(e.map(((e,t)=>({layer:e,layerJSON:u[t]}))));await async function(e,t){let r=0,n=0;for(const{isTable:a}of t)a?n++:r++;const o=t[0].parsedUrl.path,i=(0,s.Qc)(o);if(e.url="FeatureServer"===i?.serverType?i.url.path:o,e.title||=i.title,e.extent=null,r>0){const r=t.map((e=>e.fullExtent)).filter(a.pC).reduce(((e,t)=>e.clone().union(t)));r&&(e.extent=await(0,d.$o)(r))}(0,d.ck)(e,d.Kz.METADATA),(0,d.Ct)(e,d.Kz.MULTI_LAYER,t.length>1),(0,d.Ct)(e,d.Kz.SINGLE_LAYER,1===t.length),(0,d.Ct)(e,d.Kz.TABLE,n>0&&0===r),(0,l.UY)(e)}(n,e),await(0,l.jX)(n,p,r);for(const a of e)a.portalItem=n.clone();return(0,o.D)(i),n}},65286:(e,t,r)=>{r.d(t,{DC:()=>p,Nw:()=>w,UY:()=>v,Ym:()=>f,a1:()=>b,jX:()=>h,po:()=>g,uT:()=>m,xG:()=>d});var a=r(10064),n=r(15909),o=r(7575),i=r(98995),l=r(32698),s=r(73117),u=r(81359);function p(e,t,r){const n=r(e);if(!n.isValid)throw new a.Z(`${t}:invalid-parameters`,n.errorMessage,{layer:e})}async function c(e){const{layer:t,errorNamePrefix:r,validateLayer:a}=e;await t.load(),p(t,r,a)}function d(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function y(e){const{item:t,itemType:r,errorNamePrefix:n,layer:o,validateItem:i}=e;if((0,u.w)(t),t.type!==r)throw new a.Z(`${n}:portal-item-wrong-type`,`Portal item type should be "${r}"`,{item:t,layer:o});if(i){const e=i(t);if(!e.isValid)throw new a.Z(`${n}:invalid-parameters`,e.errorMessage,{layer:o})}}function f(e){const{layer:t,errorNamePrefix:r}=e,{portalItem:n}=t;if(!n)throw new a.Z(`${r}:portal-item-not-set`,d(t,"requires the portalItem property to be set"));if(!n.loaded)throw new a.Z(`${r}:portal-item-not-loaded`,d(t,"cannot be saved to a portal item that does not exist or is inaccessible"));y({...e,item:n})}function m(e){const{newItem:t,itemType:r}=e;let a=i.default.from(t);return a.id&&(a=a.clone(),a.id=null),a.type??=r,a.portal??=o.Z.getDefault(),y({...e,item:a}),a}async function w(e,t,r){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const n=e.write({},t);return await Promise.all(t.resources?.pendingOperations??[]),function(e,t){let r=(e.messages??[]).filter((e=>{let{type:t}=e;return"error"===t})).map((e=>{let{name:t,message:r,details:n}=e;return new a.Z(t,r,n)}));if(e.blockedRelativeUrls&&(r=r.concat(e.blockedRelativeUrls.map((e=>new a.Z("url:unsupported",`Relative url '${e}' is not supported`))))),t?.ignoreUnsupported&&(r=r.filter((e=>{let{name:t}=e;return"layer:unsupported"!==t&&"symbol:unsupported"!==t&&"symbol-layer:unsupported"!==t&&"property:unsupported"!==t&&"url:unsupported"!==t}))),r.length>0)throw new a.Z("layer-write:unsupported","Failed to save layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})}(t,r),n}function v(e){(0,s.qj)(e,s.Kz.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}async function h(e,t,r){const a=e.portal;await a.signIn(),await(a.user?.addItem({item:e,data:t,folder:r?.folder}))}async function b(e,t){const{layer:r,createItemData:a,createJSONContext:o,saveResources:i}=e;await c(e),f(e);const s=r.portalItem,u=o?o(s):(0,l.Yv)(s),p=await w(r,u,t),d=await a({layer:r,layerJSON:p},s);return v(s),await s.update({data:d}),(0,n.D)(u),await(i?.(s,u)),s}async function g(e,t){const{layer:r,createItemData:a,createJSONContext:o,setItemProperties:i,saveResources:s}=e;await c(e);const u=m(e),p=o?o(u):(0,l.Yv)(u),d=await w(r,p,t),y=await a({layer:r,layerJSON:d},u);return await i(r,u),v(u),await h(u,y,t),r.portalItem=u,(0,n.D)(p),await(s?.(u,p)),u}},74368:(e,t,r)=>{r.d(t,{V:()=>n});var a=r(41226);async function n(e,t){const r=await(0,a.T)(e,t);r.layers=r.layers.filter(o);const n={serviceJSON:r};if((r.currentVersion??0)<10.5)return n;const i=await(0,a.T)(e+"/layers",t);return n.layersJSON={layers:i.layers.filter(o),tables:i.tables},n}function o(e){return!e.type||"Feature Layer"===e.type||"Oriented Imagery Layer"===e.type}},32698:(e,t,r)=>{r.d(t,{M4:()=>s,Yv:()=>i,ht:()=>o,wk:()=>l});var a=r(35995),n=r(7575);function o(e){return{origin:"portal-item",url:(0,a.mN)(e.itemUrl),portal:e.portal||n.Z.getDefault(),portalItem:e,readResourcePaths:[]}}function i(e){const t=(0,a.mN)(e.itemUrl);return{origin:"portal-item",messages:[],writtenProperties:[],url:t,portal:e.portal||n.Z.getDefault(),portalItem:e,verifyItemRelativeUrls:t?{rootPath:t.path,writtenUrls:[]}:null,blockedRelativeUrls:[]}}function l(e){return{origin:"web-map",url:(0,a.mN)(e.itemUrl),portal:e.portal||n.Z.getDefault(),portalItem:e,readResourcePaths:[]}}function s(e,t){const r=(0,a.mN)(e.itemUrl);return{origin:"web-map",messages:[],writtenProperties:[],url:r,portal:e.portal||n.Z.getDefault(),portalItem:e,initiator:t,verifyItemRelativeUrls:r?{rootPath:r.path,writtenUrls:[]}:null,blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}}},41226:(e,t,r)=>{r.d(t,{T:()=>n});var a=r(76200);async function n(e,t){const{data:r}=await(0,a.Z)(e,{responseType:"json",query:{f:"json",...t?.customParameters,token:t?.apiKey}});return r}},81359:(e,t,r)=>{r.d(t,{w:()=>i});var a=r(42265),n=r(10064),o=r(66660);function i(e){if(a.Z.apiKey&&(0,o.r)(e.portal.url))throw new n.Z("save-api-key-utils:api-key-not-supported",`Saving is not supported on ${e.portal.url} when using an api key`)}}}]);
//# sourceMappingURL=2224.c5e90fd3.chunk.js.map